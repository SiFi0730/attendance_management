<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="styles/common.css">
  <link rel="stylesheet" href="styles/components.css">
  <link rel="stylesheet" href="styles/layout.css">
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="dashboard.html" class="header-logo">å‹¤æ€ ç®¡ç†</a>
        <nav class="header-nav">
          <a href="dashboard.html" class="header-nav-link active">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
          <a href="pages/punch.html" class="header-nav-link">æ‰“åˆ»</a>
          <a href="pages/gantt.html" class="header-nav-link">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</a>
          <a href="pages/reports.html" class="header-nav-link">ãƒ¬ãƒãƒ¼ãƒˆ</a>
        </nav>
      </div>
      <div class="header-right">
        <a href="pages/requests.html" class="header-nav-link" style="position: relative;">
          ç”³è«‹
          <span class="badge badge-error" style="position: absolute; top: -8px; right: -8px; font-size: 10px; padding: 2px 6px;">3</span>
        </a>
        <button id="time-mode-button" onclick="showTimeModeModal()" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-sm);">ç¾å®Ÿæ™‚é–“</button>
        <button onclick="logout()" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-sm);">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <a href="pages/profile.html" class="header-user" style="text-decoration: none;">
          <div class="header-user-avatar"></div>
          <span class="header-user-name"></span>
        </a>
      </div>
    </div>
  </header>

  <!-- æ™‚é–“ãƒ¢ãƒ¼ãƒ‰è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="time-mode-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">æ™‚é–“ãƒ¢ãƒ¼ãƒ‰è¨­å®š</h2>
        <button class="modal-close" onclick="closeTimeModeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer; margin-bottom: var(--spacing-md);">
            <input type="radio" name="time-mode" id="time-mode-realtime" value="realtime" checked style="cursor: pointer;">
            <span>ç¾å®Ÿæ™‚é–“ã‚’æ¡ç”¨</span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer; margin-bottom: var(--spacing-md);">
            <input type="radio" name="time-mode" id="time-mode-virtual" value="virtual" style="cursor: pointer;">
            <span>ä»®æƒ³æ™‚é–“ã‚’æ¡ç”¨</span>
          </label>
        </div>
        
        <div id="virtual-time-settings" style="display: none; margin-top: var(--spacing-lg); padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-md);">
          <div class="form-group">
            <label for="virtual-date" class="form-label required">æ—¥ä»˜</label>
            <input type="date" id="virtual-date" class="form-input" required>
          </div>
          <div class="form-group">
            <label for="virtual-time" class="form-label required">æ™‚åˆ»</label>
            <input type="time" id="virtual-time" class="form-input" required>
          </div>
          <div class="form-help" style="color: var(--text-secondary); font-size: var(--font-size-sm);">
            æ³¨æ„: ä»®æƒ³æ™‚é–“ã¯éå»ã®æ™‚é–“ã«æˆ»ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
          </div>
        </div>
        
        <div style="margin-top: var(--spacing-xl); padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
          <button onclick="resetDatabase()" class="btn btn-sm btn-danger" style="width: 100%;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
          <div class="form-help" style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-top: var(--spacing-xs);">
            ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€ã‚¹ã‚­ãƒ¼ãƒã‚’å†é©ç”¨ã—ã¾ã™ã€‚æ™‚é–“ãƒ¢ãƒ¼ãƒ‰ã‚‚ç¾å®Ÿæ™‚é–“ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="saveTimeMode()" class="btn btn-primary">ä¿å­˜</button>
        <button onclick="closeTimeModeModal()" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li class="sidebar-menu-item">
        <a href="dashboard.html" class="sidebar-menu-link active">
          <span class="sidebar-menu-icon">ğŸ“Š</span>
          <span class="sidebar-menu-label">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="pages/punch.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">â°</span>
          <span class="sidebar-menu-label">æ‰“åˆ»</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="pages/gantt.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“…</span>
          <span class="sidebar-menu-label">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="pages/requests.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“</span>
          <span class="sidebar-menu-label">ç”³è«‹ãƒ»æ‰¿èª</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="pages/employees.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ‘¥</span>
          <span class="sidebar-menu-label">å¾“æ¥­å“¡ç®¡ç†</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="pages/company-settings.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">âš™ï¸</span>
          <span class="sidebar-menu-label">ä¼æ¥­è¨­å®š</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="pages/reports.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“ˆ</span>
          <span class="sidebar-menu-label">ãƒ¬ãƒãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="pages/payslip.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ’°</span>
          <span class="sidebar-menu-label">çµ¦ä¸æ˜ç´°</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="pages/audit-logs.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ”</span>
          <span class="sidebar-menu-label">ç›£æŸ»ãƒ­ã‚°</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-content">
    <div class="page-header">
      <h1 class="page-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <p class="page-description">ä»Šæ—¥ã®å‹¤æ€ çŠ¶æ³ã¨çµ±è¨ˆæƒ…å ±ã‚’ç¢ºèªã§ãã¾ã™</p>
    </div>

    <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
    <div class="grid grid-cols-4" style="margin-bottom: var(--spacing-xl);">
      <div class="stats-card">
        <div class="stats-card-label">ä»Šæ—¥ã®å‡ºå‹¤è€…æ•°</div>
        <div class="stats-card-value" id="stat-today-attendance">-</div>
        <div class="stats-card-change" id="stat-attendance-diff">
          <span>-</span>
        </div>
      </div>
      <div class="stats-card">
        <div class="stats-card-label">æœªæ‰“åˆ»è€…æ•°</div>
        <div class="stats-card-value" id="stat-no-punch">-</div>
        <div class="stats-card-change" id="stat-no-punch-diff">
          <span>-</span>
        </div>
      </div>
      <div class="stats-card">
        <div class="stats-card-label">æ‰¿èªå¾…ã¡ç”³è«‹</div>
        <div class="stats-card-value" id="stat-pending-requests">-</div>
        <div class="stats-card-change">
          <span>â†’</span>
          <span>æ‰¿èªå¾…ã¡</span>
        </div>
      </div>
      <div class="stats-card">
        <div class="stats-card-label">ä»Šæœˆã®å¹³å‡åŠ´åƒæ™‚é–“</div>
        <div class="stats-card-value" id="stat-avg-work-hours">-</div>
        <div class="stats-card-change positive">
          <span>â†‘</span>
          <span>ä»Šæœˆã®å¹³å‡</span>
        </div>
      </div>
    </div>

    <!-- ä»Šæ—¥ã®æ‰“åˆ»çŠ¶æ³ -->
    <div class="card" style="margin-bottom: var(--spacing-xl);">
      <div class="card-header">
        <h2 class="card-title">ä»Šæ—¥ã®æ‰“åˆ»çŠ¶æ³</h2>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>å¾“æ¥­å“¡å</th>
                <th>éƒ¨ç½²</th>
                <th>å‡ºå‹¤æ™‚åˆ»</th>
                <th>é€€å‹¤æ™‚åˆ»</th>
                <th>å®Ÿåƒæ™‚é–“</th>
                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              </tr>
            </thead>
            <tbody id="today-punches-tbody">
              <tr>
                <td colspan="6" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">
                  ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- æ‰¿èªå¾…ã¡ç”³è«‹ -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">æ‰¿èªå¾…ã¡ç”³è«‹</h2>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>ç”³è«‹è€…</th>
                <th>ç”³è«‹ç¨®é¡</th>
                <th>å¯¾è±¡æ—¥</th>
                <th>ç”³è«‹å†…å®¹</th>
                <th>ç”³è«‹æ—¥æ™‚</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="pending-requests-tbody">
              <tr>
                <td colspan="6" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">
                  ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
  <script src="scripts/common.js"></script>
  <script>
    // ============================================
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - APIé€£æº
    // ============================================

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      updateHeaderUserInfo();
      await Promise.all([
        loadDashboardStats(),
        loadTodayPunches(),
        loadPendingRequests()
      ]);
    });

    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆã‚’èª­ã¿è¾¼ã¿
    async function loadDashboardStats() {
      try {
        const response = await apiFetch(`${API_BASE_URL}/dashboard/stats`);
        const data = await response.json();

        if (response.ok && data.success) {
          const stats = data.data;
          
          // ä»Šæ—¥ã®å‡ºå‹¤è€…æ•°
          document.getElementById('stat-today-attendance').textContent = stats.today_attendance || 0;
          const attendanceDiffEl = document.getElementById('stat-attendance-diff');
          if (stats.attendance_diff > 0) {
            attendanceDiffEl.className = 'stats-card-change positive';
            attendanceDiffEl.innerHTML = `<span>â†‘</span><span>å‰æ—¥æ¯” +${stats.attendance_diff}</span>`;
          } else if (stats.attendance_diff < 0) {
            attendanceDiffEl.className = 'stats-card-change negative';
            attendanceDiffEl.innerHTML = `<span>â†“</span><span>å‰æ—¥æ¯” ${stats.attendance_diff}</span>`;
          } else {
            attendanceDiffEl.className = 'stats-card-change';
            attendanceDiffEl.innerHTML = `<span>â†’</span><span>å‰æ—¥æ¯” Â±0</span>`;
          }

          // æœªæ‰“åˆ»è€…æ•°
          document.getElementById('stat-no-punch').textContent = stats.no_punch_count || 0;
          const noPunchDiffEl = document.getElementById('stat-no-punch-diff');
          if (stats.no_punch_diff > 0) {
            noPunchDiffEl.className = 'stats-card-change negative';
            noPunchDiffEl.innerHTML = `<span>â†‘</span><span>å‰æ—¥æ¯” +${stats.no_punch_diff}</span>`;
          } else if (stats.no_punch_diff < 0) {
            noPunchDiffEl.className = 'stats-card-change positive';
            noPunchDiffEl.innerHTML = `<span>â†“</span><span>å‰æ—¥æ¯” ${stats.no_punch_diff}</span>`;
          } else {
            noPunchDiffEl.className = 'stats-card-change';
            noPunchDiffEl.innerHTML = `<span>â†’</span><span>å‰æ—¥æ¯” Â±0</span>`;
          }

          // æ‰¿èªå¾…ã¡ç”³è«‹
          document.getElementById('stat-pending-requests').textContent = stats.pending_requests || 0;
          
          // ä»Šæœˆã®å¹³å‡åŠ´åƒæ™‚é–“
          document.getElementById('stat-avg-work-hours').textContent = `${stats.avg_work_hours || 0}h`;

          // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç”³è«‹ãƒãƒƒã‚¸ã‚’æ›´æ–°
          const requestBadge = document.querySelector('.header-nav-link[href="pages/requests.html"] .badge');
          if (requestBadge) {
            if (stats.pending_requests > 0) {
              requestBadge.textContent = stats.pending_requests;
              requestBadge.style.display = 'inline-block';
            } else {
              requestBadge.style.display = 'none';
            }
          }
        } else {
          console.error('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', data);
        }
      } catch (error) {
        console.error('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ä»Šæ—¥ã®æ‰“åˆ»çŠ¶æ³ã‚’èª­ã¿è¾¼ã¿
    async function loadTodayPunches() {
      try {
        const response = await apiFetch(`${API_BASE_URL}/dashboard/today-punches`);
        const data = await response.json();

        if (response.ok && data.success) {
          const punches = data.data || [];
          renderTodayPunches(punches);
        } else {
          console.error('ä»Šæ—¥ã®æ‰“åˆ»çŠ¶æ³å–å¾—ã‚¨ãƒ©ãƒ¼:', data);
          const tbody = document.getElementById('today-punches-tbody');
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
          }
        }
      } catch (error) {
        console.error('ä»Šæ—¥ã®æ‰“åˆ»çŠ¶æ³ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        const tbody = document.getElementById('today-punches-tbody');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
        }
      }
    }

    // ä»Šæ—¥ã®æ‰“åˆ»çŠ¶æ³ã‚’æç”»
    function renderTodayPunches(punches) {
      const tbody = document.getElementById('today-punches-tbody');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (punches.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">æ‰“åˆ»ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }

      punches.forEach(punch => {
        const row = document.createElement('tr');
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
        let statusBadge = '';
        if (punch.status === 'æ­£å¸¸') {
          statusBadge = '<span class="badge badge-success">æ­£å¸¸</span>';
        } else if (punch.status === 'é€€å‹¤æœªæ‰“åˆ»') {
          statusBadge = '<span class="badge badge-warning">é€€å‹¤æœªæ‰“åˆ»</span>';
        } else {
          statusBadge = '<span class="badge badge-error">æœªæ‰“åˆ»</span>';
        }

        row.innerHTML = `
          <td>${punch.employee_name}</td>
          <td>${punch.department_name || '-'}</td>
          <td>${punch.clock_in || '-'}</td>
          <td>${punch.clock_out || '-'}</td>
          <td>${punch.work_hours ? punch.work_hours + 'h' : '-'}</td>
          <td>${statusBadge}</td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // æ‰¿èªå¾…ã¡ç”³è«‹ã‚’èª­ã¿è¾¼ã¿
    async function loadPendingRequests() {
      try {
        const response = await apiFetch(`${API_BASE_URL}/dashboard/pending-requests?limit=10`);
        const data = await response.json();

        if (response.ok && data.success) {
          const requests = data.data || [];
          renderPendingRequests(requests);
        } else {
          console.error('æ‰¿èªå¾…ã¡ç”³è«‹å–å¾—ã‚¨ãƒ©ãƒ¼:', data);
          const tbody = document.getElementById('pending-requests-tbody');
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
          }
        }
      } catch (error) {
        console.error('æ‰¿èªå¾…ã¡ç”³è«‹ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        const tbody = document.getElementById('pending-requests-tbody');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
        }
      }
    }

    // æ‰¿èªå¾…ã¡ç”³è«‹ã‚’æç”»
    function renderPendingRequests(requests) {
      const tbody = document.getElementById('pending-requests-tbody');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (requests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">æ‰¿èªå¾…ã¡ã®ç”³è«‹ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }

      requests.forEach(request => {
        const row = document.createElement('tr');
        
        const createdAt = new Date(request.created_at);
        const createdAtStr = createdAt.toLocaleString('ja-JP');

        row.innerHTML = `
          <td>${request.employee_name}</td>
          <td>${request.type_label}</td>
          <td>${request.target_date}</td>
          <td>${request.content}</td>
          <td>${createdAtStr}</td>
          <td>
            <a href="pages/approvals.html" class="btn btn-sm btn-primary">æ‰¿èª</a>
            <a href="pages/approvals.html" class="btn btn-sm btn-secondary">è©³ç´°</a>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }
  </script>
</body>
</html>

