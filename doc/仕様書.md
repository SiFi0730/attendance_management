### 勤怠管理システム 仕様書（初版）

最終更新: 2025-12-03

---

## 1. 文書概要
- **目的**: 本書はSaaS形式の勤怠管理ウェブアプリの要件・設計方針・データモデル・インターフェースを定義する。
- **対象読者**: 企画、開発、QA、CS、セキュリティ、インフラ、法務。
- **スコープ**: マルチテナント対応の勤怠打刻、集計、可視化、CSV入出力、企業・従業員管理、社労士招待、将来サービス連携を含む。
- **非スコープ（初版）**: 給与計算エンジン、ICカード/生体認証連携、外部SSO連携の本番運用、モバイルアプリ（Webは対象）。

---

## 2. システム概要
- **提供形態**: マルチテナントSaaS。
- **想定利用者**:
  - システム管理者（Super Admin）: 全体運用・監査・テナント管理。
  - 企業管理者（Company Admin）: 自社設定、従業員/部署管理、就業ルール、承認。
  - 社労士（Professional）: 企業により招待・権限付与、設定確認・助言・監査。
  - 従業員（Employee）: 打刻、申請、自己の勤怠閲覧。
- **主要機能**:
  - 出勤/退勤/休憩の打刻、修正申請、承認ワークフロー
  - 企業側の従業員登録・部署/雇用区分管理
  - 営業時間/就業ルールの登録・適用（フレックス/シフト/固定など）
  - 勤怠のガントチャート可視化（日/週/月・個人/チーム）
  - CSVインポート/エクスポート
  - 社労士の招待/権限付与
  - 将来の社内サービス間連携を見据えたモジュール設計
  - 初期設定・就業ルールを後から拡張しやすい柔軟設計

---

## 3. 用語
- テナント: SaaS上の企業単位。データはテナント毎に厳格分離。
- 就業ルール: 労働時間、休憩、残業計算、丸め、休日/祝日、深夜などの規定集合。
- 打刻（Punch/Record）: 出勤、退勤、休憩開始/終了のイベント。
- 代理打刻: 権限を持つ管理者が従業員の代理で打刻を行う機能。監査ログに記録される。
- タイムシート: 日/週/月の勤怠集計単位とその承認状態。
- ガントチャート: 時系列の出退勤/休憩を棒で表現する可視化。
- 勤務セッション（WorkSession）: 出勤から退勤までの1日の勤務単位。休憩時間を含む。
- 承認フロー: 申請やタイムシートの承認プロセス。1〜2段階承認に対応。

---

## 4. 役割と権限（RBAC）
- 役割:
  - SystemAdmin: 全テナント可視、メタ設定、監査。
  - CompanyAdmin: 自テナントの全設定・承認・閲覧。
  - Professional: 招待されたテナントで付与範囲の閲覧/編集。
  - Manager: 部門単位で部下の承認/閲覧。
  - Employee: 自分の打刻・申請・閲覧。
- 権限例（抜粋）:
  - 従業員管理: CompanyAdmin、Professional(限定)、Manager(配下)
  - 就業ルール編集: CompanyAdmin、Professional(付与範囲)
  - 打刻: Employee（自分）、代理打刻はCompanyAdmin/Managerの設定次第
  - 承認: CompanyAdmin、Manager（配下）、Professional(付与範囲)
  - CSV入出力: CompanyAdmin、Professional(付与範囲)

---

## 5. 機能要件

### 5.1 認証/認可
- Email+Password、MFA（任意/将来必須化可）、パスワードリセット。
- 将来のSSO（SAML/OIDC）追加を前提とした抽象化。
- テナントコンテキストはサブドメイン/ヘッダ/セッションで解決。
- **パスワードリセット**:
  - リセットトークン生成（UUID、32文字以上）、有効期限24時間、1回限り使用。
  - メール送信、トークン検証、新パスワード設定。
  - レート制限: 同一メールアドレスから1時間に3回まで。
- **セッション管理**:
  - JWTまたはセッションストア（Redis推奨）。
  - セッション有効期限: デフォルト8時間、ログイン状態保持時30日。
  - 同時ログイン: 同一ユーザーで複数デバイス可（設定で制限可能）。
  - セッション無効化: ログアウト、パスワード変更、管理者による強制ログアウト。
- **MFA（多要素認証）**:
  - TOTP（Time-based One-Time Password）対応、QRコード表示。
  - バックアップコード生成（10個、1回限り使用）。
  - 将来: SMS、メールOTP対応。

### 5.2 企業・従業員管理
- 企業（テナント）作成、基本情報、ロゴ。
- **ロゴ管理**:
  - 形式: PNG、JPG、SVG（推奨サイズ: 200x200px）。
  - 最大サイズ: 2MB。
  - ストレージ: S3/Cloud Storage（本番）、ローカル（開発）。
- **部署管理**:
  - 階層構造: parent_idによる親子関係、最大5階層まで。
  - 制約: 循環参照防止、削除時は配下部署・従業員の確認。
  - 部署コード: 任意、一意性保証（テナント内）。
- 雇用区分、雇用形態、勤務地（タイムゾーン）、雇用日、退職日。
- 従業員の招待/アカウント紐付け、在籍状態、権限付与。
- **従業員招待**:
  - 招待トークン生成、メール送信、有効期限7日。
  - 招待リンクからアカウント作成・パスワード設定。

### 5.3 営業時間/就業ルール
- 所定労働時間、休憩ポリシー、丸め（5/10/15分等、開始/終了/合算別設定）。
- フレックス（コアタイム/清算期間）、固定時間、シフト（ローテーション/個別割当）。
- 休日/祝日カレンダー（国/会社/部署/個人単位で上書き可）。
- 深夜/休日/残業の定義・計算式のバージョン管理。

### 5.4 打刻・申請・承認
- 打刻チャネル: Web（PC/モバイルWeb）、後日ネイティブ/IC連携想定。
- 打刻イベント: 出勤、退勤、休憩開始、休憩終了。
- オフライン一時保存（Webローカル）、再送キュー（冪等）。
- **代理打刻**:
  - 権限: CompanyAdmin、Manager（配下のみ）、Professional（付与範囲）。
  - 必須項目: 従業員選択、打刻種類、日時、代理打刻理由。
  - 監査ログ: 代理打刻者、理由、日時を記録。
  - 制限: 未来日時の打刻不可、過去30日以内のみ。
- **修正申請**:
  - 申請タイプ: 打刻修正、残業申請、休暇申請、その他。
  - 必須項目: 申請種類、対象日、申請内容、申請理由。
  - 添付ファイル: PDF、画像（最大10MB、5ファイルまで）。
  - 承認フロー: 1〜2段階承認、差戻し、履歴記録。
  - 承認コメント: 承認・差戻し時のコメント（任意）。

### 5.5 ガントチャート可視化
- スケール: 日/週/月。粒度: 分単位（表示は丸め適用後）。
- レイヤ: 出退勤、休憩、申請中/確定状態、アラート表示（遅刻/早退/未打刻）。
- フィルタ: 部署、雇用区分、在籍、ステータス、日付範囲。
- 操作: ズーム、パン、ホバーで詳細、クリックで詳細/編集（権限要）。

### 5.6 集計/レポート
- 日/週/月次での所定/実働/休憩/残業/深夜/休日労働の算出。
- **タイムシート承認フロー**:
  - 状態: 下書き → 申請中 → 承認/差戻し。
  - 承認者: 直属上司（Manager）またはCompanyAdmin。
  - 差戻し: 差戻し理由の記入必須、申請者に通知。
  - 承認コメント: 承認・差戻し時のコメント（任意）。
  - 承認後は編集不可（修正は申請が必要）。
- ダッシュボードKPI（遅刻率、未打刻、所定乖離など）。

### 5.7 CSVインポート/エクスポート
- エクスポート: 従業員一覧、勤怠明細、集計結果、打刻原票。
- インポート: 従業員基本情報、所属、初期残業/有休残高（将来）、打刻履歴。
- 文字コードUTF-8、日付はISO8601、ヘッダ必須、検証エラーは行別に結果出力。
- 大容量は非同期ジョブ化、結果通知、再実行可能。

### 5.8 通知/リマインド
- **通知チャネル**: メール、アプリ内通知（将来: SMS、プッシュ通知）。
- **通知タイプ**:
  - 申請/承認/差戻し通知（即時配信）。
  - 未打刻リマインド（打刻時刻から30分後、1日1回まで）。
  - 未申請リマインド（締日3日前、1日1回まで）。
  - 締日前リマインド（締日1日前、当日）。
  - 休日出勤検知（打刻時に即時通知）。
- **通知テンプレート**: 多言語対応（日本語、英語）、カスタマイズ可能。
- **通知設定**: ユーザー単位で通知チャネル・タイプをON/OFF設定可能。

### 5.9 監査/ログ
- 重要操作の監査証跡（誰が/いつ/何を/前後値）。
- エクスポート/インポート履歴、承認フロー履歴。

---

## 6. 非機能要件
- **性能**:
  - テナント1社あたり従業員1万人規模を許容。
  - 主要画面P95<1.5s、APIレスポンスP95<500ms。
  - 打刻API: P99<200ms（冪等性保証のため）。
  - 集計API: 日次<1s、週次<3s、月次<10s。
- **可用性**: 月間SLA 99.9%（将来）、計画メンテナンスは事前通知。
- **スケーラビリティ**: マルチテナント・スケールアウト。集計はバッチ/ストリーム両対応。
- **セキュリティ**:
  - テナント分離（Row-Level Security等）、保存時/転送時暗号化、MFA、権限最小化。
  - パスワードポリシー: 最小8文字、大文字・小文字・数字・記号を含む（設定で変更可能）。
  - レート制限: ログイン試行5回/15分、API呼び出し1000回/分（IP単位）。
- **プライバシー/法令**:
  - 個人情報保護、データ保管期間の設定、監査対応、地域データ保管選択（将来）。
  - GDPR対応: データエクスポート、削除権（Right to be forgotten）。
- **可観測性**: 構造化ログ、APMトレース、メトリクス、アラート。
- **バックアップ/DR**: 日次バックアップ、RPO<=24h、RTO<=4h 目標。

---

## 7. アーキテクチャ/モジュール
- 構成（将来のサービス連携を意識した疎結合設計）:
  - Identityサービス: 認証/認可、ユーザー/ロール、テナント解決。
  - Organizationサービス: 企業/部署/従業員プロファイル管理。
  - Attendanceサービス: 打刻、タイムシート、承認、集計。
  - Rulesサービス: 就業ルール定義/バージョン/適用解決、計算器。
  - Reportingサービス: エクスポート、ダッシュボード、ジョブ管理。
  - File/Importサービス: CSV入出力、検証、ジョブ、ストレージ。
  - Notificationサービス: 通知配信、テンプレート。
- 連携: 内部はイベント駆動（例: user.created、punch.created、timesheet.approved）。外部API/ウェブフック公開を前提。

---

## 8. 画面（概要）
- 認証: ログイン、パスワードリセット、テナント選択（招待時）。
- 企業設定: 会社情報、営業日/営業時間、就業ルール、祝日カレンダー。
- 従業員: 一覧、詳細、招待、部署/権限、CSVインポート。
- 勤怠打刻: 個人打刻、代理打刻（権限）、未打刻アラート。
- 申請/承認: 修正申請、承認キュー、履歴。
- ガントチャート: チーム/個人ビュー、フィルタ、ズーム、詳細パネル。
- レポート: 集計、エクスポート、ジョブ履歴。
- 監査ログ: フィルタ、エクスポート。

---

## 9. データモデル（論理・主要エンティティ）
- Tenant（企業）: id, name, timezone, locale, status, logo_path, created_at, updated_at, deleted_at
- User: id, email, password_hash, name, mfa_enabled, mfa_secret, backup_codes, status, last_login_at, created_at, updated_at, deleted_at
- PasswordResetToken: id, user_id, token, expires_at, used_at, created_at
- Session: id, user_id, tenant_id, token, expires_at, ip_address, user_agent, created_at
- RoleAssignment: id, tenant_id, user_id, role, scope_type(dept/employee/all), scope_id, created_at, updated_at, deleted_at
- EmployeeProfile: id, tenant_id, user_id(nullable), employee_code, name, email, dept_id, employment_type, hire_date, leave_date, work_location_tz, status, created_at, updated_at, deleted_at
- Department: id, tenant_id, name, code(nullable), parent_id, created_at, updated_at, deleted_at
- BusinessHours: id, tenant_id, scope_type(company/dept/employee), scope_id, weekday, start_time, end_time, break_policy_id, created_at, updated_at
- RuleSet: id, tenant_id, name, version, effective_from, effective_to, config(json), created_at, updated_at
- HolidayCalendar: id, tenant_id, scope_type(country/company/dept/employee), scope_id, date, name, type, created_at, updated_at
- PunchRecord: id, tenant_id, employee_id, type(in/out/break_in/break_out), occurred_at, source(web/api), device, note, proxy_user_id(nullable), proxy_reason(nullable), created_at, updated_at
- WorkSession: id, tenant_id, employee_id, start_at, end_at, total_break_minutes, work_minutes, anomalies(json), created_at, updated_at
- Timesheet: id, tenant_id, employee_id, period_from, period_to, status(draft/submitted/approved/rejected), totals(json), submitted_at, approved_by, approved_at, rejection_reason, created_at, updated_at
- ApprovalFlow: id, tenant_id, type, steps(json), active, created_at, updated_at
- Request(申請): id, tenant_id, employee_id, type(edit/overtime/leave/others), target_date, payload(json), status(pending/approved/rejected), attachment_paths(json), approver_id, decided_at, reason, rejection_reason, created_at, updated_at
- ImportJob/ExportJob: id, tenant_id, type, params(json), status(pending/processing/completed/failed), file_path, result(json), error_message, started_at, completed_at, created_at, updated_at
- AuditLog: id, tenant_id, actor_user_id, action, entity, entity_id, before(json), after(json), ip_address, user_agent, occurred_at
- Notification: id, tenant_id, user_id, type, title, body, channel(email/in_app), read_at, created_at
- FileStorage: id, tenant_id, entity_type, entity_id, file_name, file_path, file_size, mime_type, uploaded_by, created_at

インデックス・制約例:
- すべての業務テーブルに `(tenant_id, ...)` 複合インデックスを付与。
- PunchRecordの冪等キー `(tenant_id, employee_id, type, occurred_at)`。
- 参照整合性（外部キー）と論理削除ポリシーを併用。

---

## 10. API（概要・REST想定）
- 認証: `POST /auth/login`, `POST /auth/logout`, `POST /auth/mfa/verify`, `POST /auth/password-reset`, `POST /auth/password-reset/verify`, `POST /auth/sessions`, `DELETE /auth/sessions/{id}`
- テナント/組織: `GET/POST /tenants`, `GET/POST /departments`, `GET/POST /employees`, `POST /employees/invite`, `POST /tenants/logo`
- 就業ルール: `GET/POST /rulesets`, `GET/POST /business-hours`, `GET/POST /holiday-calendars`
- 打刻: `POST /punches`, `POST /punches/proxy`, `GET /punches?employee_id&from&to`
- セッション/タイムシート: `GET /timesheets`, `POST /timesheets/{id}/submit`, `POST /timesheets/{id}/approve`, `POST /timesheets/{id}/reject`
- 申請/承認: `GET/POST /requests`, `POST /requests/{id}/approve`, `POST /requests/{id}/reject`, `POST /requests/{id}/attachments`
- レポート/CSV: `POST /exports`, `POST /imports`, `GET /jobs/{id}`, `POST /jobs/{id}/retry`
- 監査: `GET /audit-logs`
- 通知: `GET /notifications`, `PUT /notifications/{id}/read`, `PUT /notifications/settings`
- ファイル: `POST /files/upload`, `GET /files/{id}`, `DELETE /files/{id}`

共通:
- 全リソースはテナント境界を必須（サブドメイン、ヘッダ `X-Tenant-ID` 等）。
- ページング: `?page=1&limit=20`、レスポンスに `X-Total-Count` ヘッダ。
- ソート: `?sort=created_at&order=desc`。
- フィルタ: `?filter[status]=active&filter[dept_id]=123`。
- E-Tag: キャッシュ制御、`If-None-Match` ヘッダ対応。
- 監査ID相関: `X-Request-ID` ヘッダでリクエスト追跡。
- エラーレスポンス: `{ "error": { "code": "ERR_XXX", "message": "...", "details": {...} } }`。

---

## 11. CSV仕様（初版）

### 11.1 従業員インポート
- 必須ヘッダ: `employee_code,name,email,dept_code,employment_type,hire_date`
- 任意: `leave_date,work_location_tz`
- バリデーション: 重複employee_code不可、日付形式ISO8601、メール形式。

### 11.2 打刻インポート
- 必須ヘッダ: `employee_code,type,occurred_at,source`
- typeは `in|out|break_in|break_out`。
- 冪等: `(employee_code,type,occurred_at)` 同一はスキップ/上書き選択可能。

### 11.3 勤怠エクスポート（明細）
- 例ヘッダ: `employee_code,date,clock_in,clock_out,break_minutes,work_minutes,overtime_minutes,late,early_leave`
- 文字列はUTF-8、カンマ区切り、ヘッダ1行目必須、空値は空文字。

---

## 12. ガントチャート仕様
- 時間軸: 0–24h（日）、週/月は日単位バーの積み上げ。
- バー種別: 勤務（ベース色）、休憩（薄色）、申請中（点線）、異常（赤）。
- インタラクション: ホバー詳細、クリック編集、ズーム、パン、キーボード移動。
- アクセシビリティ: 色覚多様性配慮、ARIA、コントラスト比準拠。

---

## 13. 初期設定/拡張性方針
- 初期設定ウィザード: 会社情報→部署→従業員→就業ルール→営業日/営業時間→祝日。
- ルールエンジン: ルールの優先度（個人>部署>会社）、バージョン/適用期間。
- 設定は将来の他サービスと共有可能なスキーマ/イベントを採用。

---

## 14. セキュリティ/コンプライアンス
- RBAC、最小権限、管理者操作の二要素。
- PIIの暗号化（保存/転送）、IP許可制（任意）、監査ログの改ざん検知。
- データ保持ポリシー（期間設定/自動削除）、エクスポートのマスキングオプション。

---

## 15. 移行/バージョニング
- APIセマンティックバージョニング、後方互換の非推奨期間設定。
- データ移行ジョブ、CSVテンプレートの版管理。

---

## 16. MVP範囲（提案）
- 必須: 認証、テナント/従業員管理、就業ルール（固定+休憩+丸め）、打刻、修正申請+単段承認、日/週/月集計、ガント基本表示、CSVエクスポート、従業員インポート、監査ログ。
- 任意（次期）: フレックス/シフト、二段承認、祝日上書き、通知、非同期ジョブUI、SSO、外部Webhook、ダッシュボードKPI。

---

## 17. 品質保証
- 受け入れ条件: 代表的ユースケースのE2Eテスト、集計の境界条件（深夜跨ぎ/休憩抜け/未打刻）テスト、CSV往復試験。
- パフォーマンステスト: 一覧/ガント/集計APIの負荷基準、スロークエリ検知。

---

## 18. 付録

### 18.1 エラーコード体系
- 形式: `ERR_<カテゴリ>_<番号>`（例: `ERR_AUTH_001`）。
- カテゴリ:
  - `AUTH`: 認証・認可エラー（001-099）
  - `VALIDATION`: バリデーションエラー（100-199）
  - `NOT_FOUND`: リソース不存在（200-299）
  - `CONFLICT`: 競合エラー（300-399）
  - `RATE_LIMIT`: レート制限（400-499）
  - `INTERNAL`: 内部エラー（500-599）
- 例:
  - `ERR_AUTH_001`: メールアドレスまたはパスワードが正しくありません
  - `ERR_AUTH_002`: セッションが無効です
  - `ERR_VALIDATION_101`: 必須項目が不足しています
  - `ERR_NOT_FOUND_201`: 指定されたリソースが見つかりません

### 18.2 監査イベント一覧
記録すべき操作（抜粋）:
- 認証: `user.login`, `user.logout`, `user.password_reset`, `user.password_change`
- テナント: `tenant.create`, `tenant.update`, `tenant.delete`
- 従業員: `employee.create`, `employee.update`, `employee.delete`, `employee.invite`
- 打刻: `punch.create`, `punch.proxy`
- 申請: `request.create`, `request.approve`, `request.reject`
- タイムシート: `timesheet.submit`, `timesheet.approve`, `timesheet.reject`
- 設定: `ruleset.update`, `business_hours.update`, `holiday_calendar.update`
- エクスポート: `export.create`, `export.download`
- インポート: `import.create`, `import.complete`

### 18.3 CSVサンプルテンプレート
別紙参照。

### 18.4 データ保持ポリシー
- **打刻記録**: 7年間保持（労働基準法に準拠）。
- **タイムシート**: 7年間保持。
- **監査ログ**: 10年間保持（改ざん防止のため）。
- **削除済みデータ**: 論理削除後30日で物理削除（設定で変更可能）。
- **バックアップ**: 日次バックアップ、90日間保持。

### 18.5 ファイル管理仕様
- **ロゴ**: 最大2MB、PNG/JPG/SVG、推奨サイズ200x200px。
- **申請添付ファイル**: 最大10MB/ファイル、5ファイルまで、PDF/画像形式。
- **ストレージ**: S3/Cloud Storage（本番）、ローカル（開発）。
- **アクセス制御**: テナント単位で分離、署名付きURL（一時アクセス）。

### 18.6 ジョブ管理仕様
- **ジョブ状態**: pending → processing → completed/failed。
- **再実行**: failed状態のジョブは再実行可能（最大3回まで）。
- **キャンセル**: processing状態のジョブはキャンセル可能。
- **結果通知**: 完了/失敗時にメール/アプリ内通知。
- **保持期間**: 完了後30日で自動削除。


