# 勤怠管理システム 実装手順書

最終更新: 2025-12-03

---

## 目次
1. [プロジェクト初期設定](#1-プロジェクト初期設定)
2. [データベース設計とマイグレーション](#2-データベース設計とマイグレーション)
3. [認証・認可システム（Identityサービス）](#3-認証認可システムidentityサービス)
4. [テナント・組織管理（Organizationサービス）](#4-テナント組織管理organizationサービス)
5. [就業ルール管理（Rulesサービス）](#5-就業ルール管理rulesサービス)
6. [打刻機能（Attendanceサービス）](#6-打刻機能attendanceサービス)
7. [集計・タイムシート機能](#7-集計タイムシート機能)
8. [申請・承認機能](#8-申請承認機能)
9. [ガントチャート可視化](#9-ガントチャート可視化)
10. [CSV入出力機能（File/Importサービス）](#10-csv入出力機能fileimportサービス)
11. [監査ログ機能](#11-監査ログ機能)
12. [通知機能（Notificationサービス）](#12-通知機能notificationサービス)
13. [レポート・ダッシュボード（Reportingサービス）](#13-レポートダッシュボードreportingサービス)
14. [フロントエンド実装](#14-フロントエンド実装)
15. [テスト実装](#15-テスト実装)
16. [デプロイ準備](#16-デプロイ準備)

---

## 1. プロジェクト初期設定

### 1.1 技術スタック選定
- **バックエンド**: Node.js (Express/Fastify) または Python (FastAPI/Django) または Go
- **データベース**: PostgreSQL（マルチテナント対応、Row-Level Security推奨）
- **キャッシュ**: Redis（セッション、レート制限）
- **フロントエンド**: React/Next.js または Vue.js/Nuxt.js
- **認証**: JWT、セッション管理
- **ファイルストレージ**: ローカル（開発）→ S3/Cloud Storage（本番）
- **ジョブキュー**: Bull/BullMQ または Celery（非同期CSV処理）

### 1.2 プロジェクト構造作成
```
attendance_management/
├── backend/
│   ├── services/
│   │   ├── identity/          # 認証・認可
│   │   ├── organization/      # 企業・従業員管理
│   │   ├── attendance/        # 打刻・タイムシート
│   │   ├── rules/             # 就業ルール
│   │   ├── reporting/         # レポート・集計
│   │   ├── file-import/       # CSV入出力
│   │   └── notification/      # 通知
│   ├── shared/
│   │   ├── database/          # DB接続・マイグレーション
│   │   ├── middleware/        # テナント解決、認証、監査
│   │   ├── events/            # イベントバス
│   │   └── utils/             # 共通ユーティリティ
│   ├── api/                   # APIルーティング
│   └── tests/
├── frontend/
│   ├── src/
│   │   ├── components/        # UIコンポーネント
│   │   ├── pages/             # ページ
│   │   ├── hooks/             # カスタムフック
│   │   ├── services/          # APIクライアント
│   │   └── stores/            # 状態管理
│   └── public/
├── doc/                       # ドキュメント
└── docker-compose.yml         # 開発環境
```

### 1.3 開発環境セットアップ
- Docker ComposeでPostgreSQL、Redisを起動
- 環境変数設定（`.env.example`作成）
- 依存関係インストール
- リンター・フォーマッター設定（ESLint/Prettier等）

---

## 2. データベース設計とマイグレーション

### 2.1 スキーマ設計
仕様書のデータモデル（第9章）に基づき、以下を実装：

**優先順位1（MVP必須）:**
- `tenants` - テナント（企業）
- `users` - ユーザー
- `role_assignments` - 役割割り当て
- `employee_profiles` - 従業員プロファイル
- `departments` - 部署
- `business_hours` - 営業時間
- `rule_sets` - 就業ルールセット
- `holiday_calendars` - 祝日カレンダー
- `punch_records` - 打刻記録
- `work_sessions` - 勤務セッション
- `timesheets` - タイムシート
- `requests` - 修正申請
- `approval_flows` - 承認フロー
- `audit_logs` - 監査ログ

**優先順位2（次期）:**
- `import_jobs` - インポートジョブ
- `export_jobs` - エクスポートジョブ

### 2.2 マイグレーション実装
- マイグレーションツール設定（例: Knex.js、Alembic、Flyway）
- 初期スキーマ作成
- インデックス作成（特に `(tenant_id, ...)` 複合インデックス）
- 外部キー制約設定
- Row-Level Security（RLS）ポリシー実装（PostgreSQL使用時）

### 2.3 シードデータ
- システム管理者アカウント作成
- テスト用テナント・ユーザー作成

---

## 3. 認証・認可システム（Identityサービス）

### 3.1 認証機能
- [x] Email+Passwordログイン (`POST /auth/login`)
- [x] ログアウト (`POST /auth/logout`)
- [x] パスワードリセット（メール送信、トークン検証）
- [x] セッション管理（PHPセッション）
- [x] テナントコンテキスト解決（セッション）
- [ ] MFA（多要素認証）

### 3.2 認可機能（RBAC）
- [x] 役割定義（SystemAdmin, CompanyAdmin, Professional, Manager, Employee）
- [x] 権限チェックミドルウェア
- [x] スコープベースアクセス制御（部署単位等）

### 3.3 将来拡張準備
- [ ] SSO抽象化レイヤー（SAML/OIDC対応準備）
- [ ] MFA基盤（任意実装、将来必須化対応）

### 3.4 セキュリティ
- [ ] パスワードハッシュ化（bcrypt/Argon2）
- [ ] レート制限（ログイン試行）
- [ ] CSRF対策
- [ ] セキュアなCookie設定

---

## 4. テナント・組織管理（Organizationサービス）

### 4.1 テナント管理
- [x] テナント作成・更新（会員登録時に作成）
- [x] テナント基本情報（名前、タイムゾーン、ロケール）
- [ ] テナントロゴアップロード（専用エンドポイント未実装）

### 4.2 部署管理
- [x] 部署CRUD (`GET/POST /departments`)
- [x] 階層構造対応（parent_id）
- [x] 循環参照防止

### 4.3 従業員管理
- [x] 従業員プロファイルCRUD (`GET/POST /employees`)
- [x] 従業員コード管理
- [x] 雇用区分・雇用形態管理
- [x] 雇用日・退職日管理
- [x] ユーザーアカウント紐付け
- [x] 従業員招待機能（API実装済み、メール送信未実装）

### 4.4 役割割り当て
- [ ] 役割割り当てCRUD
- [ ] スコープ設定（部署単位等）

---

## 5. 就業ルール管理（Rulesサービス）

### 5.1 営業時間設定
- [x] 営業時間取得・更新 (`GET /business-hours`, `PUT /business-hours`)
- [x] スコープ設定（会社/部署/個人）
- [x] 曜日別設定
- [ ] 休憩ポリシー設定（将来拡張用）

### 5.2 就業ルールセット
- [x] 現在のルールセット取得・更新 (`GET /rule-sets/current`, `PUT /rule-sets/current`)
- [ ] バージョン管理（将来拡張）
- [ ] 適用期間設定（将来拡張）
- [ ] ルール優先度解決（個人>部署>会社）（将来拡張）
- [x] 丸め設定（5/10/15分、開始/終了/合算別）

### 5.3 祝日カレンダー
- [x] 祝日カレンダーCRUD (`GET /holidays`, `POST /holidays`, `PUT /holidays/{id}`, `DELETE /holidays/{id}`)
- [x] スコープ設定（国/会社/部署/個人）
- [ ] 祝日上書き機能（将来拡張）

### 5.4 ルール計算エンジン
- [ ] 所定労働時間計算
- [ ] 実働時間計算
- [ ] 残業時間計算（基本実装、深夜・休日は次期）
- [ ] 丸め適用ロジック

---

## 6. 打刻機能（Attendanceサービス）

### 6.1 打刻API
- [x] 打刻記録作成 (`POST /punches`)
- [x] 打刻タイプ（in/out/break_in/break_out）
- [x] 冪等性保証（`(tenant_id, employee_id, type, occurred_at)`）
- [x] デバイス情報・ソース記録
- [x] 代理打刻 (`POST /punches/proxy`)

### 6.2 打刻検証
- [x] 打刻順序検証（出勤→退勤、休憩開始→休憩終了）
- [x] 重複打刻検証
- [x] 未来日時打刻検証

### 6.3 オフライン対応（フロントエンド）
- [ ] ローカルストレージへの一時保存
- [ ] 再送キュー実装
- [ ] 同期状態管理

### 6.4 打刻一覧取得
- [x] 打刻履歴取得 (`GET /punches`)
- [x] フィルタリング（従業員、日付範囲、種類）
- [x] ページング

---

## 7. 集計・タイムシート機能

### 7.1 勤務セッション生成
- [ ] 打刻記録から勤務セッション自動生成（未実装、手動生成が必要）
- [x] 出退勤ペアリング（ガントチャートで実装済み）
- [x] 休憩時間計算（ガントチャートで実装済み）
- [x] 異常検知（未打刻、順序エラー等）

### 7.2 タイムシート集計
- [x] 日次集計（レポートAPIで実装済み）
- [x] 週次集計（レポートAPIで実装済み）
- [x] 月次集計（レポートAPIで実装済み）
- [x] 所定労働時間・実働時間・残業時間計算
- [x] タイムシートCRUD (`GET /timesheets`)

### 7.3 タイムシート承認
- [x] タイムシート提出 (`POST /timesheets/{id}/submit`)
- [x] タイムシート承認 (`POST /timesheets/{id}/approve`)
- [x] タイムシート差戻し (`POST /timesheets/{id}/reject`)
- [x] 承認状態管理（下書き/申請中/承認/差戻し）
- [x] 承認履歴記録（監査ログ）

### 7.4 バッチ処理（将来）
- [ ] 定期集計ジョブ（日次/週次/月次）
- [ ] 非同期処理キュー

---

## 8. 申請・承認機能

### 8.1 修正申請
- [x] 申請作成 (`POST /requests`)
- [x] 申請タイプ（打刻修正等）
- [x] 理由・添付ファイル（ファイルパス）
- [x] 申請状態管理

### 8.2 承認フロー
- [ ] 承認フロー定義（`approval_flows`）（将来拡張）
- [x] 単段承認実装（MVP）
- [x] 承認/差戻し処理 (`POST /requests/{id}/approve|reject`)
- [x] 承認履歴記録（監査ログ）

### 8.3 申請一覧
- [x] 申請一覧取得 (`GET /requests`)
- [x] フィルタリング（従業員、状態、日付範囲、種類）
- [x] 承認キュー表示（ダッシュボードで実装済み）

---

## 9. ガントチャート可視化

### 9.1 データ取得API
- [x] ガントチャート用データ取得（打刻データから生成）
- [x] 日/週/月スケール対応
- [x] フィルタリング（部署、従業員、日付範囲）

### 9.2 フロントエンド実装
- [x] ガントチャート実装（Vanilla JS）
- [x] 時間軸表示（0-24h、日/週/月）
- [x] バー表示（勤務、休憩）
- [x] 週/月スケールはカレンダー形式で数値表示
- [x] フィルタリング機能

### 9.3 アクセシビリティ
- [ ] 色覚多様性配慮
- [ ] ARIA属性設定
- [ ] キーボード操作対応

---

## 10. CSV入出力機能（File/Importサービス）

### 10.1 CSVエクスポート
- [x] エクスポート機能（フロントエンドで実装）
- [x] 従業員一覧エクスポート
- [x] 勤怠明細エクスポート (`GET /reports/export/attendance`)
- [x] 集計結果エクスポート
- [x] 打刻原票エクスポート
- [x] UTF-8 BOM付き、ISO8601日付形式対応
- [ ] 非同期ジョブ管理（将来拡張）

### 10.2 CSVインポート
- [x] インポート機能（フロントエンドで実装）
- [x] 従業員インポート（仕様11.1）
- [x] 打刻インポート（仕様11.2、`POST /reports/import`）
- [x] バリデーション（重複、形式チェック）
- [x] エラー行別結果出力
- [ ] 非同期ジョブ管理（将来拡張）

### 10.3 非同期ジョブ（将来）
- [ ] ジョブキュー実装
- [ ] ジョブ状態管理 (`GET /jobs/{id}`)
- [ ] 結果通知（メール/アプリ内）

---

## 11. 監査ログ機能

### 11.1 監査ログ記録
- [x] 重要操作の自動記録
- [x] 監査ログテーブル実装
- [x] 前後値記録（before/after JSON）
- [x] アクター情報記録

### 11.2 監査ログ閲覧
- [x] 監査ログ取得API (`GET /audit-logs`)
- [x] 監査ログ詳細取得API (`GET /audit-logs/{id}`)
- [x] フィルタリング（アクター、アクション、エンティティ、日付範囲）
- [x] ページング
- [x] CSVエクスポート
- [x] フロントエンド実装

### 11.3 セキュリティ
- [ ] 監査ログの改ざん防止
- [ ] アクセス権限管理（管理者のみ）

---

## 12. 通知機能（Notificationサービス）

### 12.1 通知基盤
- [x] 通知テーブル実装
- [x] 通知一覧取得API (`GET /notifications`)
- [x] 通知既読API (`PUT /notifications/{id}/read`)
- [ ] 通知配信インターフェース抽象化
- [ ] 通知送信機能

### 12.2 メール通知（次期）
- [ ] メール送信機能
- [ ] テンプレート管理
- [ ] 申請/承認/差戻し通知

### 12.3 アプリ内通知（次期）
- [ ] アプリ内通知表示
- [ ] 未読管理

### 12.4 リマインド（次期）
- [ ] 未打刻リマインド
- [ ] 未申請リマインド
- [ ] 締日前リマインド

---

## 13. レポート・ダッシュボード（Reportingサービス）

### 13.1 集計レポート
- [x] 日/週/月次集計API (`GET /reports/summary`)
- [x] KPI計算（遅刻率、未打刻率等、ダッシュボードで実装）
- [x] フロントエンド実装

### 13.2 ダッシュボード
- [x] ダッシュボードAPI (`GET /dashboard/stats`, `GET /dashboard/today-punches`, `GET /dashboard/pending-requests`)
- [x] フロントエンド実装

---

## 14. フロントエンド実装

### 14.1 認証画面
- [ ] ログインページ
- [ ] パスワードリセットページ
- [ ] テナント選択（招待時）

### 14.2 企業設定画面
- [x] 会社情報設定（API連携済み）
- [x] 営業日/営業時間設定（API連携済み）
- [x] 就業ルール設定（API連携済み）
- [x] 祝日カレンダー設定（API連携済み）

### 14.3 従業員管理画面
- [x] 従業員一覧（API連携済み）
- [x] 従業員詳細・編集（API連携済み）
- [x] 従業員招待（API連携済み）
- [x] 部署管理（API連携済み）
- [x] CSVインポート（API連携済み）

### 14.4 勤怠打刻画面
- [x] 個人打刻画面（API連携済み）
- [x] 代理打刻機能（API連携済み）
- [x] 未打刻アラート表示

### 14.5 申請/承認画面
- [x] 修正申請フォーム（API連携済み）
- [x] 承認キュー（API連携済み）
- [x] 申請履歴（API連携済み）

### 14.6 ガントチャート画面
- [x] チームビュー（API連携済み）
- [x] 個人ビュー（API連携済み）
- [x] フィルタ機能（API連携済み）
- [x] 日/週/月スケール対応

### 14.7 レポート画面
- [x] 集計表示（API連携済み）
- [x] エクスポート機能（API連携済み）
- [ ] ジョブ履歴（将来拡張）

### 14.8 監査ログ画面
- [x] ログ一覧（API連携済み）
- [x] フィルタ機能（API連携済み）
- [x] エクスポート機能（API連携済み）

### 14.9 共通コンポーネント
- [x] レイアウト（ヘッダー、サイドバー、フッター）
- [x] ナビゲーション
- [x] エラーハンドリング（common.js）
- [x] ローディング表示
- [x] 仮想時間モード対応

---

## 15. テスト実装

### 15.1 単体テスト
- [ ] 各サービスの単体テスト
- [ ] ビジネスロジックテスト
- [ ] ユーティリティ関数テスト

### 15.2 統合テスト
- [ ] API統合テスト
- [ ] データベース統合テスト
- [ ] 認証・認可テスト

### 15.3 E2Eテスト
- [ ] 代表的ユースケースのE2Eテスト
- [ ] 打刻フロー
- [ ] 申請・承認フロー
- [ ] CSV入出力フロー

### 15.4 境界条件テスト
- [ ] 深夜跨ぎ勤務
- [ ] 休憩抜け
- [ ] 未打刻
- [ ] 重複打刻
- [ ] 未来日時打刻

### 15.5 パフォーマンステスト
- [ ] 一覧API負荷テスト
- [ ] ガントチャートAPI負荷テスト
- [ ] 集計API負荷テスト
- [ ] スロークエリ検知

---

## 16. デプロイ準備

### 16.1 環境設定
- [ ] 本番環境変数設定
- [ ] データベース接続設定
- [ ] ストレージ設定（S3等）

### 16.2 セキュリティ設定
- [ ] HTTPS設定
- [ ] セキュアなCookie設定
- [ ] CORS設定
- [ ] セキュリティヘッダー設定

### 16.3 監視・ログ
- [ ] 構造化ログ設定
- [ ] APMトレース設定
- [ ] メトリクス収集
- [ ] アラート設定

### 16.4 バックアップ・DR
- [ ] データベースバックアップ設定
- [ ] バックアップスケジュール
- [ ] リストア手順書作成

### 16.5 CI/CD
- [ ] CI/CDパイプライン設定
- [ ] 自動テスト実行
- [ ] 自動デプロイ設定

---

## 実装優先順位（MVP）

### Phase 1: 基盤構築（Week 1-2）
1. プロジェクト初期設定
2. データベース設計とマイグレーション
3. 認証・認可システム

### Phase 2: コア機能（Week 3-5）
4. テナント・組織管理
5. 就業ルール管理（固定+休憩+丸め）
6. 打刻機能

### Phase 3: 集計・可視化（Week 6-7）
7. 集計・タイムシート機能
8. ガントチャート可視化（基本表示）

### Phase 4: 申請・CSV（Week 8-9）
9. 申請・承認機能（単段承認）
10. CSV入出力機能（エクスポート、従業員インポート）

### Phase 5: 監査・フロントエンド（Week 10-12）
11. 監査ログ機能
12. フロントエンド実装（主要画面）

### Phase 6: テスト・デプロイ（Week 13-14）
13. テスト実装
14. デプロイ準備

---

## 注意事項

- **テナント分離**: すべてのAPIでテナント境界を厳格にチェック
- **冪等性**: 打刻、インポート等で冪等性を保証
- **パフォーマンス**: インデックス最適化、N+1問題回避
- **セキュリティ**: 入力検証、SQLインジェクション対策、XSS対策
- **拡張性**: 将来の機能追加を考慮した設計（イベント駆動、抽象化）
- **ドキュメント**: API仕様書（OpenAPI/Swagger）を随時更新

---

## 参考資料

- 仕様書: `doc/仕様書.md`
- API仕様: 別途作成（OpenAPI形式推奨）
- データベースER図: 別途作成

