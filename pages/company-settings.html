<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¼æ¥­è¨­å®š - å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="../styles/common.css">
  <link rel="stylesheet" href="../styles/components.css">
  <link rel="stylesheet" href="../styles/layout.css">
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="../dashboard.html" class="header-logo">å‹¤æ€ ç®¡ç†</a>
        <nav class="header-nav">
          <a href="../dashboard.html" class="header-nav-link">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
          <a href="punch.html" class="header-nav-link">æ‰“åˆ»</a>
          <a href="gantt.html" class="header-nav-link">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</a>
          <a href="reports.html" class="header-nav-link">ãƒ¬ãƒãƒ¼ãƒˆ</a>
        </nav>
      </div>
      <div class="header-right">
        <a href="requests.html" class="header-nav-link">ç”³è«‹</a>
        <button onclick="logout()" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-sm);">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <a href="profile.html" class="header-user" style="text-decoration: none;">
          <div class="header-user-avatar"></div>
          <span class="header-user-name"></span>
        </a>
      </div>
    </div>
  </header>

  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li class="sidebar-menu-item">
        <a href="../dashboard.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“Š</span>
          <span class="sidebar-menu-label">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="punch.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">â°</span>
          <span class="sidebar-menu-label">æ‰“åˆ»</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="gantt.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“…</span>
          <span class="sidebar-menu-label">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="requests.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“</span>
          <span class="sidebar-menu-label">ç”³è«‹ãƒ»æ‰¿èª</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="employees.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ‘¥</span>
          <span class="sidebar-menu-label">å¾“æ¥­å“¡ç®¡ç†</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="company-settings.html" class="sidebar-menu-link active">
          <span class="sidebar-menu-icon">âš™ï¸</span>
          <span class="sidebar-menu-label">ä¼æ¥­è¨­å®š</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="reports.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“ˆ</span>
          <span class="sidebar-menu-label">ãƒ¬ãƒãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="payslip.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ’°</span>
          <span class="sidebar-menu-label">çµ¦ä¸æ˜ç´°</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="audit-logs.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ”</span>
          <span class="sidebar-menu-label">ç›£æŸ»ãƒ­ã‚°</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-content">
    <div class="page-header">
      <h1 class="page-title">ä¼æ¥­è¨­å®š</h1>
      <p class="page-description">ä¼æ¥­æƒ…å ±ã€å–¶æ¥­æ™‚é–“ã€å°±æ¥­ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¾ã™</p>
    </div>

    <!-- ã‚¿ãƒ– -->
    <div class="tabs">
      <ul class="tab-list">
        <li class="tab-item"><a href="#tab-company" class="tab-link">ä¼šç¤¾æƒ…å ±</a></li>
        <li class="tab-item"><a href="#tab-business-hours" class="tab-link">å–¶æ¥­æ™‚é–“</a></li>
        <li class="tab-item"><a href="#tab-rules" class="tab-link">å°±æ¥­ãƒ«ãƒ¼ãƒ«</a></li>
        <li class="tab-item"><a href="#tab-holidays" class="tab-link">ç¥æ—¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a></li>
      </ul>
    </div>

    <!-- ä¼šç¤¾æƒ…å ± -->
    <div id="tab-company" class="tab-content card">
      <div class="card-header">
        <h2 class="card-title">ä¼šç¤¾æƒ…å ±</h2>
      </div>
      <div class="card-body">
        <form>
          <div class="form-group">
            <label for="company-name" class="form-label required">ä¼šç¤¾å</label>
            <input 
              type="text" 
              id="company-name" 
              name="company-name" 
              class="form-input" 
              value="æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«"
              required
            >
          </div>

          <div class="form-group">
            <label for="company-code" class="form-label">ä¼šç¤¾ã‚³ãƒ¼ãƒ‰</label>
            <input 
              type="text" 
              id="company-code" 
              name="company-code" 
              class="form-input" 
              value="COMP001"
            >
            <div class="form-help">ã‚·ã‚¹ãƒ†ãƒ å†…ã§ä½¿ç”¨ã™ã‚‹ä¸€æ„ã®è­˜åˆ¥å­</div>
          </div>

          <div class="form-group">
            <label for="timezone" class="form-label required">ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³</label>
            <select id="timezone" name="timezone" class="form-select" required>
              <option value="Asia/Tokyo" selected>Asia/Tokyo (JST)</option>
              <option value="UTC">UTC</option>
              <option value="America/New_York">America/New_York (EST)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="locale" class="form-label required">ãƒ­ã‚±ãƒ¼ãƒ«</label>
            <select id="locale" name="locale" class="form-select" required>
              <option value="ja" selected>æ—¥æœ¬èª (ja)</option>
              <option value="en">English (en)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="logo" class="form-label">ãƒ­ã‚´</label>
            <input 
              type="file" 
              id="logo" 
              name="logo" 
              class="form-input"
              accept="image/*"
            >
            <div class="form-help">æ¨å¥¨ã‚µã‚¤ã‚º: 200x200pxã€PNG/JPGå½¢å¼</div>
          </div>

          <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-xl);">
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            <button type="button" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </form>
      </div>
    </div>

    <!-- å–¶æ¥­æ™‚é–“ -->
    <div id="tab-business-hours" class="tab-content card">
      <div class="card-header">
        <h2 class="card-title">å–¶æ¥­æ™‚é–“è¨­å®š</h2>
      </div>
      <div class="card-body">
        <form>
          <div class="form-group">
            <label class="form-label required">æ‰€å®šåŠ´åƒæ™‚é–“</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
              <div>
                <label for="work-start" class="form-label">é–‹å§‹æ™‚åˆ»</label>
                <input 
                  type="time" 
                  id="work-start" 
                  name="work-start" 
                  class="form-input" 
                  value="09:00"
                  required
                >
              </div>
              <div>
                <label for="work-end" class="form-label">çµ‚äº†æ™‚åˆ»</label>
                <input 
                  type="time" 
                  id="work-end" 
                  name="work-end" 
                  class="form-input" 
                  value="18:00"
                  required
                >
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label required">ä¼‘æ†©æ™‚é–“</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
              <div>
                <label for="break-start" class="form-label">é–‹å§‹æ™‚åˆ»</label>
                <input 
                  type="time" 
                  id="break-start" 
                  name="break-start" 
                  class="form-input" 
                  value="12:00"
                  required
                >
              </div>
              <div>
                <label for="break-end" class="form-label">çµ‚äº†æ™‚åˆ»</label>
                <input 
                  type="time" 
                  id="break-end" 
                  name="break-end" 
                  class="form-input" 
                  value="13:00"
                  required
                >
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label required">æ™‚åˆ»ä¸¸ã‚è¨­å®š</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--spacing-md);">
              <div>
                <label for="rounding-start" class="form-label">é–‹å§‹æ™‚åˆ»ä¸¸ã‚</label>
                <select id="rounding-start" name="rounding-start" class="form-select" required>
                  <option value="none">ä¸¸ã‚ãªã—</option>
                  <option value="5" selected>5åˆ†å˜ä½</option>
                  <option value="10">10åˆ†å˜ä½</option>
                  <option value="15">15åˆ†å˜ä½</option>
                </select>
              </div>
              <div>
                <label for="rounding-end" class="form-label">çµ‚äº†æ™‚åˆ»ä¸¸ã‚</label>
                <select id="rounding-end" name="rounding-end" class="form-select" required>
                  <option value="none">ä¸¸ã‚ãªã—</option>
                  <option value="5" selected>5åˆ†å˜ä½</option>
                  <option value="10">10åˆ†å˜ä½</option>
                  <option value="15">15åˆ†å˜ä½</option>
                </select>
              </div>
              <div>
                <label for="rounding-total" class="form-label">åˆè¨ˆæ™‚é–“ä¸¸ã‚</label>
                <select id="rounding-total" name="rounding-total" class="form-select" required>
                  <option value="none">ä¸¸ã‚ãªã—</option>
                  <option value="5" selected>5åˆ†å˜ä½</option>
                  <option value="10">10åˆ†å˜ä½</option>
                  <option value="15">15åˆ†å˜ä½</option>
                </select>
              </div>
            </div>
            <div class="form-help">æ‰“åˆ»æ™‚åˆ»ã‚’æŒ‡å®šã—ãŸå˜ä½ã§ä¸¸ã‚ã¾ã™ã€‚é–‹å§‹/çµ‚äº†/åˆè¨ˆæ™‚é–“ã‚’å€‹åˆ¥ã«è¨­å®šã§ãã¾ã™ï¼ˆä»•æ§˜æ›¸5.3ï¼‰</div>
          </div>

          <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-xl);">
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            <button type="button" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </form>
      </div>
    </div>

    <!-- å°±æ¥­ãƒ«ãƒ¼ãƒ« -->
    <div id="tab-rules" class="tab-content card">
      <div class="card-header">
        <h2 class="card-title">å°±æ¥­ãƒ«ãƒ¼ãƒ«</h2>
      </div>
      <div class="card-body">
        <form>
          <div class="form-group">
            <label for="work-type" class="form-label required">å‹¤å‹™å½¢æ…‹</label>
            <select id="work-type" name="work-type" class="form-select" required>
              <option value="fixed" selected>å›ºå®šæ™‚é–“</option>
              <option value="flex">ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ </option>
              <option value="shift">ã‚·ãƒ•ãƒˆåˆ¶</option>
            </select>
          </div>

          <div class="form-group">
            <label for="overtime-calculation" class="form-label required">æ®‹æ¥­è¨ˆç®—æ–¹æ³•</label>
            <select id="overtime-calculation" name="overtime-calculation" class="form-select" required>
              <option value="daily" selected>æ—¥æ¬¡è¨ˆç®—</option>
              <option value="monthly">æœˆæ¬¡è¨ˆç®—</option>
            </select>
          </div>

          <div class="form-group">
            <label for="night-work" class="form-label">æ·±å¤œåŠ´åƒã®å®šç¾©</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
              <div>
                <label for="night-start" class="form-label">é–‹å§‹æ™‚åˆ»</label>
                <input 
                  type="time" 
                  id="night-start" 
                  name="night-start" 
                  class="form-input" 
                  value="22:00"
                >
              </div>
              <div>
                <label for="night-end" class="form-label">çµ‚äº†æ™‚åˆ»</label>
                <input 
                  type="time" 
                  id="night-end" 
                  name="night-end" 
                  class="form-input" 
                  value="05:00"
                >
              </div>
            </div>
          </div>

          <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-xl);">
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            <button type="button" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ç¥æ—¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
    <div id="tab-holidays" class="tab-content card">
      <div class="card-header">
        <h2 class="card-title">ç¥æ—¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
        <div class="page-actions">
          <button class="btn btn-primary">ç¥æ—¥ã‚’è¿½åŠ </button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>æ—¥ä»˜</th>
                <th>åç§°</th>
                <th>ç¨®é¡</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>2025-01-01</td>
                <td>å…ƒæ—¥</td>
                <td><span class="badge badge-primary">ç¥æ—¥</span></td>
                <td>
                  <button class="btn btn-sm btn-secondary">ç·¨é›†</button>
                  <button class="btn btn-sm btn-danger">å‰Šé™¤</button>
                </td>
              </tr>
              <tr>
                <td>2025-01-13</td>
                <td>æˆäººã®æ—¥</td>
                <td><span class="badge badge-primary">ç¥æ—¥</span></td>
                <td>
                  <button class="btn btn-sm btn-secondary">ç·¨é›†</button>
                  <button class="btn btn-sm btn-danger">å‰Šé™¤</button>
                </td>
              </tr>
              <tr>
                <td>2025-02-11</td>
                <td>å»ºå›½è¨˜å¿µã®æ—¥</td>
                <td><span class="badge badge-primary">ç¥æ—¥</span></td>
                <td>
                  <button class="btn btn-sm btn-secondary">ç·¨é›†</button>
                  <button class="btn btn-sm btn-danger">å‰Šé™¤</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
  <script src="../scripts/common.js"></script>
  <script>
    // ============================================
    // ä¼æ¥­è¨­å®š - APIé€£æº
    // ============================================

    let tenant = null;
    let businessHours = [];
    let ruleSet = null;
    let holidays = [];
    let currentTab = 'company';

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      await Promise.all([
        loadTenant(),
        loadBusinessHours(),
        loadRuleSet(),
        loadHolidays()
      ]);
      setupEventListeners();
      updateHeaderUserInfo();
    });

    // ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿
    async function loadTenant() {
      try {
        // ç¾åœ¨ã®ãƒ†ãƒŠãƒ³ãƒˆIDã‚’å–å¾—ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ï¼‰
        const response = await apiFetch(`${API_BASE_URL}/tenants`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          tenant = Array.isArray(data.data) ? data.data[0] : data.data;
          if (tenant) {
            renderTenant();
          }
        }
      } catch (error) {
        console.error('ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã‚’æç”»
    function renderTenant() {
      if (!tenant) return;

      document.getElementById('company-name').value = tenant.name || '';
      document.getElementById('timezone').value = tenant.timezone || 'Asia/Tokyo';
      document.getElementById('locale').value = tenant.locale || 'ja';
    }

    // å–¶æ¥­æ™‚é–“ã‚’èª­ã¿è¾¼ã¿
    async function loadBusinessHours() {
      try {
        const response = await apiFetch(`${API_BASE_URL}/business-hours?scope_type=company`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          businessHours = data.data || [];
          renderBusinessHours();
        }
      } catch (error) {
        console.error('å–¶æ¥­æ™‚é–“ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // å–¶æ¥­æ™‚é–“ã‚’æç”»
    function renderBusinessHours() {
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆæœˆæ›œæ—¥ã‹ã‚‰é‡‘æ›œæ—¥ï¼‰
      const defaultHours = {
        1: { start: '09:00', end: '18:00' },
        2: { start: '09:00', end: '18:00' },
        3: { start: '09:00', end: '18:00' },
        4: { start: '09:00', end: '18:00' },
        5: { start: '09:00', end: '18:00' }
      };

      businessHours.forEach(bh => {
        defaultHours[bh.weekday] = {
          start: bh.start_time.substring(0, 5),
          end: bh.end_time.substring(0, 5)
        };
      });

      // æœˆæ›œæ—¥ï¼ˆ1ï¼‰ã®å€¤ã‚’è¨­å®š
      if (defaultHours[1]) {
        document.getElementById('work-start').value = defaultHours[1].start;
        document.getElementById('work-end').value = defaultHours[1].end;
      }
    }

    // å°±æ¥­ãƒ«ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿
    async function loadRuleSet() {
      try {
        const response = await apiFetch(`${API_BASE_URL}/rule-sets/current`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          ruleSet = data.data;
          renderRuleSet();
        }
      } catch (error) {
        console.error('å°±æ¥­ãƒ«ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // å°±æ¥­ãƒ«ãƒ¼ãƒ«ã‚’æç”»
    function renderRuleSet() {
      if (!ruleSet || !ruleSet.config) return;

      const config = ruleSet.config;
      document.getElementById('work-type').value = config.work_type || 'fixed';
      document.getElementById('overtime-calculation').value = config.overtime_calculation || 'daily';
      document.getElementById('night-start').value = config.night_work_start || '22:00';
      document.getElementById('night-end').value = config.night_work_end || '05:00';

      if (config.rounding) {
        document.getElementById('rounding-start').value = config.rounding.start || '5';
        document.getElementById('rounding-end').value = config.rounding.end || '5';
        document.getElementById('rounding-total').value = config.rounding.total || '5';
      }
    }

    // ç¥æ—¥ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadHolidays() {
      try {
        const currentYear = new Date().getFullYear();
        const response = await apiFetch(`${API_BASE_URL}/holidays?scope_type=company&year=${currentYear}`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          holidays = data.data || [];
          renderHolidays();
        }
      } catch (error) {
        console.error('ç¥æ—¥ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ç¥æ—¥ä¸€è¦§ã‚’æç”»
    function renderHolidays() {
      const tbody = document.querySelector('#tab-holidays .table tbody');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (holidays.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="4" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">ç¥æ—¥ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td>';
        tbody.appendChild(row);
        return;
      }

      holidays.forEach(holiday => {
        const row = document.createElement('tr');
        const date = new Date(holiday.date);
        const dateStr = date.toLocaleDateString('ja-JP');
        
        const typeBadges = {
          'holiday': '<span class="badge badge-primary">ç¥æ—¥</span>',
          'company_holiday': '<span class="badge badge-secondary">ä¼šç¤¾ä¼‘æ—¥</span>',
          'special': '<span class="badge badge-warning">ç‰¹åˆ¥ä¼‘æ—¥</span>'
        };

        row.innerHTML = `
          <td>${dateStr}</td>
          <td>${holiday.name || '-'}</td>
          <td>${typeBadges[holiday.type] || holiday.type}</td>
          <td>
            <button onclick="openEditHolidayModal('${holiday.id}')" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-xs);">ç·¨é›†</button>
            <button onclick="deleteHoliday('${holiday.id}')" class="btn btn-sm btn-danger">å‰Šé™¤</button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    function setupEventListeners() {
      // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab-link').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const tab = this.getAttribute('href').substring(1);
          currentTab = tab.replace('tab-', '');
          
          document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
          });
          document.getElementById(tab).style.display = 'block';
          
          document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
          this.classList.add('active');
        });
      });

      // ä¼šç¤¾æƒ…å ±ãƒ•ã‚©ãƒ¼ãƒ 
      const companyForm = document.querySelector('#tab-company form');
      if (companyForm) {
        companyForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          await saveTenant();
        });
      }

      // å–¶æ¥­æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒ 
      const businessHoursForm = document.querySelector('#tab-business-hours form');
      if (businessHoursForm) {
        businessHoursForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          await saveBusinessHours();
        });
      }

      // å°±æ¥­ãƒ«ãƒ¼ãƒ«ãƒ•ã‚©ãƒ¼ãƒ 
      const rulesForm = document.querySelector('#tab-rules form');
      if (rulesForm) {
        rulesForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          await saveRuleSet();
        });
      }

      // ç¥æ—¥è¿½åŠ ãƒœã‚¿ãƒ³
      const addHolidayBtn = document.querySelector('#tab-holidays .btn-primary');
      if (addHolidayBtn) {
        addHolidayBtn.addEventListener('click', function() {
          openNewHolidayModal();
        });
      }
    }

    // ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã‚’ä¿å­˜
    async function saveTenant() {
      if (!tenant) return;

      const name = document.getElementById('company-name').value;
      const timezone = document.getElementById('timezone').value;
      const locale = document.getElementById('locale').value;

      try {
        const requestData = {
          name: name,
          timezone: timezone,
          locale: locale
        };

        const response = await apiFetch(`${API_BASE_URL}/tenants/${tenant.id}`, {
          method: 'PUT',
          body: JSON.stringify(requestData)
        });

        const data = await response.json();

        if (response.ok && data.success) {
          alert('ä¼šç¤¾æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          await loadTenant();
        } else {
          console.error('ãƒ†ãƒŠãƒ³ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', data);
          alert('ä¼šç¤¾æƒ…å ±ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        console.error('ãƒ†ãƒŠãƒ³ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¼šç¤¾æƒ…å ±ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // å–¶æ¥­æ™‚é–“ã‚’ä¿å­˜
    async function saveBusinessHours() {
      const workStart = document.getElementById('work-start').value;
      const workEnd = document.getElementById('work-end').value;
      const breakStart = document.getElementById('break-start').value;
      const breakEnd = document.getElementById('break-end').value;

      // æœˆæ›œæ—¥ã‹ã‚‰é‡‘æ›œæ—¥ï¼ˆ1-5ï¼‰ã®å–¶æ¥­æ™‚é–“ã‚’è¨­å®š
      const hours = [];
      for (let weekday = 1; weekday <= 5; weekday++) {
        hours.push({
          weekday: weekday,
          start_time: workStart,
          end_time: workEnd
        });
      }

      try {
        const requestData = {
          scope_type: 'company',
          scope_id: null,
          hours: hours
        };

        const response = await apiFetch(`${API_BASE_URL}/business-hours`, {
          method: 'PUT',
          body: JSON.stringify(requestData)
        });

        const data = await response.json();

        if (response.ok && data.success) {
          alert('å–¶æ¥­æ™‚é–“ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          await loadBusinessHours();
        } else {
          console.error('å–¶æ¥­æ™‚é–“æ›´æ–°ã‚¨ãƒ©ãƒ¼:', data);
          alert('å–¶æ¥­æ™‚é–“ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        console.error('å–¶æ¥­æ™‚é–“æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        alert('å–¶æ¥­æ™‚é–“ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // å°±æ¥­ãƒ«ãƒ¼ãƒ«ã‚’ä¿å­˜
    async function saveRuleSet() {
      const workType = document.getElementById('work-type').value;
      const overtimeCalculation = document.getElementById('overtime-calculation').value;
      const nightStart = document.getElementById('night-start').value;
      const nightEnd = document.getElementById('night-end').value;
      const roundingStart = document.getElementById('rounding-start').value;
      const roundingEnd = document.getElementById('rounding-end').value;
      const roundingTotal = document.getElementById('rounding-total').value;

      try {
        const requestData = {
          name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ',
          config: {
            work_type: workType,
            overtime_calculation: overtimeCalculation,
            night_work_start: nightStart,
            night_work_end: nightEnd,
            rounding: {
              start: roundingStart,
              end: roundingEnd,
              total: roundingTotal
            }
          }
        };

        const response = await apiFetch(`${API_BASE_URL}/rule-sets/current`, {
          method: 'PUT',
          body: JSON.stringify(requestData)
        });

        const data = await response.json();

        if (response.ok && data.success) {
          alert('å°±æ¥­ãƒ«ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          await loadRuleSet();
        } else {
          console.error('å°±æ¥­ãƒ«ãƒ¼ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', data);
          alert('å°±æ¥­ãƒ«ãƒ¼ãƒ«ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        console.error('å°±æ¥­ãƒ«ãƒ¼ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        alert('å°±æ¥­ãƒ«ãƒ¼ãƒ«ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // æ–°è¦ç¥æ—¥ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openNewHolidayModal() {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
      let modal = document.getElementById('modal-new-holiday');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modal-new-holiday';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2 class="modal-title">ç¥æ—¥ã‚’è¿½åŠ </h2>
              <a href="#" class="modal-close">&times;</a>
            </div>
            <div class="modal-body">
              <form id="form-new-holiday">
                <div class="form-group">
                  <label for="holiday-date" class="form-label required">æ—¥ä»˜</label>
                  <input type="date" id="holiday-date" class="form-input" required>
                </div>
                <div class="form-group">
                  <label for="holiday-name" class="form-label required">åç§°</label>
                  <input type="text" id="holiday-name" class="form-input" required>
                </div>
                <div class="form-group">
                  <label for="holiday-type" class="form-label required">ç¨®é¡</label>
                  <select id="holiday-type" class="form-select" required>
                    <option value="holiday">ç¥æ—¥</option>
                    <option value="company_holiday">ä¼šç¤¾ä¼‘æ—¥</option>
                    <option value="special">ç‰¹åˆ¥ä¼‘æ—¥</option>
                  </select>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <a href="#" class="btn btn-secondary modal-close">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
              <button type="button" class="btn btn-primary" onclick="createHoliday()">è¿½åŠ </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }
      modal.style.display = 'block';
      document.getElementById('form-new-holiday').reset();
    }

    // ç¥æ—¥ã‚’ä½œæˆ
    async function createHoliday() {
      const date = document.getElementById('holiday-date').value;
      const name = document.getElementById('holiday-name').value;
      const type = document.getElementById('holiday-type').value;

      if (!date || !name) {
        alert('æ—¥ä»˜ã¨åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const requestData = {
          scope_type: 'company',
          scope_id: null,
          date: date,
          name: name,
          type: type
        };

        const response = await apiFetch(`${API_BASE_URL}/holidays`, {
          method: 'POST',
          body: JSON.stringify(requestData)
        });

        const data = await response.json();

        if (response.ok && data.success) {
          alert('ç¥æ—¥ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
          document.getElementById('modal-new-holiday').style.display = 'none';
          await loadHolidays();
        } else {
          console.error('ç¥æ—¥ä½œæˆã‚¨ãƒ©ãƒ¼:', data);
          alert('ç¥æ—¥ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        console.error('ç¥æ—¥ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        alert('ç¥æ—¥ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ç¥æ—¥ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    async function openEditHolidayModal(holidayId) {
      const holiday = holidays.find(h => h.id === holidayId);
      if (!holiday) return;

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
      let modal = document.getElementById('modal-edit-holiday');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modal-edit-holiday';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2 class="modal-title">ç¥æ—¥ã‚’ç·¨é›†</h2>
              <a href="#" class="modal-close">&times;</a>
            </div>
            <div class="modal-body">
              <form id="form-edit-holiday">
                <input type="hidden" id="edit-holiday-id">
                <div class="form-group">
                  <label for="edit-holiday-date" class="form-label">æ—¥ä»˜</label>
                  <input type="date" id="edit-holiday-date" class="form-input" readonly style="background-color: var(--bg-secondary);">
                  <div class="form-help">æ—¥ä»˜ã¯å¤‰æ›´ã§ãã¾ã›ã‚“</div>
                </div>
                <div class="form-group">
                  <label for="edit-holiday-name" class="form-label required">åç§°</label>
                  <input type="text" id="edit-holiday-name" class="form-input" required>
                </div>
                <div class="form-group">
                  <label for="edit-holiday-type" class="form-label required">ç¨®é¡</label>
                  <select id="edit-holiday-type" class="form-select" required>
                    <option value="holiday">ç¥æ—¥</option>
                    <option value="company_holiday">ä¼šç¤¾ä¼‘æ—¥</option>
                    <option value="special">ç‰¹åˆ¥ä¼‘æ—¥</option>
                  </select>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <a href="#" class="btn btn-secondary modal-close">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
              <button type="button" class="btn btn-primary" onclick="updateHoliday()">ä¿å­˜</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      document.getElementById('edit-holiday-id').value = holiday.id;
      document.getElementById('edit-holiday-date').value = holiday.date;
      document.getElementById('edit-holiday-name').value = holiday.name;
      document.getElementById('edit-holiday-type').value = holiday.type;
      modal.style.display = 'block';
    }

    // ç¥æ—¥ã‚’æ›´æ–°
    async function updateHoliday() {
      const holidayId = document.getElementById('edit-holiday-id').value;
      const name = document.getElementById('edit-holiday-name').value;
      const type = document.getElementById('edit-holiday-type').value;

      if (!name) {
        alert('åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const requestData = {
          name: name,
          type: type
        };

        const response = await apiFetch(`${API_BASE_URL}/holidays/${holidayId}`, {
          method: 'PUT',
          body: JSON.stringify(requestData)
        });

        const data = await response.json();

        if (response.ok && data.success) {
          alert('ç¥æ—¥ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          document.getElementById('modal-edit-holiday').style.display = 'none';
          await loadHolidays();
        } else {
          console.error('ç¥æ—¥æ›´æ–°ã‚¨ãƒ©ãƒ¼:', data);
          alert('ç¥æ—¥ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        console.error('ç¥æ—¥æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        alert('ç¥æ—¥ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ç¥æ—¥ã‚’å‰Šé™¤
    async function deleteHoliday(holidayId) {
      if (!confirm('ã“ã®ç¥æ—¥ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      try {
        const response = await apiFetch(`${API_BASE_URL}/holidays/${holidayId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok && data.success) {
          alert('ç¥æ—¥ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
          await loadHolidays();
        } else {
          console.error('ç¥æ—¥å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', data);
          alert('ç¥æ—¥ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        console.error('ç¥æ—¥å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('ç¥æ—¥ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal-close') || e.target.classList.contains('modal')) {
        const modal = e.target.closest('.modal');
        if (modal) {
          modal.style.display = 'none';
        }
      }
    });

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.createHoliday = createHoliday;
    window.updateHoliday = updateHoliday;
    window.openEditHolidayModal = openEditHolidayModal;
    window.deleteHoliday = deleteHoliday;
  </script>
</body>
</html>

