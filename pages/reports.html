<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¬ãƒãƒ¼ãƒˆ - å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="../styles/common.css">
  <link rel="stylesheet" href="../styles/components.css">
  <link rel="stylesheet" href="../styles/layout.css">
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="../dashboard.html" class="header-logo">å‹¤æ€ ç®¡ç†</a>
        <nav class="header-nav">
          <a href="../dashboard.html" class="header-nav-link">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
          <a href="punch.html" class="header-nav-link">æ‰“åˆ»</a>
          <a href="gantt.html" class="header-nav-link">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</a>
          <a href="reports.html" class="header-nav-link active">ãƒ¬ãƒãƒ¼ãƒˆ</a>
        </nav>
      </div>
      <div class="header-right">
        <a href="requests.html" class="header-nav-link">ç”³è«‹</a>
        <button onclick="logout()" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-sm);">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <a href="profile.html" class="header-user" style="text-decoration: none;">
          <div class="header-user-avatar"></div>
          <span class="header-user-name"></span>
        </a>
      </div>
    </div>
  </header>

  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li class="sidebar-menu-item">
        <a href="../dashboard.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“Š</span>
          <span class="sidebar-menu-label">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="punch.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">â°</span>
          <span class="sidebar-menu-label">æ‰“åˆ»</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="gantt.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“…</span>
          <span class="sidebar-menu-label">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="requests.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“</span>
          <span class="sidebar-menu-label">ç”³è«‹ãƒ»æ‰¿èª</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="employees.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ‘¥</span>
          <span class="sidebar-menu-label">å¾“æ¥­å“¡ç®¡ç†</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="company-settings.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">âš™ï¸</span>
          <span class="sidebar-menu-label">ä¼æ¥­è¨­å®š</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="reports.html" class="sidebar-menu-link active">
          <span class="sidebar-menu-icon">ğŸ“ˆ</span>
          <span class="sidebar-menu-label">ãƒ¬ãƒãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="payslip.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ’°</span>
          <span class="sidebar-menu-label">çµ¦ä¸æ˜ç´°</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="audit-logs.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ”</span>
          <span class="sidebar-menu-label">ç›£æŸ»ãƒ­ã‚°</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-content">
    <div class="page-header">
      <h1 class="page-title">ãƒ¬ãƒãƒ¼ãƒˆ</h1>
      <p class="page-description">å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’è¡Œã„ã¾ã™</p>
    </div>

    <!-- ã‚¿ãƒ– -->
    <div class="tabs">
      <ul class="tab-list">
        <li class="tab-item"><a href="#tab-summary" class="tab-link">é›†è¨ˆ</a></li>
        <li class="tab-item"><a href="#tab-export" class="tab-link">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</a></li>
        <li class="tab-item"><a href="#tab-import" class="tab-link">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</a></li>
        <li class="tab-item"><a href="#tab-jobs" class="tab-link">ã‚¸ãƒ§ãƒ–å±¥æ­´</a></li>
        <li class="tab-item"><a href="payslip.html" class="tab-link">çµ¦ä¸æ˜ç´°</a></li>
      </ul>
    </div>

    <!-- é›†è¨ˆã‚¿ãƒ– -->
    <div id="tab-summary" class="tab-content card">
      <div class="card-header">
        <h2 class="card-title">é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆ</h2>
      </div>
      <div class="card-body">
        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒãƒ¼ -->
        <div class="filter-bar" style="margin-bottom: var(--spacing-lg);">
          <div class="filter-group">
            <label class="filter-label">é›†è¨ˆæœŸé–“:</label>
            <select class="form-select filter-input">
              <option value="daily" selected>æ—¥æ¬¡</option>
              <option value="weekly">é€±æ¬¡</option>
              <option value="monthly">æœˆæ¬¡</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">é–‹å§‹æ—¥:</label>
            <input type="date" class="form-input filter-input" value="2025-01-01">
          </div>
          <div class="filter-group">
            <label class="filter-label">çµ‚äº†æ—¥:</label>
            <input type="date" class="form-input filter-input" value="2025-01-31">
          </div>
          <div class="filter-group">
            <label class="filter-label">éƒ¨ç½²:</label>
            <select class="form-select filter-input">
              <option value="">ã™ã¹ã¦</option>
              <option value="sales">å–¶æ¥­éƒ¨</option>
              <option value="dev">é–‹ç™ºéƒ¨</option>
            </select>
          </div>
          <div class="filter-group">
            <button class="btn btn-primary">é›†è¨ˆå®Ÿè¡Œ</button>
          </div>
        </div>

        <!-- é›†è¨ˆçµæœ -->
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>å¾“æ¥­å“¡å</th>
                <th>éƒ¨ç½²</th>
                <th>å®Ÿåƒæ™‚é–“</th>
                <th>æ‰€å®šæ™‚é–“</th>
                <th>æ®‹æ¥­æ™‚é–“</th>
                <th>æ·±å¤œæ™‚é–“</th>
                <th>ä¼‘æ—¥åŠ´åƒ</th>
                <th>é…åˆ»å›æ•°</th>
                <th>æ—©é€€å›æ•°</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="9" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">
                  é›†è¨ˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
    <div id="tab-export" class="tab-content card">
      <div class="card-header">
        <h2 class="card-title">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2>
      </div>
      <div class="card-body">
        <form>
          <div class="form-group">
            <label for="export-type" class="form-label required">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç¨®é¡</label>
            <select id="export-type" name="export-type" class="form-select" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="employees">å¾“æ¥­å“¡ä¸€è¦§</option>
              <option value="attendance">å‹¤æ€ æ˜ç´°ï¼ˆä»•æ§˜æ›¸11.3ï¼‰</option>
              <option value="summary">é›†è¨ˆçµæœ</option>
              <option value="punches">æ‰“åˆ»åŸç¥¨</option>
            </select>
            <div class="form-help" id="export-help" style="display: none;">
              <strong>å‹¤æ€ æ˜ç´°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä»•æ§˜ï¼ˆä»•æ§˜æ›¸11.3ï¼‰:</strong><br>
              ãƒ˜ãƒƒãƒ€ä¾‹: <code>employee_code</code>, <code>date</code>, <code>clock_in</code>, <code>clock_out</code>, <code>break_minutes</code>, <code>work_minutes</code>, <code>overtime_minutes</code>, <code>late</code>, <code>early_leave</code><br>
              æ–‡å­—ã‚³ãƒ¼ãƒ‰: UTF-8ã€æ—¥ä»˜å½¢å¼: ISO8601ã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€ãƒ˜ãƒƒãƒ€1è¡Œç›®å¿…é ˆ
            </div>
          </div>

          <div class="form-group">
            <label for="export-period-start" class="form-label">é–‹å§‹æ—¥</label>
            <input 
              type="date" 
              id="export-period-start" 
              name="export-period-start" 
              class="form-input"
            >
          </div>

          <div class="form-group">
            <label for="export-period-end" class="form-label">çµ‚äº†æ—¥</label>
            <input 
              type="date" 
              id="export-period-end" 
              name="export-period-end" 
              class="form-input"
            >
          </div>

          <div class="form-group">
            <label for="export-department" class="form-label">éƒ¨ç½²</label>
            <select id="export-department" name="export-department" class="form-select">
              <option value="">ã™ã¹ã¦</option>
              <option value="sales">å–¶æ¥­éƒ¨</option>
              <option value="dev">é–‹ç™ºéƒ¨</option>
            </select>
          </div>

          <div class="form-group">
            <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer;">
              <input type="checkbox" name="include-personal-info" style="cursor: pointer;">
              <span>å€‹äººæƒ…å ±ã‚’å«ã‚ã‚‹</span>
            </label>
            <div class="form-help" style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-top: var(--spacing-xs);">
              å€‹äººæƒ…å ±ä¿è­·ã®ãŸã‚ã€å¿…è¦æœ€å°é™ã®æƒ…å ±ã®ã¿å«ã‚ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ï¼ˆä»•æ§˜æ›¸14ï¼‰
            </div>
          </div>

          <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-xl);">
            <button type="submit" class="btn btn-primary">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–‹å§‹</button>
            <button type="button" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
    <div id="tab-import" class="tab-content card">
      <div class="card-header">
        <h2 class="card-title">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
      </div>
      <div class="card-body">
        <form>
          <div class="form-group">
            <label for="import-type" class="form-label required">ã‚¤ãƒ³ãƒãƒ¼ãƒˆç¨®é¡</label>
            <select id="import-type" name="import-type" class="form-select" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="employees">å¾“æ¥­å“¡ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆä»•æ§˜æ›¸11.1ï¼‰</option>
              <option value="punches">æ‰“åˆ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆä»•æ§˜æ›¸11.2ï¼‰</option>
            </select>
          </div>

          <div class="form-group">
            <label for="import-file" class="form-label required">CSVãƒ•ã‚¡ã‚¤ãƒ«</label>
            <input 
              type="file" 
              id="import-file" 
              name="import-file" 
              class="form-input"
              accept=".csv"
              required
            >
            <div class="form-help" id="import-help">
              CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚æ–‡å­—ã‚³ãƒ¼ãƒ‰: UTF-8ã€æ—¥ä»˜å½¢å¼: ISO8601
            </div>
          </div>

          <div class="form-group" id="import-spec-employees" style="display: none;">
            <div class="alert alert-info">
              <strong>å¾“æ¥­å“¡ã‚¤ãƒ³ãƒãƒ¼ãƒˆä»•æ§˜ï¼ˆä»•æ§˜æ›¸11.1ï¼‰:</strong><br>
              å¿…é ˆãƒ˜ãƒƒãƒ€: <code>employee_code</code>, <code>name</code>, <code>email</code>, <code>dept_code</code>, <code>employment_type</code>, <code>hire_date</code><br>
              ä»»æ„ãƒ˜ãƒƒãƒ€: <code>leave_date</code>, <code>work_location_tz</code><br>
              ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: é‡è¤‡employee_codeä¸å¯ã€æ—¥ä»˜å½¢å¼ISO8601ã€ãƒ¡ãƒ¼ãƒ«å½¢å¼
            </div>
          </div>

          <div class="form-group" id="import-spec-punches" style="display: none;">
            <div class="alert alert-info">
              <strong>æ‰“åˆ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆä»•æ§˜ï¼ˆä»•æ§˜æ›¸11.2ï¼‰:</strong><br>
              å¿…é ˆãƒ˜ãƒƒãƒ€: <code>employee_code</code>, <code>type</code>, <code>occurred_at</code>, <code>source</code><br>
              typeã¯ <code>in</code> | <code>out</code> | <code>break_in</code> | <code>break_out</code><br>
              å†ªç­‰: <code>(employee_code,type,occurred_at)</code> åŒä¸€ã¯ã‚¹ã‚­ãƒƒãƒ—/ä¸Šæ›¸ãé¸æŠå¯èƒ½
            </div>
            <div class="form-group" style="margin-top: var(--spacing-md);">
              <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer;">
                <input type="checkbox" name="skip-duplicate-punches" style="cursor: pointer;">
                <span>é‡è¤‡æ‰“åˆ»ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ¨å¥¨: ã‚ªãƒ•ï¼‰</span>
              </label>
              <div class="form-help" style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-top: var(--spacing-xs);">
                åŒä¸€ã®(employee_code,type,occurred_at)ãŒã‚ã‚‹å ´åˆã€ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦å ±å‘Šã•ã‚Œã¾ã™ï¼ˆä»•æ§˜æ›¸11.2ï¼‰
              </div>
            </div>
          </div>

          <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-xl);">
            <button type="submit" class="btn btn-primary">ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹</button>
            <button type="button" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ã‚¸ãƒ§ãƒ–å±¥æ­´ã‚¿ãƒ– -->
    <div id="tab-jobs" class="tab-content card">
      <div class="card-header">
        <h2 class="card-title">ã‚¸ãƒ§ãƒ–å±¥æ­´</h2>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>ã‚¸ãƒ§ãƒ–ID</th>
                <th>ç¨®é¡</th>
                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th>é–‹å§‹æ—¥æ™‚</th>
                <th>å®Œäº†æ—¥æ™‚</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="6" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">
                  ã‚¸ãƒ§ãƒ–å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script src="../scripts/common.js"></script>
  <script>
    // ============================================
    // ãƒ¬ãƒãƒ¼ãƒˆ - APIé€£æº
    // ============================================

    let departments = [];
    let employees = [];
    let summaryData = [];
    let currentTab = 'summary';

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      await Promise.all([
        loadDepartments(),
        loadEmployees()
      ]);
      setupEventListeners();
      updateHeaderUserInfo();
      
      // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ã®åˆæœŸå€¤ã‚’è¨­å®šï¼ˆä»Šæœˆã®åˆæ—¥ã¨æœ«æ—¥ï¼‰
      const today = getCurrentTime();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      
      const startDateInput = document.getElementById('summary-start-date');
      const endDateInput = document.getElementById('summary-end-date');
      if (startDateInput) {
        startDateInput.value = formatDate(firstDay);
      }
      if (endDateInput) {
        endDateInput.value = formatDate(lastDay);
      }
    });

    // éƒ¨ç½²ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadDepartments() {
      try {
        const response = await apiFetch(`${API_BASE_URL}/departments`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          departments = data.data.items || data.data || [];
          
          // é›†è¨ˆã‚¿ãƒ–ã®éƒ¨ç½²ã‚»ãƒ¬ã‚¯ãƒˆ
          const summaryDeptSelect = document.querySelector('#tab-summary .filter-bar select');
          if (summaryDeptSelect) {
            summaryDeptSelect.innerHTML = '<option value="">ã™ã¹ã¦</option>';
            departments.forEach(dept => {
              const option = document.createElement('option');
              option.value = dept.id;
              option.textContent = dept.name;
              summaryDeptSelect.appendChild(option);
            });
          }
          
          // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¿ãƒ–ã®éƒ¨ç½²ã‚»ãƒ¬ã‚¯ãƒˆ
          const exportDeptSelect = document.getElementById('export-department');
          if (exportDeptSelect) {
            exportDeptSelect.innerHTML = '<option value="">ã™ã¹ã¦</option>';
            departments.forEach(dept => {
              const option = document.createElement('option');
              option.value = dept.id;
              option.textContent = dept.name;
              exportDeptSelect.appendChild(option);
            });
          }
        }
      } catch (error) {
        console.error('éƒ¨ç½²ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // å¾“æ¥­å“¡ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadEmployees() {
      try {
        const response = await apiFetch(`${API_BASE_URL}/employees?limit=1000`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          employees = data.data.items || [];
        }
      } catch (error) {
        console.error('å¾“æ¥­å“¡ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    function setupEventListeners() {
      // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab-link').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const tab = this.getAttribute('href');
          if (tab.startsWith('#')) {
            currentTab = tab.substring(1).replace('tab-', '');
            
            document.querySelectorAll('.tab-content').forEach(content => {
              content.style.display = 'none';
            });
            const targetTab = document.getElementById(tab.substring(1));
            if (targetTab) {
              targetTab.style.display = 'block';
            }
            
            document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
            this.classList.add('active');
          }
        });
      });

      // é›†è¨ˆå®Ÿè¡Œãƒœã‚¿ãƒ³
      const summaryButton = document.querySelector('#tab-summary .filter-bar button');
      if (summaryButton) {
        summaryButton.addEventListener('click', async function() {
          await loadSummary();
        });
      }

      // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ 
      const exportForm = document.querySelector('#tab-export form');
      if (exportForm) {
        exportForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          await exportCSV();
        });
      }

      // ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ 
      const importForm = document.querySelector('#tab-import form');
      if (importForm) {
        importForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          await importCSV();
        });
      }

      // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç¨®é¡ã«å¿œã˜ã¦ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
      const exportTypeSelect = document.getElementById('export-type');
      const exportHelp = document.getElementById('export-help');

      if (exportTypeSelect && exportHelp) {
        exportTypeSelect.addEventListener('change', function() {
          if (this.value === 'attendance') {
            exportHelp.style.display = 'block';
          } else {
            exportHelp.style.display = 'none';
          }
        });
      }

      // ã‚¤ãƒ³ãƒãƒ¼ãƒˆç¨®é¡ã«å¿œã˜ã¦ä»•æ§˜ã‚’è¡¨ç¤º
      const importTypeSelect = document.getElementById('import-type');
      const importSpecEmployees = document.getElementById('import-spec-employees');
      const importSpecPunches = document.getElementById('import-spec-punches');
      const importHelp = document.getElementById('import-help');

      if (importTypeSelect) {
        importTypeSelect.addEventListener('change', function() {
          if (this.value === 'employees') {
            if (importSpecEmployees) importSpecEmployees.style.display = 'block';
            if (importSpecPunches) importSpecPunches.style.display = 'none';
            if (importHelp) importHelp.textContent = 'å¾“æ¥­å“¡ã‚¤ãƒ³ãƒãƒ¼ãƒˆ: UTF-8ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„';
          } else if (this.value === 'punches') {
            if (importSpecEmployees) importSpecEmployees.style.display = 'none';
            if (importSpecPunches) importSpecPunches.style.display = 'block';
            if (importHelp) importHelp.textContent = 'æ‰“åˆ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ: UTF-8ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚typeã¯ in|out|break_in|break_out ã®ã„ãšã‚Œã‹';
          } else {
            if (importSpecEmployees) importSpecEmployees.style.display = 'none';
            if (importSpecPunches) importSpecPunches.style.display = 'none';
            if (importHelp) importHelp.textContent = 'CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚æ–‡å­—ã‚³ãƒ¼ãƒ‰: UTF-8ã€æ—¥ä»˜å½¢å¼: ISO8601';
          }
        });
      }
    }

    // é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
    async function loadSummary() {
      const periodType = document.querySelector('#tab-summary .filter-bar select').value;
      const startDate = document.getElementById('summary-start-date').value;
      const endDate = document.getElementById('summary-end-date').value;
      const deptId = document.querySelectorAll('#tab-summary .filter-bar select')[1].value;

      if (!startDate || !endDate) {
        alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        let url = `${API_BASE_URL}/reports/summary?period_type=${periodType}&start_date=${startDate}&end_date=${endDate}`;
        if (deptId) {
          url += `&dept_id=${deptId}`;
        }

        const response = await apiFetch(url);
        const data = await response.json();

        if (response.ok && data.success) {
          summaryData = data.data || [];
          renderSummary();
        } else {
          console.error('é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', data);
          alert('é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        console.error('é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // é›†è¨ˆçµæœã‚’æç”»
    function renderSummary() {
      const tbody = document.querySelector('#tab-summary .table tbody');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (summaryData.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="9" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td>';
        tbody.appendChild(row);
        return;
      }

      summaryData.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.employee_name || '-'}</td>
          <td>${item.department_name || '-'}</td>
          <td>${item.work_hours || 0}h</td>
          <td>${item.scheduled_hours || 0}h</td>
          <td>${item.overtime_hours || 0}h</td>
          <td>${item.night_work_hours || 0}h</td>
          <td>${item.holiday_work_hours || 0}h</td>
          <td>${item.late_count || 0}å›</td>
          <td>${item.early_leave_count || 0}å›</td>
        `;
        tbody.appendChild(row);
      });
    }

    // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    async function exportCSV() {
      const exportType = document.getElementById('export-type').value;
      const startDate = document.getElementById('export-period-start').value;
      const endDate = document.getElementById('export-period-end').value;
      const deptId = document.getElementById('export-department').value;

      if (!exportType) {
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      try {
        let csvContent = '';
        let filename = '';

        if (exportType === 'employees') {
          // å¾“æ¥­å“¡ä¸€è¦§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          const headers = ['employee_code', 'name', 'email', 'dept_code', 'employment_type', 'hire_date', 'status'];
          csvContent = headers.join(',') + '\n';
          
          let filteredEmployees = employees;
          if (deptId) {
            filteredEmployees = employees.filter(emp => emp.dept_id === deptId);
          }

          filteredEmployees.forEach(emp => {
            const dept = departments.find(d => d.id === emp.dept_id);
            const row = [
              emp.employee_code || '',
              emp.name || '',
              emp.email || '',
              dept ? (dept.code || '') : '',
              emp.employment_type || '',
              emp.hire_date || '',
              emp.status || ''
            ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(',');
            csvContent += row + '\n';
          });

          filename = `employees_${new Date().toISOString().split('T')[0]}.csv`;

        } else if (exportType === 'attendance') {
          // å‹¤æ€ æ˜ç´°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          if (!startDate || !endDate) {
            alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
          }

          let url = `${API_BASE_URL}/reports/export/attendance?start_date=${startDate}&end_date=${endDate}`;
          if (deptId) {
            url += `&dept_id=${deptId}`;
          }

          const response = await apiFetch(url);
          const data = await response.json();

          if (!response.ok || !data.success) {
            alert('å‹¤æ€ æ˜ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            return;
          }

          const records = data.data || [];
          const headers = ['employee_code', 'date', 'clock_in', 'clock_out', 'break_minutes', 'work_minutes', 'overtime_minutes', 'late', 'early_leave'];
          csvContent = headers.join(',') + '\n';

          records.forEach(record => {
            const row = [
              record.employee_code || '',
              record.date || '',
              record.clock_in || '',
              record.clock_out || '',
              record.break_minutes || 0,
              record.work_minutes || 0,
              record.overtime_minutes || 0,
              record.late || 0,
              record.early_leave || 0
            ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(',');
            csvContent += row + '\n';
          });

          filename = `attendance_${startDate}_${endDate}.csv`;

        } else if (exportType === 'summary') {
          // é›†è¨ˆçµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          if (!startDate || !endDate) {
            alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
          }

          await loadSummary();
          
          const headers = ['employee_code', 'employee_name', 'department_name', 'work_hours', 'scheduled_hours', 'overtime_hours', 'night_work_hours', 'holiday_work_hours', 'late_count', 'early_leave_count'];
          csvContent = headers.join(',') + '\n';

          summaryData.forEach(item => {
            const row = [
              item.employee_code || '',
              item.employee_name || '',
              item.department_name || '',
              item.work_hours || 0,
              item.scheduled_hours || 0,
              item.overtime_hours || 0,
              item.night_work_hours || 0,
              item.holiday_work_hours || 0,
              item.late_count || 0,
              item.early_leave_count || 0
            ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(',');
            csvContent += row + '\n';
          });

          filename = `summary_${startDate}_${endDate}.csv`;

        } else if (exportType === 'punches') {
          // æ‰“åˆ»åŸç¥¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          if (!startDate || !endDate) {
            alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
          }

          let url = `${API_BASE_URL}/punches?from=${startDate} 00:00:00&to=${endDate} 23:59:59&limit=10000`;
          const response = await apiFetch(url);
          const data = await response.json();

          if (!response.ok || !data.success) {
            alert('æ‰“åˆ»ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            return;
          }

          const punches = data.data.items || [];
          const headers = ['employee_code', 'type', 'occurred_at', 'source', 'device', 'note'];
          csvContent = headers.join(',') + '\n';

          punches.forEach(punch => {
            const employee = employees.find(e => e.id === punch.employee_id);
            const row = [
              employee ? employee.employee_code : '',
              punch.type || '',
              punch.occurred_at || '',
              punch.source || '',
              punch.device || '',
              punch.note || ''
            ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(',');
            csvContent += row + '\n';
          });

          filename = `punches_${startDate}_${endDate}.csv`;
        }

        // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');

      } catch (error) {
        console.error('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        alert('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆæ‰“åˆ»ï¼‰
    async function importCSV() {
      const importType = document.getElementById('import-type').value;
      const fileInput = document.getElementById('import-file');
      const skipDuplicates = document.querySelector('input[name="skip-duplicate-punches"]')?.checked || false;

      if (!importType) {
        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      if (!fileInput.files || fileInput.files.length === 0) {
        alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      if (importType === 'employees') {
        // å¾“æ¥­å“¡ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯æ—¢ã«employees.htmlã§å®Ÿè£…æ¸ˆã¿
        alert('å¾“æ¥­å“¡ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯å¾“æ¥­å“¡ç®¡ç†ãƒšãƒ¼ã‚¸ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„');
        return;
      }

      if (importType === 'punches') {
        // æ‰“åˆ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const file = fileInput.files[0];
        const text = await file.text();
        
        const lines = text.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
          alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã‹ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã¿ã§ã™');
          return;
        }

        // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å–å¾—
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        const requiredHeaders = ['employee_code', 'type', 'occurred_at', 'source'];
        
        for (const header of requiredHeaders) {
          if (!headers.includes(header)) {
            alert(`å¿…é ˆãƒ˜ãƒƒãƒ€ãƒ¼ "${header}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
            return;
          }
        }

        const results = {
          success: 0,
          failed: 0,
          errors: []
        };

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
          const row = {};
          headers.forEach((header, index) => {
            row[header] = values[index] || '';
          });

          try {
            // å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å¾“æ¥­å“¡IDã‚’å–å¾—
            const employee = employees.find(e => e.employee_code === row.employee_code);
            if (!employee) {
              results.failed++;
              results.errors.push(`è¡Œ ${i + 1}: å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰ "${row.employee_code}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
              continue;
            }

            const requestData = {
              type: row.type,
              occurred_at: row.occurred_at,
              source: row.source || 'csv_import',
              device: row.device || null,
              note: row.note || null
            };

            const response = await apiFetch(`${API_BASE_URL}/punches`, {
              method: 'POST',
              body: JSON.stringify(requestData)
            });

            const data = await response.json();

            if (response.ok && data.success) {
              results.success++;
            } else {
              if (skipDuplicates && data.error?.code === 'CONFLICT') {
                results.success++;
              } else {
                results.failed++;
                results.errors.push(`è¡Œ ${i + 1}: ${data.error?.message || 'ã‚¨ãƒ©ãƒ¼'}`);
              }
            }
          } catch (error) {
            results.failed++;
            results.errors.push(`è¡Œ ${i + 1}: ${error.message}`);
          }
        }

        // çµæœã‚’è¡¨ç¤º
        let message = `ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†\næˆåŠŸ: ${results.success}ä»¶\nå¤±æ•—: ${results.failed}ä»¶`;
        if (results.errors.length > 0 && results.errors.length <= 10) {
          message += '\n\nã‚¨ãƒ©ãƒ¼è©³ç´°:\n' + results.errors.join('\n');
        } else if (results.errors.length > 10) {
          message += `\n\nï¼ˆã‚¨ãƒ©ãƒ¼ãŒ${results.errors.length}ä»¶ã‚ã‚Šã¾ã™ï¼‰`;
        }
        alert(message);

        if (results.success > 0) {
          fileInput.value = '';
        }
      }
    }
  </script>
</body>
</html>

