<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç›£æŸ»ãƒ­ã‚° - å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="../styles/common.css">
  <link rel="stylesheet" href="../styles/components.css">
  <link rel="stylesheet" href="../styles/layout.css">
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="../dashboard.html" class="header-logo">å‹¤æ€ ç®¡ç†</a>
        <nav class="header-nav">
          <a href="../dashboard.html" class="header-nav-link">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
          <a href="punch.html" class="header-nav-link">æ‰“åˆ»</a>
          <a href="gantt.html" class="header-nav-link">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</a>
          <a href="reports.html" class="header-nav-link">ãƒ¬ãƒãƒ¼ãƒˆ</a>
        </nav>
      </div>
      <div class="header-right">
        <a href="requests.html" class="header-nav-link">ç”³è«‹</a>
        <button onclick="logout()" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-sm);">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <a href="profile.html" class="header-user" style="text-decoration: none;">
          <div class="header-user-avatar"></div>
          <span class="header-user-name"></span>
        </a>
      </div>
    </div>
  </header>

  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li class="sidebar-menu-item">
        <a href="../dashboard.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“Š</span>
          <span class="sidebar-menu-label">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="punch.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">â°</span>
          <span class="sidebar-menu-label">æ‰“åˆ»</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="gantt.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“…</span>
          <span class="sidebar-menu-label">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="requests.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“</span>
          <span class="sidebar-menu-label">ç”³è«‹ãƒ»æ‰¿èª</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="employees.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ‘¥</span>
          <span class="sidebar-menu-label">å¾“æ¥­å“¡ç®¡ç†</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="company-settings.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">âš™ï¸</span>
          <span class="sidebar-menu-label">ä¼æ¥­è¨­å®š</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="reports.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“ˆ</span>
          <span class="sidebar-menu-label">ãƒ¬ãƒãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="payslip.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ’°</span>
          <span class="sidebar-menu-label">çµ¦ä¸æ˜ç´°</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="audit-logs.html" class="sidebar-menu-link active">
          <span class="sidebar-menu-icon">ğŸ”</span>
          <span class="sidebar-menu-label">ç›£æŸ»ãƒ­ã‚°</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-content">
    <div class="page-header">
      <h1 class="page-title">ç›£æŸ»ãƒ­ã‚°</h1>
      <p class="page-description">ã‚·ã‚¹ãƒ†ãƒ å†…ã®é‡è¦ãªæ“ä½œå±¥æ­´ã‚’ç¢ºèªã§ãã¾ã™</p>
      <div class="page-actions">
        <button class="btn btn-secondary" onclick="exportAuditLogs()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      </div>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒãƒ¼ -->
    <div class="filter-bar">
      <div class="filter-group">
        <label class="filter-label">æ“ä½œç¨®åˆ¥:</label>
        <select id="filter-action" class="form-select filter-input">
          <option value="">ã™ã¹ã¦</option>
          <option value="create">ä½œæˆ</option>
          <option value="update">æ›´æ–°</option>
          <option value="delete">å‰Šé™¤</option>
          <option value="approve">æ‰¿èª</option>
          <option value="reject">å·®æˆ»ã—</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£:</label>
        <select id="filter-entity" class="form-select filter-input">
          <option value="">ã™ã¹ã¦</option>
          <option value="employee">å¾“æ¥­å“¡</option>
          <option value="punch">æ‰“åˆ»</option>
          <option value="request">ç”³è«‹</option>
          <option value="department">éƒ¨ç½²</option>
          <option value="tenant">ãƒ†ãƒŠãƒ³ãƒˆ</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">å®Ÿè¡Œè€…:</label>
        <input type="text" id="filter-actor" class="form-input filter-input" placeholder="æ¤œç´¢...">
      </div>
      <div class="filter-group">
        <label class="filter-label">é–‹å§‹æ—¥:</label>
        <input type="date" id="filter-start-date" class="form-input filter-input">
      </div>
      <div class="filter-group">
        <label class="filter-label">çµ‚äº†æ—¥:</label>
        <input type="date" id="filter-end-date" class="form-input filter-input">
      </div>
      <div class="filter-group">
        <button class="btn btn-secondary" onclick="applyFilters()">ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨</button>
      </div>
    </div>

    <!-- ç›£æŸ»ãƒ­ã‚°ä¸€è¦§ -->
    <div class="card">
      <div class="card-body">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>æ—¥æ™‚</th>
                <th>å®Ÿè¡Œè€…</th>
                <th>æ“ä½œ</th>
                <th>ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£</th>
                <th>ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ID</th>
                <th>å¤‰æ›´å‰</th>
                <th>å¤‰æ›´å¾Œ</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="8" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">
                  ç›£æŸ»ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="pagination" id="audit-log-pagination">
        </div>
      </div>
    </div>

    <!-- ç›£æŸ»ãƒ­ã‚°è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal-audit-detail" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ç›£æŸ»ãƒ­ã‚°è©³ç´°</h2>
          <a href="#" class="modal-close">&times;</a>
        </div>
        <div class="modal-body" id="audit-detail-body">
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-secondary modal-close">é–‰ã˜ã‚‹</a>
        </div>
      </div>
    </div>
  </main>
  <script src="../scripts/common.js"></script>
  <script>
    // ============================================
    // ç›£æŸ»ãƒ­ã‚° - APIé€£æº
    // ============================================

    let auditLogs = [];
    let currentPage = 1;
    let totalPages = 1;
    let filters = {
      action: '',
      entity: '',
      actor: '',
      start_date: '',
      end_date: ''
    };

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      setupEventListeners();
      updateHeaderUserInfo();
      
      // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ã®åˆæœŸå€¤ã‚’è¨­å®šï¼ˆéå»30æ—¥ï¼‰
      const today = getCurrentTime();
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 30);
      
      const startDateInput = document.getElementById('filter-start-date');
      const endDateInput = document.getElementById('filter-end-date');
      if (startDateInput) {
        startDateInput.value = formatDate(thirtyDaysAgo);
      }
      if (endDateInput) {
        endDateInput.value = formatDate(today);
      }
      
      await loadAuditLogs();
    });

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    function setupEventListeners() {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      document.querySelectorAll('.modal-close').forEach(closeBtn => {
        closeBtn.addEventListener('click', function(e) {
          e.preventDefault();
          const modal = this.closest('.modal');
          if (modal) {
            modal.style.display = 'none';
          }
        });
      });

      // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            this.style.display = 'none';
          }
        });
      });
    }

    // ç›£æŸ»ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿
    async function loadAuditLogs(page = 1) {
      try {
        let url = `${API_BASE_URL}/audit-logs?page=${page}&limit=50`;
        
        if (filters.action) {
          url += `&action=${encodeURIComponent(filters.action)}`;
        }
        if (filters.entity) {
          url += `&entity=${encodeURIComponent(filters.entity)}`;
        }
        if (filters.actor) {
          // å®Ÿè¡Œè€…åã§æ¤œç´¢ï¼ˆAPIå´ã§å¯¾å¿œãŒå¿…è¦ãªå ´åˆã¯åˆ¥é€”å®Ÿè£…ï¼‰
          // ç¾æ™‚ç‚¹ã§ã¯actor_user_idã§æ¤œç´¢ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€å®Ÿè¡Œè€…åæ¤œç´¢ã¯ã‚¹ã‚­ãƒƒãƒ—
        }
        if (filters.start_date) {
          url += `&start_date=${filters.start_date}`;
        }
        if (filters.end_date) {
          url += `&end_date=${filters.end_date}`;
        }

        const response = await apiFetch(url);
        const data = await response.json();

        if (response.ok && data.success) {
          auditLogs = data.data.items || [];
          currentPage = data.data.page || 1;
          totalPages = data.data.total_pages || 1;
          renderAuditLogs();
          renderPagination();
        } else {
          console.error('ç›£æŸ»ãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', data);
          if (data.error?.code === 'FORBIDDEN') {
            alert('ç›£æŸ»ãƒ­ã‚°ã‚’é–²è¦§ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
          } else {
            alert('ç›£æŸ»ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
          }
        }
      } catch (error) {
        console.error('ç›£æŸ»ãƒ­ã‚°ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ç›£æŸ»ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ç›£æŸ»ãƒ­ã‚°ä¸€è¦§ã‚’æç”»
    function renderAuditLogs() {
      const tbody = document.querySelector('.table tbody');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (auditLogs.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="8" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">ç›£æŸ»ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</td>';
        tbody.appendChild(row);
        return;
      }

      auditLogs.forEach(log => {
        const row = document.createElement('tr');
        
        const occurredAt = new Date(log.occurred_at);
        const dateStr = occurredAt.toLocaleString('ja-JP');
        
        const actorName = log.actor_employee_name || log.actor_user_name || 'ä¸æ˜';
        const actorCode = log.actor_employee_code ? ` (${log.actor_employee_code})` : '';
        
        // æ“ä½œãƒãƒƒã‚¸
        const actionBadges = {
          'create': '<span class="badge badge-primary">ä½œæˆ</span>',
          'update': '<span class="badge badge-warning">æ›´æ–°</span>',
          'delete': '<span class="badge badge-error">å‰Šé™¤</span>',
          'approve': '<span class="badge badge-success">æ‰¿èª</span>',
          'reject': '<span class="badge badge-error">å·®æˆ»ã—</span>',
          'invite': '<span class="badge badge-info">æ‹›å¾…</span>',
          'proxy': '<span class="badge badge-warning">ä»£ç†</span>'
        };
        const actionBadge = actionBadges[log.action.split('.')[1]] || `<span class="badge badge-secondary">${log.action}</span>`;
        
        // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ©ãƒ™ãƒ«
        const entityLabels = {
          'employee': 'å¾“æ¥­å“¡',
          'punch': 'æ‰“åˆ»',
          'request': 'ç”³è«‹',
          'department': 'éƒ¨ç½²',
          'tenant': 'ãƒ†ãƒŠãƒ³ãƒˆ',
          'rule_set': 'å°±æ¥­ãƒ«ãƒ¼ãƒ«',
          'holiday': 'ç¥æ—¥'
        };
        const entityLabel = entityLabels[log.entity] || log.entity;
        
        // å¤‰æ›´å‰ãƒ»å¤‰æ›´å¾Œã®ç°¡æ˜“è¡¨ç¤º
        const beforeStr = log.before ? JSON.stringify(log.before).substring(0, 50) + '...' : '-';
        const afterStr = log.after ? JSON.stringify(log.after).substring(0, 50) + '...' : '-';

        row.innerHTML = `
          <td>${dateStr}</td>
          <td>${actorName}${actorCode}</td>
          <td>${actionBadge}</td>
          <td>${entityLabel}</td>
          <td>${log.entity_id ? log.entity_id.substring(0, 8) + '...' : '-'}</td>
          <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${beforeStr}</td>
          <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${afterStr}</td>
          <td>
            <button onclick="showAuditLogDetail('${log.id}')" class="btn btn-sm btn-secondary">è©³ç´°</button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’æç”»
    function renderPagination() {
      const pagination = document.getElementById('audit-log-pagination');
      if (!pagination) return;

      pagination.innerHTML = '';

      // å‰ã¸ãƒœã‚¿ãƒ³
      const prevLink = document.createElement('a');
      prevLink.href = '#';
      prevLink.className = 'pagination-link';
      prevLink.textContent = 'Â«';
      if (currentPage <= 1) {
        prevLink.style.pointerEvents = 'none';
        prevLink.style.opacity = '0.5';
      } else {
        prevLink.addEventListener('click', (e) => {
          e.preventDefault();
          loadAuditLogs(currentPage - 1);
        });
      }
      pagination.appendChild(prevLink);

      // ãƒšãƒ¼ã‚¸ç•ªå·
      for (let i = 1; i <= totalPages && i <= 10; i++) {
        const pageLink = document.createElement('a');
        pageLink.href = '#';
        pageLink.className = 'pagination-link';
        if (i === currentPage) {
          pageLink.classList.add('active');
        }
        pageLink.textContent = i;
        pageLink.addEventListener('click', (e) => {
          e.preventDefault();
          loadAuditLogs(i);
        });
        pagination.appendChild(pageLink);
      }

      // æ¬¡ã¸ãƒœã‚¿ãƒ³
      const nextLink = document.createElement('a');
      nextLink.href = '#';
      nextLink.className = 'pagination-link';
      nextLink.textContent = 'Â»';
      if (currentPage >= totalPages) {
        nextLink.style.pointerEvents = 'none';
        nextLink.style.opacity = '0.5';
      } else {
        nextLink.addEventListener('click', (e) => {
          e.preventDefault();
          loadAuditLogs(currentPage + 1);
        });
      }
      pagination.appendChild(nextLink);
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
    function applyFilters() {
      filters.action = document.getElementById('filter-action').value;
      filters.entity = document.getElementById('filter-entity').value;
      filters.actor = document.getElementById('filter-actor').value;
      filters.start_date = document.getElementById('filter-start-date').value;
      filters.end_date = document.getElementById('filter-end-date').value;
      
      loadAuditLogs(1);
    }

    // ç›£æŸ»ãƒ­ã‚°è©³ç´°ã‚’è¡¨ç¤º
    async function showAuditLogDetail(logId) {
      try {
        const response = await apiFetch(`${API_BASE_URL}/audit-logs/${logId}`);
        const data = await response.json();

        if (response.ok && data.success) {
          const log = data.data;
          renderAuditLogDetail(log);
          
          const modal = document.getElementById('modal-audit-detail');
          if (modal) {
            modal.style.display = 'block';
          }
        } else {
          console.error('ç›£æŸ»ãƒ­ã‚°è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', data);
          alert('ç›£æŸ»ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        console.error('ç›£æŸ»ãƒ­ã‚°è©³ç´°ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ç›£æŸ»ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ç›£æŸ»ãƒ­ã‚°è©³ç´°ã‚’æç”»
    function renderAuditLogDetail(log) {
      const body = document.getElementById('audit-detail-body');
      if (!body) return;

      const occurredAt = new Date(log.occurred_at);
      const dateStr = occurredAt.toLocaleString('ja-JP');
      
      const actorName = log.actor_employee_name || log.actor_user_name || 'ä¸æ˜';
      const actorCode = log.actor_employee_code ? ` (${log.actor_employee_code})` : '';
      const actorEmail = log.actor_user_email ? ` (${log.actor_user_email})` : '';
      
      // æ“ä½œãƒãƒƒã‚¸
      const actionBadges = {
        'create': '<span class="badge badge-primary">ä½œæˆ</span>',
        'update': '<span class="badge badge-warning">æ›´æ–°</span>',
        'delete': '<span class="badge badge-error">å‰Šé™¤</span>',
        'approve': '<span class="badge badge-success">æ‰¿èª</span>',
        'reject': '<span class="badge badge-error">å·®æˆ»ã—</span>',
        'invite': '<span class="badge badge-info">æ‹›å¾…</span>',
        'proxy': '<span class="badge badge-warning">ä»£ç†</span>'
      };
      const actionParts = log.action.split('.');
      const actionBadge = actionBadges[actionParts[1]] || `<span class="badge badge-secondary">${log.action}</span>`;
      
      // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ©ãƒ™ãƒ«
      const entityLabels = {
        'employee': 'å¾“æ¥­å“¡',
        'punch': 'æ‰“åˆ»',
        'request': 'ç”³è«‹',
        'department': 'éƒ¨ç½²',
        'tenant': 'ãƒ†ãƒŠãƒ³ãƒˆ',
        'rule_set': 'å°±æ¥­ãƒ«ãƒ¼ãƒ«',
        'holiday': 'ç¥æ—¥'
      };
      const entityLabel = entityLabels[log.entity] || log.entity;
      
      const beforeJson = log.before ? JSON.stringify(log.before, null, 2) : 'null';
      const afterJson = log.after ? JSON.stringify(log.after, null, 2) : 'null';

      body.innerHTML = `
        <div style="margin-bottom: var(--spacing-lg);">
          <div style="display: grid; grid-template-columns: 150px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
            <div style="font-weight: 600; color: var(--text-secondary);">æ—¥æ™‚:</div>
            <div>${dateStr}</div>
          </div>
          <div style="display: grid; grid-template-columns: 150px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
            <div style="font-weight: 600; color: var(--text-secondary);">å®Ÿè¡Œè€…:</div>
            <div>${actorName}${actorCode}${actorEmail}</div>
          </div>
          ${log.tenant_name ? `
          <div style="display: grid; grid-template-columns: 150px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
            <div style="font-weight: 600; color: var(--text-secondary);">ãƒ†ãƒŠãƒ³ãƒˆ:</div>
            <div>${log.tenant_name}</div>
          </div>
          ` : ''}
          <div style="display: grid; grid-template-columns: 150px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
            <div style="font-weight: 600; color: var(--text-secondary);">æ“ä½œ:</div>
            <div>${actionBadge}</div>
          </div>
          <div style="display: grid; grid-template-columns: 150px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
            <div style="font-weight: 600; color: var(--text-secondary);">ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£:</div>
            <div>${entityLabel}</div>
          </div>
          <div style="display: grid; grid-template-columns: 150px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
            <div style="font-weight: 600; color: var(--text-secondary);">ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ID:</div>
            <div>${log.entity_id || '-'}</div>
          </div>
          ${log.ip_address ? `
          <div style="display: grid; grid-template-columns: 150px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
            <div style="font-weight: 600; color: var(--text-secondary);">IPã‚¢ãƒ‰ãƒ¬ã‚¹:</div>
            <div>${log.ip_address}</div>
          </div>
          ` : ''}
          ${log.user_agent ? `
          <div style="display: grid; grid-template-columns: 150px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
            <div style="font-weight: 600; color: var(--text-secondary);">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:</div>
            <div style="font-size: var(--font-size-sm);">${log.user_agent}</div>
          </div>
          ` : ''}
          <div style="display: grid; grid-template-columns: 150px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
            <div style="font-weight: 600; color: var(--text-secondary);">å¤‰æ›´å‰:</div>
            <div style="font-family: monospace; font-size: var(--font-size-sm); background-color: var(--bg-tertiary); padding: var(--spacing-sm); border-radius: var(--border-radius); white-space: pre-wrap; word-break: break-all; max-height: 200px; overflow-y: auto;">${beforeJson}</div>
          </div>
          <div style="display: grid; grid-template-columns: 150px 1fr; gap: var(--spacing-md);">
            <div style="font-weight: 600; color: var(--text-secondary);">å¤‰æ›´å¾Œ:</div>
            <div style="font-family: monospace; font-size: var(--font-size-sm); background-color: var(--bg-tertiary); padding: var(--spacing-sm); border-radius: var(--border-radius); white-space: pre-wrap; word-break: break-all; max-height: 200px; overflow-y: auto;">${afterJson}</div>
          </div>
        </div>
      `;
    }

    // ç›£æŸ»ãƒ­ã‚°ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    async function exportAuditLogs() {
      try {
        // å…¨ä»¶å–å¾—ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ï¼‰
        let url = `${API_BASE_URL}/audit-logs?limit=10000`;
        
        if (filters.action) {
          url += `&action=${encodeURIComponent(filters.action)}`;
        }
        if (filters.entity) {
          url += `&entity=${encodeURIComponent(filters.entity)}`;
        }
        if (filters.start_date) {
          url += `&start_date=${filters.start_date}`;
        }
        if (filters.end_date) {
          url += `&end_date=${filters.end_date}`;
        }

        const response = await apiFetch(url);
        const data = await response.json();

        if (!response.ok || !data.success) {
          alert('ç›£æŸ»ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }

        const logs = data.data.items || [];
        
        if (logs.length === 0) {
          alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
          return;
        }

        // CSVãƒ˜ãƒƒãƒ€ãƒ¼
        const headers = ['æ—¥æ™‚', 'å®Ÿè¡Œè€…', 'æ“ä½œ', 'ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£', 'ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ID', 'å¤‰æ›´å‰', 'å¤‰æ›´å¾Œ', 'IPã‚¢ãƒ‰ãƒ¬ã‚¹', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ'];
        
        // CSVãƒ‡ãƒ¼ã‚¿è¡Œ
        const rows = logs.map(log => {
          const occurredAt = new Date(log.occurred_at);
          const dateStr = occurredAt.toLocaleString('ja-JP');
          const actorName = log.actor_employee_name || log.actor_user_name || 'ä¸æ˜';
          const beforeJson = log.before ? JSON.stringify(log.before) : '';
          const afterJson = log.after ? JSON.stringify(log.after) : '';
          
          return [
            dateStr,
            actorName,
            log.action,
            log.entity,
            log.entity_id || '',
            beforeJson,
            afterJson,
            log.ip_address || '',
            log.user_agent || ''
          ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(',');
        });

        // CSVæ–‡å­—åˆ—ã‚’ç”Ÿæˆ
        const csvContent = [headers.join(','), ...rows].join('\n');
        
        // BOMã‚’è¿½åŠ 
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
        
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const downloadUrl = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `audit_logs_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(downloadUrl);
      } catch (error) {
        console.error('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        alert('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.applyFilters = applyFilters;
    window.showAuditLogDetail = showAuditLogDetail;
    window.exportAuditLogs = exportAuditLogs;
  </script>
</body>
</html>

