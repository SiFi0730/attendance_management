<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰¿èª - å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="../styles/common.css">
  <link rel="stylesheet" href="../styles/components.css">
  <link rel="stylesheet" href="../styles/layout.css">
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="../dashboard.html" class="header-logo">å‹¤æ€ ç®¡ç†</a>
        <nav class="header-nav">
          <a href="../dashboard.html" class="header-nav-link">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
          <a href="punch.html" class="header-nav-link">æ‰“åˆ»</a>
          <a href="gantt.html" class="header-nav-link">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</a>
          <a href="reports.html" class="header-nav-link">ãƒ¬ãƒãƒ¼ãƒˆ</a>
        </nav>
      </div>
      <div class="header-right">
        <a href="requests.html" class="header-nav-link active" style="position: relative;">
          ç”³è«‹
          <span class="badge badge-error" style="position: absolute; top: -8px; right: -8px; font-size: 10px; padding: 2px 6px;">3</span>
        </a>
        <button onclick="logout()" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-sm);">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <a href="profile.html" class="header-user" style="text-decoration: none;">
          <div class="header-user-avatar"></div>
          <span class="header-user-name"></span>
        </a>
      </div>
    </div>
  </header>

  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li class="sidebar-menu-item">
        <a href="../dashboard.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“Š</span>
          <span class="sidebar-menu-label">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="punch.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">â°</span>
          <span class="sidebar-menu-label">æ‰“åˆ»</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="gantt.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“…</span>
          <span class="sidebar-menu-label">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="requests.html" class="sidebar-menu-link active">
          <span class="sidebar-menu-icon">ğŸ“</span>
          <span class="sidebar-menu-label">ç”³è«‹ãƒ»æ‰¿èª</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="employees.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ‘¥</span>
          <span class="sidebar-menu-label">å¾“æ¥­å“¡ç®¡ç†</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="company-settings.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">âš™ï¸</span>
          <span class="sidebar-menu-label">ä¼æ¥­è¨­å®š</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="reports.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“ˆ</span>
          <span class="sidebar-menu-label">ãƒ¬ãƒãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="payslip.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ’°</span>
          <span class="sidebar-menu-label">çµ¦ä¸æ˜ç´°</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="audit-logs.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ”</span>
          <span class="sidebar-menu-label">ç›£æŸ»ãƒ­ã‚°</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-content">
    <div class="page-header">
      <h1 class="page-title">æ‰¿èªã‚­ãƒ¥ãƒ¼</h1>
      <p class="page-description">æ‰¿èªå¾…ã¡ã®ç”³è«‹ã‚’ç¢ºèªãƒ»æ‰¿èªãƒ»å·®æˆ»ã—ã§ãã¾ã™</p>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒãƒ¼ -->
    <div class="filter-bar">
      <div class="filter-group">
        <label class="filter-label">ç”³è«‹ç¨®é¡:</label>
        <select class="form-select filter-input">
          <option value="">ã™ã¹ã¦</option>
          <option value="edit">ä¿®æ­£ç”³è«‹</option>
          <option value="overtime">æ®‹æ¥­ç”³è«‹</option>
          <option value="leave">ä¼‘æš‡ç”³è«‹</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">ç”³è«‹è€…:</label>
        <input type="text" class="form-input filter-input" placeholder="æ¤œç´¢...">
      </div>
      <div class="filter-group">
        <label class="filter-label">å¯¾è±¡æ—¥:</label>
        <input type="date" class="form-input filter-input">
      </div>
      <div class="filter-group">
        <button class="btn btn-secondary">ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨</button>
      </div>
    </div>

    <!-- æ‰¿èªå¾…ã¡ä¸€è¦§ -->
    <div class="card">
      <div class="card-body">
        <div class="table-container">
          <table class="table" id="approvals-table">
            <thead>
              <tr>
                <th>ç”³è«‹è€…</th>
                <th>ç”³è«‹ç¨®é¡</th>
                <th>å¯¾è±¡æ—¥</th>
                <th>ç”³è«‹å†…å®¹</th>
                <th>ç”³è«‹æ—¥æ™‚</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- æ‰¿èªè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal-approval-detail" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ç”³è«‹è©³ç´°</h2>
          <a href="#" class="modal-close">&times;</a>
        </div>
        <div class="modal-body">
          <div style="margin-bottom: var(--spacing-lg);">
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
              <div style="font-weight: 600; color: var(--text-secondary);">ç”³è«‹è€…:</div>
              <div>å±±ç”°å¤ªéƒ</div>
            </div>
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
              <div style="font-weight: 600; color: var(--text-secondary);">ç”³è«‹æ—¥:</div>
              <div>2025-01-15 10:30</div>
            </div>
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
              <div style="font-weight: 600; color: var(--text-secondary);">ç¨®é¡:</div>
              <div>ä¿®æ­£ç”³è«‹</div>
            </div>
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
              <div style="font-weight: 600; color: var(--text-secondary);">å¯¾è±¡æ—¥:</div>
              <div>2025-01-15</div>
            </div>
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
              <div style="font-weight: 600; color: var(--text-secondary);">ç”³è«‹å†…å®¹:</div>
              <div>å‡ºå‹¤æ™‚åˆ»ã®ä¿®æ­£ï¼ˆ09:00 â†’ 08:30ï¼‰</div>
            </div>
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
              <div style="font-weight: 600; color: var(--text-secondary);">ç”³è«‹ç†ç”±:</div>
              <div>é›»è»Šã®é…å»¶ã«ã‚ˆã‚Šå‡ºå‹¤æ™‚åˆ»ãŒé…ã‚Œã¾ã—ãŸã€‚å®Ÿéš›ã®å‡ºå‹¤æ™‚åˆ»ã¯8æ™‚30åˆ†ã§ã™ã€‚</div>
            </div>
          </div>

          <div class="form-group">
            <label for="approval-comment" class="form-label">æ‰¿èªã‚³ãƒ¡ãƒ³ãƒˆ</label>
            <textarea 
              id="approval-comment" 
              name="approval-comment" 
              class="form-textarea" 
              placeholder="æ‰¿èªãƒ»å·®æˆ»ã—ã®ç†ç”±ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-secondary modal-close">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
          <button class="btn btn-danger">å·®æˆ»ã—</button>
          <button class="btn btn-success">æ‰¿èª</button>
        </div>
      </div>
    </div>
  </main>
  
  <script src="../scripts/common.js"></script>
  <script>
    // ============================================
    // æ‰¿èªç®¡ç† - APIé€£æº
    // ============================================

    let pendingRequests = [];
    let currentRequestId = null;

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      await loadPendingRequests();
      setupEventListeners();
      updateHeaderUserInfo();
    });

    // æ‰¿èªå¾…ã¡ç”³è«‹ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadPendingRequests() {
      try {
        const response = await apiFetch(`${API_BASE_URL}/requests?status=pending&limit=1000`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          pendingRequests = data.data.items || [];
          renderPendingRequests();
        } else {
          console.error('æ‰¿èªå¾…ã¡ç”³è«‹ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', data);
          alert('æ‰¿èªå¾…ã¡ç”³è«‹ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('æ‰¿èªå¾…ã¡ç”³è«‹ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('æ‰¿èªå¾…ã¡ç”³è«‹ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // æ‰¿èªå¾…ã¡ç”³è«‹ã‚’æç”»
    function renderPendingRequests() {
      const tbody = document.querySelector('#approvals-table tbody');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (pendingRequests.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="6" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">æ‰¿èªå¾…ã¡ã®ç”³è«‹ãŒã‚ã‚Šã¾ã›ã‚“</td>';
        tbody.appendChild(row);
        return;
      }

      pendingRequests.forEach(request => {
        const row = document.createElement('tr');
        
        const typeLabels = {
          'edit': 'ä¿®æ­£ç”³è«‹',
          'overtime': 'æ®‹æ¥­ç”³è«‹',
          'leave': 'ä¼‘æš‡ç”³è«‹',
          'others': 'ãã®ä»–'
        };

        const createdDate = new Date(request.created_at);
        const createdDateStr = `${createdDate.getFullYear()}-${String(createdDate.getMonth() + 1).padStart(2, '0')}-${String(createdDate.getDate()).padStart(2, '0')} ${String(createdDate.getHours()).padStart(2, '0')}:${String(createdDate.getMinutes()).padStart(2, '0')}`;
        
        const payload = typeof request.payload === 'string' ? JSON.parse(request.payload) : request.payload;
        const content = payload.content || payload.description || 'ç”³è«‹å†…å®¹';

        row.innerHTML = `
          <td>${request.employee_name}</td>
          <td>${typeLabels[request.type] || request.type}</td>
          <td>${request.target_date}</td>
          <td>${content}</td>
          <td>${createdDateStr}</td>
          <td>
            <div style="display: flex; gap: var(--spacing-xs);">
              <button class="btn btn-sm btn-primary" onclick="showApprovalDetail('${request.id}')">è©³ç´°</button>
              <button class="btn btn-sm btn-success" onclick="approveRequest('${request.id}')">æ‰¿èª</button>
              <button class="btn btn-sm btn-danger" onclick="rejectRequest('${request.id}')">å·®æˆ»ã—</button>
            </div>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // æ‰¿èªè©³ç´°ã‚’è¡¨ç¤º
    async function showApprovalDetail(requestId) {
      try {
        const response = await apiFetch(`${API_BASE_URL}/requests/${requestId}`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          const request = data.data;
          const modal = document.getElementById('modal-approval-detail');
          if (!modal) return;

          currentRequestId = requestId;

          const typeLabels = {
            'edit': 'ä¿®æ­£ç”³è«‹',
            'overtime': 'æ®‹æ¥­ç”³è«‹',
            'leave': 'ä¼‘æš‡ç”³è«‹',
            'others': 'ãã®ä»–'
          };

          const createdDate = new Date(request.created_at);
          const createdDateStr = `${createdDate.getFullYear()}-${String(createdDate.getMonth() + 1).padStart(2, '0')}-${String(createdDate.getDate()).padStart(2, '0')} ${String(createdDate.getHours()).padStart(2, '0')}:${String(createdDate.getMinutes()).padStart(2, '0')}`;
          
          const payload = typeof request.payload === 'string' ? JSON.parse(request.payload) : request.payload;
          const content = payload.content || payload.description || 'ç”³è«‹å†…å®¹';

          modal.querySelector('.modal-body').innerHTML = `
            <div style="margin-bottom: var(--spacing-lg);">
              <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                <div style="font-weight: 600; color: var(--text-secondary);">ç”³è«‹è€…:</div>
                <div>${request.employee_name}</div>
              </div>
              <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                <div style="font-weight: 600; color: var(--text-secondary);">ç”³è«‹æ—¥:</div>
                <div>${createdDateStr}</div>
              </div>
              <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                <div style="font-weight: 600; color: var(--text-secondary);">ç¨®é¡:</div>
                <div>${typeLabels[request.type] || request.type}</div>
              </div>
              <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                <div style="font-weight: 600; color: var(--text-secondary);">å¯¾è±¡æ—¥:</div>
                <div>${request.target_date}</div>
              </div>
              <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                <div style="font-weight: 600; color: var(--text-secondary);">ç”³è«‹å†…å®¹:</div>
                <div>${content}</div>
              </div>
              <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                <div style="font-weight: 600; color: var(--text-secondary);">ç”³è«‹ç†ç”±:</div>
                <div>${request.reason}</div>
              </div>
            </div>

            <div class="form-group">
              <label for="approval-comment" class="form-label">æ‰¿èªã‚³ãƒ¡ãƒ³ãƒˆ</label>
              <textarea 
                id="approval-comment" 
                name="approval-comment" 
                class="form-textarea" 
                placeholder="æ‰¿èªãƒ»å·®æˆ»ã—ã®ç†ç”±ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰"
              ></textarea>
            </div>
          `;

          modal.style.display = 'block';
        } else {
          alert('ç”³è«‹è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('ç”³è«‹è©³ç´°ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        alert('ç”³è«‹è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ç”³è«‹ã‚’æ‰¿èª
    async function approveRequest(requestId) {
      if (!confirm('ã“ã®ç”³è«‹ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      try {
        const comment = document.getElementById('approval-comment')?.value || '';
        
        const response = await apiFetch(`${API_BASE_URL}/requests/${requestId}/approve`, {
          method: 'POST',
          body: JSON.stringify({
            comment: comment
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          alert('ç”³è«‹ã‚’æ‰¿èªã—ã¾ã—ãŸ');
          document.getElementById('modal-approval-detail').style.display = 'none';
          await loadPendingRequests();
        } else {
          alert('ç”³è«‹ã®æ‰¿èªã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        console.error('ç”³è«‹æ‰¿èªã‚¨ãƒ©ãƒ¼:', error);
        alert('ç”³è«‹ã®æ‰¿èªã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ç”³è«‹ã‚’å·®æˆ»ã—
    async function rejectRequest(requestId) {
      const rejectionReason = prompt('å·®æˆ»ã—ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!rejectionReason) {
        return;
      }

      if (!confirm('ã“ã®ç”³è«‹ã‚’å·®æˆ»ã—ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      try {
        const response = await apiFetch(`${API_BASE_URL}/requests/${requestId}/reject`, {
          method: 'POST',
          body: JSON.stringify({
            rejection_reason: rejectionReason
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          alert('ç”³è«‹ã‚’å·®æˆ»ã—ã—ã¾ã—ãŸ');
          document.getElementById('modal-approval-detail').style.display = 'none';
          await loadPendingRequests();
        } else {
          alert('ç”³è«‹ã®å·®æˆ»ã—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        console.error('ç”³è«‹å·®æˆ»ã—ã‚¨ãƒ©ãƒ¼:', error);
        alert('ç”³è«‹ã®å·®æˆ»ã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    function setupEventListeners() {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      document.querySelectorAll('.modal-close').forEach(closeBtn => {
        closeBtn.addEventListener('click', function(e) {
          e.preventDefault();
          this.closest('.modal').style.display = 'none';
        });
      });

      // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            this.style.display = 'none';
          }
        });
      });

      // æ‰¿èªè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒœã‚¿ãƒ³
      const modal = document.getElementById('modal-approval-detail');
      if (modal) {
        const approveBtn = modal.querySelector('.btn-success');
        const rejectBtn = modal.querySelector('.btn-danger');
        
        if (approveBtn) {
          approveBtn.addEventListener('click', function() {
            if (currentRequestId) {
              approveRequest(currentRequestId);
            }
          });
        }
        
        if (rejectBtn) {
          rejectBtn.addEventListener('click', function() {
            if (currentRequestId) {
              rejectRequest(currentRequestId);
            }
          });
        }
      }
    }
  </script>
</body>
</html>

