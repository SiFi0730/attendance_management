<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”³è«‹ - å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="../styles/common.css">
  <link rel="stylesheet" href="../styles/components.css">
  <link rel="stylesheet" href="../styles/layout.css">
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="../dashboard.html" class="header-logo">å‹¤æ€ ç®¡ç†</a>
        <nav class="header-nav">
          <a href="../dashboard.html" class="header-nav-link">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
          <a href="punch.html" class="header-nav-link">æ‰“åˆ»</a>
          <a href="gantt.html" class="header-nav-link">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</a>
          <a href="reports.html" class="header-nav-link">ãƒ¬ãƒãƒ¼ãƒˆ</a>
        </nav>
      </div>
      <div class="header-right">
        <a href="requests.html" class="header-nav-link active" style="position: relative;">
          ç”³è«‹
          <span class="badge badge-error" style="position: absolute; top: -8px; right: -8px; font-size: 10px; padding: 2px 6px;">3</span>
        </a>
        <button id="time-mode-button" onclick="showTimeModeModal()" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-sm);">ç¾å®Ÿæ™‚é–“</button>
        <button onclick="logout()" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-sm);">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <a href="profile.html" class="header-user" style="text-decoration: none;">
          <div class="header-user-avatar"></div>
          <span class="header-user-name"></span>
        </a>
      </div>
    </div>
  </header>

  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li class="sidebar-menu-item">
        <a href="../dashboard.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“Š</span>
          <span class="sidebar-menu-label">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="punch.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">â°</span>
          <span class="sidebar-menu-label">æ‰“åˆ»</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="gantt.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“…</span>
          <span class="sidebar-menu-label">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="requests.html" class="sidebar-menu-link active">
          <span class="sidebar-menu-icon">ğŸ“</span>
          <span class="sidebar-menu-label">ç”³è«‹ãƒ»æ‰¿èª</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="employees.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ‘¥</span>
          <span class="sidebar-menu-label">å¾“æ¥­å“¡ç®¡ç†</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="company-settings.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">âš™ï¸</span>
          <span class="sidebar-menu-label">ä¼æ¥­è¨­å®š</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="reports.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“ˆ</span>
          <span class="sidebar-menu-label">ãƒ¬ãƒãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="payslip.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ’°</span>
          <span class="sidebar-menu-label">çµ¦ä¸æ˜ç´°</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="audit-logs.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ”</span>
          <span class="sidebar-menu-label">ç›£æŸ»ãƒ­ã‚°</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-content">
    <div class="page-header">
      <h1 class="page-title">ç”³è«‹</h1>
      <p class="page-description">å‹¤æ€ ã®ä¿®æ­£ç”³è«‹ã‚’è¡Œã„ã¾ã™</p>
      <div class="page-actions">
        <a href="#modal-new-request" class="btn btn-primary">æ–°è¦ç”³è«‹</a>
      </div>
    </div>

    <!-- ã‚¿ãƒ– -->
    <div class="tabs">
      <ul class="tab-list">
        <li class="tab-item"><a href="#tab-all" class="tab-link">ã™ã¹ã¦</a></li>
        <li class="tab-item"><a href="#tab-pending" class="tab-link">ç”³è«‹ä¸­</a></li>
        <li class="tab-item"><a href="#tab-approved" class="tab-link">æ‰¿èªæ¸ˆã¿</a></li>
        <li class="tab-item"><a href="#tab-rejected" class="tab-link">å·®æˆ»ã—</a></li>
      </ul>
    </div>

    <!-- ã™ã¹ã¦ã®ç”³è«‹ -->
    <div id="tab-all" class="tab-content">
      <div class="card">
      <div class="card-body">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>ç”³è«‹æ—¥</th>
                <th>ç¨®é¡</th>
                <th>å¯¾è±¡æ—¥</th>
                <th>ç”³è«‹å†…å®¹</th>
                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th>æ‰¿èªè€…</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>2025-01-15 10:30</td>
                <td>ä¿®æ­£ç”³è«‹</td>
                <td>2025-01-15</td>
                <td>å‡ºå‹¤æ™‚åˆ»ã®ä¿®æ­£ï¼ˆ09:00 â†’ 08:30ï¼‰</td>
                <td><span class="badge badge-warning">ç”³è«‹ä¸­</span></td>
                <td>ç”°ä¸­ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</td>
                <td>
                  <a href="#modal-request-detail" class="btn btn-sm btn-secondary">è©³ç´°</a>
                </td>
              </tr>
              <tr>
                <td>2025-01-14 19:15</td>
                <td>ä¿®æ­£ç”³è«‹</td>
                <td>2025-01-14</td>
                <td>é€€å‹¤æ™‚åˆ»ã®ä¿®æ­£ï¼ˆ18:00 â†’ 19:00ï¼‰</td>
                <td><span class="badge badge-success">æ‰¿èªæ¸ˆã¿</span></td>
                <td>ç”°ä¸­ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</td>
                <td>
                  <a href="#modal-request-detail" class="btn btn-sm btn-secondary">è©³ç´°</a>
                </td>
              </tr>
              <tr>
                <td>2025-01-13 11:00</td>
                <td>ä¿®æ­£ç”³è«‹</td>
                <td>2025-01-13</td>
                <td>ä¼‘æ†©æ™‚é–“ã®ä¿®æ­£ï¼ˆ60åˆ† â†’ 45åˆ†ï¼‰</td>
                <td><span class="badge badge-error">å·®æˆ»ã—</span></td>
                <td>ç”°ä¸­ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</td>
                <td>
                  <a href="#modal-request-detail" class="btn btn-sm btn-secondary">è©³ç´°</a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      </div>
    </div>

    <!-- ç”³è«‹ä¸­ã®ç”³è«‹ -->
    <div id="tab-pending" class="tab-content">
      <div class="card">
        <div class="card-body">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>ç”³è«‹æ—¥</th>
                  <th>ç¨®é¡</th>
                  <th>å¯¾è±¡æ—¥</th>
                  <th>ç”³è«‹å†…å®¹</th>
                  <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                  <th>æ‰¿èªè€…</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>2025-01-15 10:30</td>
                  <td>ä¿®æ­£ç”³è«‹</td>
                  <td>2025-01-15</td>
                  <td>å‡ºå‹¤æ™‚åˆ»ã®ä¿®æ­£ï¼ˆ09:00 â†’ 08:30ï¼‰</td>
                  <td><span class="badge badge-warning">ç”³è«‹ä¸­</span></td>
                  <td>ç”°ä¸­ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</td>
                  <td>
                    <a href="#modal-request-detail" class="btn btn-sm btn-secondary">è©³ç´°</a>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- æ‰¿èªæ¸ˆã¿ã®ç”³è«‹ -->
    <div id="tab-approved" class="tab-content">
      <div class="card">
        <div class="card-body">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>ç”³è«‹æ—¥</th>
                  <th>ç¨®é¡</th>
                  <th>å¯¾è±¡æ—¥</th>
                  <th>ç”³è«‹å†…å®¹</th>
                  <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                  <th>æ‰¿èªè€…</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>2025-01-14 19:15</td>
                  <td>ä¿®æ­£ç”³è«‹</td>
                  <td>2025-01-14</td>
                  <td>é€€å‹¤æ™‚åˆ»ã®ä¿®æ­£ï¼ˆ18:00 â†’ 19:00ï¼‰</td>
                  <td><span class="badge badge-success">æ‰¿èªæ¸ˆã¿</span></td>
                  <td>ç”°ä¸­ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</td>
                  <td>
                    <a href="#modal-request-detail" class="btn btn-sm btn-secondary">è©³ç´°</a>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- å·®æˆ»ã—ã®ç”³è«‹ -->
    <div id="tab-rejected" class="tab-content">
      <div class="card">
        <div class="card-body">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>ç”³è«‹æ—¥</th>
                  <th>ç¨®é¡</th>
                  <th>å¯¾è±¡æ—¥</th>
                  <th>ç”³è«‹å†…å®¹</th>
                  <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                  <th>æ‰¿èªè€…</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>2025-01-13 11:00</td>
                  <td>ä¿®æ­£ç”³è«‹</td>
                  <td>2025-01-13</td>
                  <td>ä¼‘æ†©æ™‚é–“ã®ä¿®æ­£ï¼ˆ60åˆ† â†’ 45åˆ†ï¼‰</td>
                  <td><span class="badge badge-error">å·®æˆ»ã—</span></td>
                  <td>ç”°ä¸­ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</td>
                  <td>
                    <a href="#modal-request-detail" class="btn btn-sm btn-secondary">è©³ç´°</a>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- æ–°è¦ç”³è«‹ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal-new-request" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">æ–°è¦ç”³è«‹</h2>
          <a href="#" class="modal-close">&times;</a>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group">
              <label for="request-type" class="form-label required">ç”³è«‹ç¨®é¡</label>
              <select id="request-type" name="request-type" class="form-select" required>
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="edit">ä¿®æ­£ç”³è«‹</option>
                <option value="overtime">æ®‹æ¥­ç”³è«‹</option>
                <option value="leave">ä¼‘æš‡ç”³è«‹</option>
              </select>
            </div>

            <div class="form-group">
              <label for="target-date" class="form-label required">å¯¾è±¡æ—¥</label>
              <input 
                type="date" 
                id="target-date" 
                name="target-date" 
                class="form-input" 
                required
              >
            </div>

            <div class="form-group">
              <label for="request-content" class="form-label required">ç”³è«‹å†…å®¹</label>
              <textarea 
                id="request-content" 
                name="request-content" 
                class="form-textarea" 
                placeholder="ç”³è«‹å†…å®¹ã‚’è©³ç´°ã«è¨˜å…¥ã—ã¦ãã ã•ã„"
                required
              ></textarea>
            </div>

            <div class="form-group">
              <label for="reason" class="form-label required">ç”³è«‹ç†ç”±</label>
              <textarea 
                id="reason" 
                name="reason" 
                class="form-textarea" 
                placeholder="ç”³è«‹ç†ç”±ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„"
                required
              ></textarea>
            </div>

            <div class="form-group">
              <label for="attachment" class="form-label">æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</label>
              <input 
                type="file" 
                id="attachment" 
                name="attachment" 
                class="form-input"
              >
              <div class="form-help">PDFã€ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæœ€å¤§10MBï¼‰</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-secondary modal-close">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
          <button type="button" class="btn btn-primary" onclick="createRequest()">ç”³è«‹ã™ã‚‹</button>
        </div>
      </div>
    </div>

    <!-- ç”³è«‹è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal-request-detail" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ç”³è«‹è©³ç´°</h2>
          <a href="#" class="modal-close">&times;</a>
        </div>
        <div class="modal-body">
          <div style="margin-bottom: var(--spacing-lg);">
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
              <div style="font-weight: 600; color: var(--text-secondary);">ç”³è«‹æ—¥:</div>
              <div>2025-01-15 10:30</div>
            </div>
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
              <div style="font-weight: 600; color: var(--text-secondary);">ç¨®é¡:</div>
              <div>ä¿®æ­£ç”³è«‹</div>
            </div>
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
              <div style="font-weight: 600; color: var(--text-secondary);">å¯¾è±¡æ—¥:</div>
              <div>2025-01-15</div>
            </div>
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
              <div style="font-weight: 600; color: var(--text-secondary);">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</div>
              <div><span class="badge badge-warning">ç”³è«‹ä¸­</span></div>
            </div>
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
              <div style="font-weight: 600; color: var(--text-secondary);">ç”³è«‹å†…å®¹:</div>
              <div>å‡ºå‹¤æ™‚åˆ»ã®ä¿®æ­£ï¼ˆ09:00 â†’ 08:30ï¼‰</div>
            </div>
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
              <div style="font-weight: 600; color: var(--text-secondary);">ç”³è«‹ç†ç”±:</div>
              <div>é›»è»Šã®é…å»¶ã«ã‚ˆã‚Šå‡ºå‹¤æ™‚åˆ»ãŒé…ã‚Œã¾ã—ãŸã€‚å®Ÿéš›ã®å‡ºå‹¤æ™‚åˆ»ã¯8æ™‚30åˆ†ã§ã™ã€‚</div>
            </div>
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md);">
              <div style="font-weight: 600; color: var(--text-secondary);">æ‰¿èªè€…:</div>
              <div>ç”°ä¸­ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-secondary modal-close">é–‰ã˜ã‚‹</a>
        </div>
      </div>
    </div>
  </main>
  
  <!-- æ™‚é–“ãƒ¢ãƒ¼ãƒ‰è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="time-mode-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">æ™‚é–“ãƒ¢ãƒ¼ãƒ‰è¨­å®š</h2>
        <button class="modal-close" onclick="closeTimeModeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer; margin-bottom: var(--spacing-md);">
            <input type="radio" name="time-mode" id="time-mode-realtime" value="realtime" checked style="cursor: pointer;">
            <span>ç¾å®Ÿæ™‚é–“ã‚’æ¡ç”¨</span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer; margin-bottom: var(--spacing-md);">
            <input type="radio" name="time-mode" id="time-mode-virtual" value="virtual" style="cursor: pointer;">
            <span>ä»®æƒ³æ™‚é–“ã‚’æ¡ç”¨</span>
          </label>
        </div>
        
        <div id="virtual-time-settings" style="display: none; margin-top: var(--spacing-lg); padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-md);">
          <div class="form-group">
            <label for="virtual-date" class="form-label required">æ—¥ä»˜</label>
            <input type="date" id="virtual-date" class="form-input" required>
          </div>
          <div class="form-group">
            <label for="virtual-time" class="form-label required">æ™‚åˆ»</label>
            <input type="time" id="virtual-time" class="form-input" required>
          </div>
          <div class="form-help" style="color: var(--text-secondary); font-size: var(--font-size-sm);">
            æ³¨æ„: ä»®æƒ³æ™‚é–“ã¯éå»ã®æ™‚é–“ã«æˆ»ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
          </div>
        </div>
        
        <div style="margin-top: var(--spacing-xl); padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
          <button onclick="resetDatabase()" class="btn btn-sm btn-danger" style="width: 100%;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
          <div class="form-help" style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-top: var(--spacing-xs);">
            ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€ã‚¹ã‚­ãƒ¼ãƒã‚’å†é©ç”¨ã—ã¾ã™ã€‚æ™‚é–“ãƒ¢ãƒ¼ãƒ‰ã‚‚ç¾å®Ÿæ™‚é–“ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="saveTimeMode()" class="btn btn-primary">ä¿å­˜</button>
        <button onclick="closeTimeModeModal()" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>
  
  <script src="../scripts/common.js"></script>
  <script>
    // ============================================
    // ç”³è«‹ç®¡ç† - APIé€£æº
    // ============================================

    let requests = [];
    let currentTab = 'all';

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      await loadRequests();
      setupEventListeners();
      updateHeaderUserInfo();
    });

    // ç”³è«‹ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadRequests(status = null) {
      try {
        let url = `${API_BASE_URL}/requests?limit=1000`;
        if (status && status !== 'all') {
          url += `&status=${status}`;
        }
        
        const response = await apiFetch(url);
        const data = await response.json();
        
        if (response.ok && data.success) {
          requests = data.data.items || [];
          renderRequests();
        } else {
          console.error('ç”³è«‹ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', data);
          alert('ç”³è«‹ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('ç”³è«‹ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ç”³è«‹ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ç”³è«‹ã‚’æç”»
    function renderRequests() {
      const tabContents = {
        'all': document.getElementById('tab-all'),
        'pending': document.getElementById('tab-pending'),
        'approved': document.getElementById('tab-approved'),
        'rejected': document.getElementById('tab-rejected')
      };

      Object.keys(tabContents).forEach(tab => {
        const container = tabContents[tab];
        if (!container) return;

        const tbody = container.querySelector('tbody');
        if (!tbody) return;

        tbody.innerHTML = '';

        let filteredRequests = requests;
        if (tab !== 'all') {
          filteredRequests = requests.filter(r => r.status === tab);
        }

        if (filteredRequests.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = '<td colspan="7" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">ç”³è«‹ãŒã‚ã‚Šã¾ã›ã‚“</td>';
          tbody.appendChild(row);
          return;
        }

        filteredRequests.forEach(request => {
          const row = document.createElement('tr');
          
          const typeLabels = {
            'edit': 'ä¿®æ­£ç”³è«‹',
            'overtime': 'æ®‹æ¥­ç”³è«‹',
            'leave': 'ä¼‘æš‡ç”³è«‹',
            'others': 'ãã®ä»–'
          };

          const statusBadges = {
            'pending': '<span class="badge badge-warning">ç”³è«‹ä¸­</span>',
            'approved': '<span class="badge badge-success">æ‰¿èªæ¸ˆã¿</span>',
            'rejected': '<span class="badge badge-error">å·®æˆ»ã—</span>'
          };

          const createdDate = new Date(request.created_at);
          const createdDateStr = `${createdDate.getFullYear()}-${String(createdDate.getMonth() + 1).padStart(2, '0')}-${String(createdDate.getDate()).padStart(2, '0')} ${String(createdDate.getHours()).padStart(2, '0')}:${String(createdDate.getMinutes()).padStart(2, '0')}`;
          
          const payload = typeof request.payload === 'string' ? JSON.parse(request.payload) : request.payload;
          const content = payload.content || payload.description || 'ç”³è«‹å†…å®¹';

          row.innerHTML = `
            <td>${createdDateStr}</td>
            <td>${typeLabels[request.type] || request.type}</td>
            <td>${request.target_date}</td>
            <td>${content}</td>
            <td>${statusBadges[request.status] || request.status}</td>
            <td>${request.approver_name || '-'}</td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="showRequestDetail('${request.id}')">è©³ç´°</button>
            </td>
          `;
          
          tbody.appendChild(row);
        });
      });
    }

    // ç”³è«‹è©³ç´°ã‚’è¡¨ç¤º
    async function showRequestDetail(requestId) {
      try {
        const response = await apiFetch(`${API_BASE_URL}/requests/${requestId}`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          const request = data.data;
          const modal = document.getElementById('modal-request-detail');
          if (!modal) return;

          const typeLabels = {
            'edit': 'ä¿®æ­£ç”³è«‹',
            'overtime': 'æ®‹æ¥­ç”³è«‹',
            'leave': 'ä¼‘æš‡ç”³è«‹',
            'others': 'ãã®ä»–'
          };

          const statusBadges = {
            'pending': '<span class="badge badge-warning">ç”³è«‹ä¸­</span>',
            'approved': '<span class="badge badge-success">æ‰¿èªæ¸ˆã¿</span>',
            'rejected': '<span class="badge badge-error">å·®æˆ»ã—</span>'
          };

          const createdDate = new Date(request.created_at);
          const createdDateStr = `${createdDate.getFullYear()}-${String(createdDate.getMonth() + 1).padStart(2, '0')}-${String(createdDate.getDate()).padStart(2, '0')} ${String(createdDate.getHours()).padStart(2, '0')}:${String(createdDate.getMinutes()).padStart(2, '0')}`;
          
          const payload = typeof request.payload === 'string' ? JSON.parse(request.payload) : request.payload;
          const content = payload.content || payload.description || 'ç”³è«‹å†…å®¹';

          modal.querySelector('.modal-body').innerHTML = `
            <div style="margin-bottom: var(--spacing-lg);">
              <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                <div style="font-weight: 600; color: var(--text-secondary);">ç”³è«‹æ—¥:</div>
                <div>${createdDateStr}</div>
              </div>
              <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                <div style="font-weight: 600; color: var(--text-secondary);">ç¨®é¡:</div>
                <div>${typeLabels[request.type] || request.type}</div>
              </div>
              <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                <div style="font-weight: 600; color: var(--text-secondary);">å¯¾è±¡æ—¥:</div>
                <div>${request.target_date}</div>
              </div>
              <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                <div style="font-weight: 600; color: var(--text-secondary);">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</div>
                <div>${statusBadges[request.status] || request.status}</div>
              </div>
              <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                <div style="font-weight: 600; color: var(--text-secondary);">ç”³è«‹å†…å®¹:</div>
                <div>${content}</div>
              </div>
              <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                <div style="font-weight: 600; color: var(--text-secondary);">ç”³è«‹ç†ç”±:</div>
                <div>${request.reason}</div>
              </div>
              ${request.rejection_reason ? `
              <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                <div style="font-weight: 600; color: var(--text-secondary);">å·®æˆ»ã—ç†ç”±:</div>
                <div style="color: var(--color-error);">${request.rejection_reason}</div>
              </div>
              ` : ''}
              <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--spacing-md);">
                <div style="font-weight: 600; color: var(--text-secondary);">æ‰¿èªè€…:</div>
                <div>${request.approver_name || '-'}</div>
              </div>
            </div>
          `;

          modal.style.display = 'block';
        } else {
          alert('ç”³è«‹è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('ç”³è«‹è©³ç´°ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        alert('ç”³è«‹è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // æ–°è¦ç”³è«‹ã‚’ä½œæˆ
    async function createRequest() {
      const type = document.getElementById('request-type').value;
      const targetDate = document.getElementById('target-date').value;
      const content = document.getElementById('request-content').value;
      const reason = document.getElementById('reason').value;
      const attachment = document.getElementById('attachment').files[0];

      console.log('ç”³è«‹ä½œæˆé–‹å§‹:', { type, targetDate, content, reason });

      if (!type || !targetDate || !content || !reason) {
        alert('ã™ã¹ã¦ã®å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const payload = {
          content: content,
          description: content
        };

        const requestData = {
          type: type,
          target_date: targetDate,
          payload: payload,
          reason: reason
        };

        console.log('ç”³è«‹ãƒ‡ãƒ¼ã‚¿:', requestData);

        const response = await apiFetch(`${API_BASE_URL}/requests`, {
          method: 'POST',
          body: JSON.stringify(requestData)
        });

        const data = await response.json();
        console.log('ç”³è«‹ä½œæˆãƒ¬ã‚¹ãƒãƒ³ã‚¹:', { status: response.status, data });

        if (response.ok && data.success) {
          alert('ç”³è«‹ã‚’ä½œæˆã—ã¾ã—ãŸ');
          const modal = document.getElementById('modal-new-request');
          if (modal) {
            modal.style.display = 'none';
          }
          document.getElementById('request-type').value = '';
          document.getElementById('target-date').value = '';
          document.getElementById('request-content').value = '';
          document.getElementById('reason').value = '';
          document.getElementById('attachment').value = '';
          await loadRequests();
        } else {
          const errorMsg = data.error?.message || data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
          console.error('ç”³è«‹ä½œæˆã‚¨ãƒ©ãƒ¼:', data);
          alert('ç”³è«‹ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + errorMsg);
        }
      } catch (error) {
        console.error('ç”³è«‹ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        alert('ç”³è«‹ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    function setupEventListeners() {
      // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab-link').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const tab = this.getAttribute('href').substring(1);
          currentTab = tab.replace('tab-', '');
          
          document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
          });
          document.getElementById(tab).style.display = 'block';
          
          document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
          this.classList.add('active');
          
          loadRequests(currentTab === 'all' ? null : currentTab);
        });
      });

      // æ–°è¦ç”³è«‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      const newRequestLink = document.querySelector('a[href="#modal-new-request"]');
      if (newRequestLink) {
        newRequestLink.addEventListener('click', function(e) {
          e.preventDefault();
          const modal = document.getElementById('modal-new-request');
          if (modal) {
            modal.style.display = 'block';
            // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ã‚’ä»Šæ—¥ã®æ—¥ä»˜ã«è¨­å®šï¼ˆä»®æƒ³æ™‚é–“å¯¾å¿œï¼‰
            const dateInput = document.getElementById('target-date');
            if (dateInput && !dateInput.value) {
              const today = getCurrentTime();
              dateInput.value = formatDate(today);
            }
          }
        });
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      document.querySelectorAll('.modal-close').forEach(closeBtn => {
        closeBtn.addEventListener('click', function(e) {
          e.preventDefault();
          const modal = this.closest('.modal');
          if (modal) {
            modal.style.display = 'none';
          }
        });
      });

      // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            this.style.display = 'none';
          }
        });
      });
    }
  </script>
</body>
</html>

