<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ - å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="../styles/common.css">
  <link rel="stylesheet" href="../styles/components.css">
  <link rel="stylesheet" href="../styles/layout.css">
  <style>
    .gantt-container {
      background-color: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-lg);
      overflow-x: auto;
    }

    .gantt-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-md);
      border-bottom: 2px solid var(--border-color);
    }

    .gantt-legend {
      display: flex;
      gap: var(--spacing-md);
      flex-wrap: wrap;
    }

    .gantt-legend-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-size: var(--font-size-sm);
    }

    .gantt-legend-color {
      width: 20px;
      height: 20px;
      border-radius: var(--border-radius-sm);
    }

    .gantt-time-axis {
      display: grid;
      grid-template-columns: 180px repeat(24, minmax(40px, 1fr));
      gap: 2px;
      margin-bottom: var(--spacing-md);
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: var(--spacing-xs);
    }

    .gantt-time-label {
      padding: var(--spacing-sm);
      font-weight: 600;
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
      text-align: center;
      background-color: var(--bg-primary);
      border-radius: var(--border-radius-sm);
    }

    .gantt-time-hour {
      text-align: center;
      padding: var(--spacing-xs);
      font-size: var(--font-size-xs);
      font-weight: 500;
      color: var(--text-primary);
      background-color: var(--bg-primary);
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--border-color);
    }

    .gantt-time-hour:nth-child(odd) {
      background-color: var(--bg-secondary);
    }

    .gantt-row {
      display: grid;
      grid-template-columns: 180px repeat(24, minmax(40px, 1fr));
      gap: 2px;
      margin-bottom: var(--spacing-md);
      min-height: 60px;
    }

    .gantt-row-label {
      padding: var(--spacing-md);
      font-weight: 500;
      display: flex;
      align-items: center;
      background-color: var(--bg-secondary);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      font-size: var(--font-size-sm);
    }

    .gantt-cell {
      background-color: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-sm);
      position: relative;
      min-height: 60px;
    }

    .gantt-cell:nth-child(odd) {
      background-color: var(--bg-secondary);
    }

    .gantt-bar {
      position: absolute;
      height: 70%;
      top: 15%;
      border-radius: var(--border-radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-xs);
      color: var(--text-inverse);
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all var(--transition-fast);
      cursor: pointer;
      z-index: 1;
    }

    .gantt-bar:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      z-index: 2;
    }

    /* ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³æ©Ÿèƒ½ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .gantt-container.zoomed {
      transform-origin: top left;
    }

    .gantt-container.panning {
      cursor: grab;
    }

    .gantt-container.panning:active {
      cursor: grabbing;
    }

    /* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œå¯¾å¿œ */
    .gantt-container:focus {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }

    .gantt-bar-work {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      border-left: 3px solid var(--color-primary-dark);
      border-right: 3px solid var(--color-primary-dark);
    }

    .gantt-bar-break {
      background: linear-gradient(135deg, var(--color-info) 0%, #0891b2 100%);
      opacity: 0.85;
      border-left: 2px solid #0891b2;
      border-right: 2px solid #0891b2;
    }

    .gantt-bar-pending {
      background: repeating-linear-gradient(
        45deg,
        var(--color-warning),
        var(--color-warning) 8px,
        rgba(245, 158, 11, 0.4) 8px,
        rgba(245, 158, 11, 0.4) 16px
      );
      border: 2px dashed var(--color-warning);
    }

    .gantt-bar-error {
      background: linear-gradient(135deg, var(--color-error) 0%, #dc2626 100%);
      border-left: 3px solid #dc2626;
      border-right: 3px solid #dc2626;
    }

    .gantt-bar-empty {
      background-color: rgba(239, 68, 68, 0.1);
      border: 2px dashed var(--color-error);
      color: var(--color-error);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-xs);
      font-weight: 500;
    }

    /* æ™‚é–“å¸¯ã®èƒŒæ™¯è‰²ï¼ˆå–¶æ¥­æ™‚é–“ã‚’å¼·èª¿ï¼‰ */
    .gantt-cell[data-hour="9"],
    .gantt-cell[data-hour="10"],
    .gantt-cell[data-hour="11"],
    .gantt-cell[data-hour="13"],
    .gantt-cell[data-hour="14"],
    .gantt-cell[data-hour="15"],
    .gantt-cell[data-hour="16"],
    .gantt-cell[data-hour="17"] {
      background-color: rgba(37, 99, 235, 0.05);
    }

    .gantt-cell[data-hour="12"] {
      background-color: rgba(6, 182, 212, 0.1);
    }
  </style>
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="../dashboard.html" class="header-logo">å‹¤æ€ ç®¡ç†</a>
        <nav class="header-nav">
          <a href="../dashboard.html" class="header-nav-link">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
          <a href="punch.html" class="header-nav-link">æ‰“åˆ»</a>
          <a href="gantt.html" class="header-nav-link active">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</a>
          <a href="reports.html" class="header-nav-link">ãƒ¬ãƒãƒ¼ãƒˆ</a>
        </nav>
      </div>
      <div class="header-right">
        <a href="requests.html" class="header-nav-link">ç”³è«‹</a>
        <button onclick="logout()" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-sm);">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <a href="profile.html" class="header-user" style="text-decoration: none;">
          <div class="header-user-avatar"></div>
          <span class="header-user-name"></span>
        </a>
      </div>
    </div>
  </header>

  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li class="sidebar-menu-item">
        <a href="../dashboard.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“Š</span>
          <span class="sidebar-menu-label">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="punch.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">â°</span>
          <span class="sidebar-menu-label">æ‰“åˆ»</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="gantt.html" class="sidebar-menu-link active">
          <span class="sidebar-menu-icon">ğŸ“…</span>
          <span class="sidebar-menu-label">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="requests.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“</span>
          <span class="sidebar-menu-label">ç”³è«‹ãƒ»æ‰¿èª</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="employees.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ‘¥</span>
          <span class="sidebar-menu-label">å¾“æ¥­å“¡ç®¡ç†</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="company-settings.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">âš™ï¸</span>
          <span class="sidebar-menu-label">ä¼æ¥­è¨­å®š</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="reports.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“ˆ</span>
          <span class="sidebar-menu-label">ãƒ¬ãƒãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="payslip.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ’°</span>
          <span class="sidebar-menu-label">çµ¦ä¸æ˜ç´°</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="audit-logs.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ”</span>
          <span class="sidebar-menu-label">ç›£æŸ»ãƒ­ã‚°</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-content">
    <div class="page-header">
      <h1 class="page-title">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</h1>
      <p class="page-description">å‹¤æ€ çŠ¶æ³ã‚’æ™‚ç³»åˆ—ã§å¯è¦–åŒ–ã—ã¾ã™</p>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒãƒ¼ -->
    <div class="filter-bar">
      <div class="filter-group">
        <label class="filter-label">è¡¨ç¤ºæœŸé–“ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«ï¼‰:</label>
        <select class="form-select filter-input" id="gantt-scale">
          <option value="day" selected>æ—¥</option>
          <option value="week">é€±</option>
          <option value="month">æœˆ</option>
        </select>
        <div class="form-help" style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-top: var(--spacing-xs);">
          ä»•æ§˜æ›¸5.5ã€12: æ—¥/é€±/æœˆã‚¹ã‚±ãƒ¼ãƒ«å¯¾å¿œ
        </div>
      </div>
      <div class="filter-group">
        <label class="filter-label">ã‚ºãƒ¼ãƒ :</label>
        <div style="display: flex; gap: var(--spacing-xs);">
          <button class="btn btn-sm btn-secondary" id="zoom-in" title="ã‚ºãƒ¼ãƒ ã‚¤ãƒ³">+</button>
          <button class="btn btn-sm btn-secondary" id="zoom-out" title="ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆ">-</button>
          <button class="btn btn-sm btn-secondary" id="zoom-reset" title="ãƒªã‚»ãƒƒãƒˆ">â†º</button>
        </div>
      </div>
      <div class="filter-group">
        <label class="filter-label">ãƒ‘ãƒ³:</label>
        <div style="display: flex; gap: var(--spacing-xs);">
          <button class="btn btn-sm btn-secondary" id="pan-left" title="å·¦ã¸ç§»å‹•">â†</button>
          <button class="btn btn-sm btn-secondary" id="pan-right" title="å³ã¸ç§»å‹•">â†’</button>
        </div>
      </div>
      <div class="filter-group">
        <label class="filter-label">æ—¥ä»˜:</label>
        <input type="date" class="form-input filter-input" id="filter-date" value="">
      </div>
      <div class="filter-group">
        <label class="filter-label">éƒ¨ç½²:</label>
        <select class="form-select filter-input" id="filter-department">
          <option value="">ã™ã¹ã¦</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">å¾“æ¥­å“¡:</label>
        <select class="form-select filter-input" id="filter-employee">
          <option value="">ã™ã¹ã¦</option>
        </select>
      </div>
      <div class="filter-group">
        <button class="btn btn-secondary" id="apply-filter">ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨</button>
      </div>
      <div class="filter-group">
        <button class="btn btn-sm btn-secondary" id="download-logs" title="ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">ğŸ“¥ ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
    </div>

    <!-- ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ -->
    <div class="gantt-container" id="gantt-container">
      <div class="gantt-header">
        <h3 style="margin: 0; font-size: var(--font-size-xl);" id="gantt-title">2025å¹´1æœˆ15æ—¥ï¼ˆæ°´ï¼‰</h3>
        <div class="gantt-legend">
          <div class="gantt-legend-item">
            <div class="gantt-legend-color" style="background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);"></div>
            <span>å‹¤å‹™æ™‚é–“</span>
          </div>
          <div class="gantt-legend-item">
            <div class="gantt-legend-color" style="background: linear-gradient(135deg, var(--color-info) 0%, #0891b2 100%);"></div>
            <span>ä¼‘æ†©æ™‚é–“</span>
          </div>
          <div class="gantt-legend-item">
            <div class="gantt-legend-color" style="background: repeating-linear-gradient(45deg, var(--color-warning), var(--color-warning) 8px, rgba(245, 158, 11, 0.4) 8px, rgba(245, 158, 11, 0.4) 16px); border: 2px dashed var(--color-warning);"></div>
            <span>ç”³è«‹ä¸­</span>
          </div>
          <div class="gantt-legend-item">
            <div class="gantt-legend-color" style="background: linear-gradient(135deg, var(--color-error) 0%, #dc2626 100%);"></div>
            <span>ç•°å¸¸ãƒ»æœªæ‰“åˆ»</span>
          </div>
        </div>
      </div>

      <!-- æ™‚é–“è»¸ï¼ˆæ—¥ã‚¹ã‚±ãƒ¼ãƒ«æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
      <div class="gantt-time-axis" id="gantt-time-axis" style="display: none;">
        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
      </div>

      <!-- ã‚¬ãƒ³ãƒˆè¡Œï¼ˆå‹•çš„ã«ç”Ÿæˆï¼‰ -->
      <div id="gantt-rows"></div>
    </div>

    <!-- ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆæ“ä½œã®èª¬æ˜ -->
    <div class="card" style="margin-top: var(--spacing-xl);">
      <div class="card-header">
        <h2 class="card-title">æ“ä½œã‚¬ã‚¤ãƒ‰ï¼ˆä»•æ§˜æ›¸5.5ã€12ï¼‰</h2>
      </div>
      <div class="card-body">
        <ul style="list-style: disc; padding-left: var(--spacing-lg);">
          <li><strong>ã‚¹ã‚±ãƒ¼ãƒ«:</strong> æ—¥/é€±/æœˆã®åˆ‡ã‚Šæ›¿ãˆãŒå¯èƒ½ã§ã™</li>
          <li><strong>ã‚ºãƒ¼ãƒ :</strong> +/-ãƒœã‚¿ãƒ³ã§æ™‚é–“è»¸ã®æ‹¡å¤§ãƒ»ç¸®å°ãŒã§ãã¾ã™</li>
          <li><strong>ãƒ‘ãƒ³:</strong> â†â†’ãƒœã‚¿ãƒ³ã§æ™‚é–“è»¸ã‚’å·¦å³ã«ç§»å‹•ã§ãã¾ã™</li>
          <li><strong>ãƒ›ãƒãƒ¼:</strong> ãƒãƒ¼ã«ãƒã‚¦ã‚¹ã‚’ä¹—ã›ã‚‹ã¨è©³ç´°æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>
          <li><strong>ã‚¯ãƒªãƒƒã‚¯:</strong> ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°/ç·¨é›†ç”»é¢ãŒé–‹ãã¾ã™ï¼ˆæ¨©é™è¦ï¼‰</li>
          <li><strong>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰:</strong> çŸ¢å°ã‚­ãƒ¼ã§æ™‚é–“è»¸ã‚’ç§»å‹•ã§ãã¾ã™ï¼ˆã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œï¼‰</li>
        </ul>
      </div>
    </div>
  </main>

  <script src="../scripts/common.js"></script>
  <script>
    // ============================================
    // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ - APIé€£æº
    // ============================================

    let employees = [];
    let departments = [];
    let punches = [];

    // ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆä»®æƒ³æ™‚é–“ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼‰
    function getCurrentDate() {
      return getCurrentTime();
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ã‚’ä»Šæ—¥ã®æ—¥ä»˜ã«è¨­å®šï¼ˆä»®æƒ³æ™‚é–“å¯¾å¿œï¼‰
      updateDateFilter();
      
      // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      await Promise.all([
        loadDepartments(),
        loadEmployees()
      ]);
      
      // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      await loadGanttData();
      
      // ãƒ•ã‚£ãƒ«ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      setupFilterListeners();
      
      // ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³æ©Ÿèƒ½ã‚’è¨­å®š
      setupZoomPanControls();
      
      // ä»®æƒ³æ™‚é–“ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      setupTimeModeChangeListener();
      
      // ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®è¨­å®š
      setupLogDownloadButton();
    });
    
    // ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®è¨­å®š
    function setupLogDownloadButton() {
      const downloadBtn = document.getElementById('download-logs');
      if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
          // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
          const format = prompt('ãƒ­ã‚°ã®å½¢å¼ã‚’é¸æŠã—ã¦ãã ã•ã„:\n1. JSON (æ¨å¥¨)\n2. TXT\n3. CSV\n\nç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (1-3):', '1');
          
          if (format === '1' || format === 'json' || format === '') {
            downloadLogs('json');
          } else if (format === '2' || format === 'txt') {
            downloadLogs('txt');
          } else if (format === '3' || format === 'csv') {
            downloadLogs('csv');
          } else {
            alert('ç„¡åŠ¹ãªå½¢å¼ã§ã™ã€‚JSONå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚');
            downloadLogs('json');
          }
        });
      }
    }

    // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ã‚’æ›´æ–°ï¼ˆä»®æƒ³æ™‚é–“å¯¾å¿œï¼‰
    function updateDateFilter() {
      const dateInput = document.getElementById('filter-date');
      const currentDate = getCurrentDate();
      const todayStr = formatDate(currentDate);
      
      // ç¾åœ¨ã®å€¤ãŒç©ºã®å ´åˆã®ã¿è¨­å®šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¤‰æ›´ã—ãŸå ´åˆã¯ä¿æŒï¼‰
      if (!dateInput.value) {
        dateInput.value = todayStr;
      }
      
      console.log('æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿æ›´æ–°:', { todayStr, currentValue: dateInput.value, timeMode: getTimeMode() });
    }

    // ä»®æƒ³æ™‚é–“ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    function setupTimeModeChangeListener() {
      // localStorageã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆåˆ¥ã‚¿ãƒ–ã§ã®å¤‰æ›´ã‚‚æ¤œçŸ¥ï¼‰
      window.addEventListener('storage', function(e) {
        if (e.key === TIME_MODE_STORAGE_KEY || e.key === VIRTUAL_TIME_STORAGE_KEY) {
          // æ™‚é–“ãƒ¢ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ã¨ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
          updateDateFilter();
          loadGanttData();
        }
      });
      
      // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã§æ™‚é–“ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ã‚’æ¤œçŸ¥
      window.addEventListener('timeModeChanged', function() {
        updateDateFilter();
        loadGanttData();
      });
    }

    // éƒ¨ç½²ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadDepartments() {
      try {
        const response = await apiFetch(`${API_BASE_URL}/departments`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          departments = data.data;
          const select = document.getElementById('filter-department');
          select.innerHTML = '<option value="">ã™ã¹ã¦</option>';
          
          departments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept.id;
            option.textContent = dept.name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('éƒ¨ç½²ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // å¾“æ¥­å“¡ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadEmployees() {
      try {
        const response = await apiFetch(`${API_BASE_URL}/employees?limit=1000`);
        const data = await response.json();
        
        console.log('å¾“æ¥­å“¡ä¸€è¦§å–å¾—çµæœ:', { success: data.success, count: data.data?.items?.length || 0 });
        
        if (response.ok && data.success) {
          employees = data.data.items || [];
          const select = document.getElementById('filter-employee');
          select.innerHTML = '<option value="">ã™ã¹ã¦</option>';
          
          employees.forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.id;
            option.textContent = `${emp.name}${emp.department_name ? `ï¼ˆ${emp.department_name}ï¼‰` : ''}`;
            select.appendChild(option);
          });
          
          console.log('å¾“æ¥­å“¡ä¸€è¦§:', employees);
        } else {
          console.error('å¾“æ¥­å“¡ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', data);
        }
      } catch (error) {
        console.error('å¾“æ¥­å“¡ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    async function loadGanttData() {
      const dateInput = document.getElementById('filter-date');
      const scaleSelect = document.getElementById('gantt-scale');
      const currentDate = getCurrentDate();
      const selectedDate = dateInput.value || formatDate(currentDate);
      const scale = scaleSelect.value || 'day';
      
      const date = new Date(selectedDate + 'T00:00:00');
      let endDate;
      
      // ã‚¹ã‚±ãƒ¼ãƒ«ã«å¿œã˜ã¦çµ‚äº†æ—¥ã‚’è¨­å®š
      if (scale === 'day') {
        endDate = new Date(date.getTime() + 24 * 60 * 60 * 1000);
      } else if (scale === 'week') {
        // é€±: é¸æŠã—ãŸæ—¥ã‹ã‚‰7æ—¥å¾Œ
        endDate = new Date(date.getTime() + 7 * 24 * 60 * 60 * 1000);
      } else if (scale === 'month') {
        // æœˆ: é¸æŠã—ãŸæ—¥ã®æœˆã®æœ€çµ‚æ—¥
        const year = date.getFullYear();
        const month = date.getMonth();
        endDate = new Date(year, month + 1, 0); // æ¬¡ã®æœˆã®0æ—¥ = ä»Šæœˆã®æœ€çµ‚æ—¥
        endDate.setHours(23, 59, 59, 999);
        // é–‹å§‹æ—¥ã‚’æœˆã®1æ—¥ã«è¨­å®š
        date.setDate(1);
        date.setHours(0, 0, 0, 0);
      } else {
        endDate = new Date(date.getTime() + 24 * 60 * 60 * 1000);
      }
      
      const fromStr = formatDate(date) + ' 00:00:00';
      const toStr = formatDate(endDate) + ' 23:59:59';
      
      console.log('æ‰“åˆ»ãƒ‡ãƒ¼ã‚¿å–å¾—:', { 
        selectedDate,
        scale,
        fromStr, 
        toStr,
        timeMode: getTimeMode(),
        virtualTime: getVirtualTime()?.toISOString()
      });
      
      try {
        const response = await apiFetch(`${API_BASE_URL}/punches?from=${fromStr}&to=${toStr}&limit=10000`);
        const data = await response.json();
        
        console.log('æ‰“åˆ»ãƒ‡ãƒ¼ã‚¿å–å¾—çµæœ:', { success: data.success, count: data.data?.items?.length || 0 });
        
        if (response.ok && data.success) {
          punches = data.data.items || [];
          console.log('æ‰“åˆ»ãƒ‡ãƒ¼ã‚¿:', punches);
          renderGanttChart();
          updateTitle(selectedDate, scale);
        } else {
          console.error('æ‰“åˆ»ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', data);
        }
      } catch (error) {
        console.error('æ‰“åˆ»ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚’æç”»
    function renderGanttChart() {
      const deptFilter = document.getElementById('filter-department').value;
      const empFilter = document.getElementById('filter-employee').value;
      const dateFilter = document.getElementById('filter-date').value;
      const scaleSelect = document.getElementById('gantt-scale');
      const scale = scaleSelect.value || 'day';
      
      console.log('ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆæç”»é–‹å§‹:', { 
        employeesCount: employees.length, 
        punchesCount: punches.length,
        deptFilter,
        empFilter,
        dateFilter,
        scale,
        allPunchEmployeeIds: punches.map(p => p.employee_id),
        allEmployeeIds: employees.map(e => e.id)
      });
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      let filteredEmployees = employees;
      if (deptFilter) {
        filteredEmployees = filteredEmployees.filter(emp => emp.dept_id === deptFilter);
        console.log('éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨å¾Œ:', filteredEmployees.length, 'äºº');
      }
      if (empFilter) {
        filteredEmployees = filteredEmployees.filter(emp => emp.id === empFilter);
        console.log('å¾“æ¥­å“¡ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨å¾Œ:', filteredEmployees.length, 'äºº');
      }
      
      console.log('ãƒ•ã‚£ãƒ«ã‚¿å¾Œã®å¾“æ¥­å“¡:', filteredEmployees.map(e => ({ id: e.id, name: e.name })));
      
      const rowsContainer = document.getElementById('gantt-rows');
      if (!rowsContainer) {
        console.error('gantt-rowsè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      rowsContainer.innerHTML = '';
      
      if (filteredEmployees.length === 0) {
        const emptyRow = document.createElement('div');
        emptyRow.className = 'gantt-row';
        emptyRow.innerHTML = '<div class="gantt-row-label" style="grid-column: 1 / -1; text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">è¡¨ç¤ºã™ã‚‹å¾“æ¥­å“¡ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        rowsContainer.appendChild(emptyRow);
        return;
      }
      
      // ã‚¹ã‚±ãƒ¼ãƒ«ã«å¿œã˜ã¦è¡¨ç¤ºå½¢å¼ã‚’åˆ‡ã‚Šæ›¿ãˆ
      if (scale === 'day') {
        // æ—¥ã‚¹ã‚±ãƒ¼ãƒ«: ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆå½¢å¼
        renderTimeAxis(scale);
        filteredEmployees.forEach(employee => {
          const row = createGanttRow(employee, scale);
          rowsContainer.appendChild(row);
        });
      } else {
        // é€±ãƒ»æœˆã‚¹ã‚±ãƒ¼ãƒ«: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å½¢å¼
        renderCalendarView(filteredEmployees, scale);
      }
      
      console.log('ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆæç”»å®Œäº†');
    }

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å½¢å¼ã§è¡¨ç¤º
    function renderCalendarView(filteredEmployees, scale) {
      const dateInput = document.getElementById('filter-date');
      const currentDate = getCurrentDate();
      const selectedDate = dateInput.value || formatDate(currentDate);
      const startDate = new Date(selectedDate + 'T00:00:00');
      
      // è¡¨ç¤ºã™ã‚‹æ—¥ä»˜ç¯„å›²ã‚’å–å¾—
      let dateRange = [];
      if (scale === 'week') {
        const startOfWeek = new Date(startDate);
        const dayOfWeek = startDate.getDay();
        startOfWeek.setDate(startDate.getDate() - dayOfWeek);
        
        for (let day = 0; day < 7; day++) {
          const currentDay = new Date(startOfWeek);
          currentDay.setDate(startOfWeek.getDate() + day);
          dateRange.push(new Date(currentDay));
        }
      } else if (scale === 'month') {
        const year = startDate.getFullYear();
        const month = startDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        for (let day = 1; day <= daysInMonth; day++) {
          const currentDay = new Date(year, month, day);
          dateRange.push(currentDay);
        }
      }
      
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å½¢å¼ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
      const calendarContainer = document.createElement('div');
      calendarContainer.className = 'card';
      calendarContainer.style.marginTop = 'var(--spacing-xl)';
      
      const table = document.createElement('table');
      table.className = 'table';
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      headerRow.innerHTML = '<th>å¾“æ¥­å“¡</th>';
      
      dateRange.forEach(date => {
        const th = document.createElement('th');
        const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        const weekday = weekdays[date.getDay()];
        th.textContent = `${date.getMonth() + 1}/${date.getDate()}(${weekday})`;
        headerRow.appendChild(th);
      });
      
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // ãƒ‡ãƒ¼ã‚¿è¡Œ
      const tbody = document.createElement('tbody');
      
      filteredEmployees.forEach(employee => {
        const row = document.createElement('tr');
        
        // å¾“æ¥­å“¡åã‚»ãƒ«
        const nameCell = document.createElement('td');
        nameCell.textContent = `${employee.name}${employee.department_name ? `ï¼ˆ${employee.department_name}ï¼‰` : ''}`;
        row.appendChild(nameCell);
        
        // å„æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ«
        dateRange.forEach(date => {
          const dateStr = formatDate(date);
          const dayPunches = punches.filter(p => {
            if (p.employee_id !== employee.id) return false;
            const punchDate = new Date(p.occurred_at);
            return formatDate(punchDate) === dateStr;
          });
          
          dayPunches.sort((a, b) => new Date(a.occurred_at) - new Date(b.occurred_at));
          
          const workSession = calculateWorkSessionForDay(dayPunches);
          
          const cell = document.createElement('td');
          cell.style.textAlign = 'center';
          cell.style.padding = 'var(--spacing-md)';
          
          if (workSession) {
            const clockIn = workSession.start ? formatTime(workSession.start) : '-';
            const clockOut = workSession.end ? formatTime(workSession.end) : '-';
            const breakMinutes = workSession.totalBreakMinutes || 0;
            const breakHours = Math.floor(breakMinutes / 60);
            const breakMins = breakMinutes % 60;
            const breakTime = breakMinutes > 0 ? `${breakHours}:${String(breakMins).padStart(2, '0')}` : '-';
            
            cell.innerHTML = `
              <div style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">
                <div><strong>å‡ºå‹¤:</strong> ${clockIn}</div>
                <div><strong>é€€å‹¤:</strong> ${clockOut}</div>
                <div><strong>ä¼‘æ†©:</strong> ${breakTime}</div>
              </div>
            `;
            
            // æœªæ‰“åˆ»ã®å ´åˆã¯è­¦å‘Šè‰²
            if (!workSession.start || !workSession.end) {
              cell.style.backgroundColor = 'rgba(239, 68, 68, 0.1)';
            }
          } else {
            cell.textContent = 'æœªæ‰“åˆ»';
            cell.style.color = 'var(--color-error)';
            cell.style.backgroundColor = 'rgba(239, 68, 68, 0.1)';
          }
          
          row.appendChild(cell);
        });
        
        tbody.appendChild(row);
      });
      
      table.appendChild(tbody);
      calendarContainer.appendChild(table);
      
      const rowsContainer = document.getElementById('gantt-rows');
      rowsContainer.appendChild(calendarContainer);
    }

    // 1æ—¥ã®å‹¤å‹™ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¨ˆç®—
    function calculateWorkSessionForDay(punches) {
      if (punches.length === 0) return null;
      
      let clockIn = null;
      let clockOut = null;
      const breaks = [];
      let currentBreak = null;
      
      punches.forEach(punch => {
        const punchTime = new Date(punch.occurred_at);
        
        if (punch.type === 'in') {
          clockIn = punchTime;
        } else if (punch.type === 'out') {
          clockOut = punchTime;
        } else if (punch.type === 'break_in') {
          currentBreak = { start: punchTime, end: null };
        } else if (punch.type === 'break_out' && currentBreak) {
          currentBreak.end = punchTime;
          breaks.push(currentBreak);
          currentBreak = null;
        }
      });
      
      // ä¼‘æ†©æ™‚é–“ã®åˆè¨ˆã‚’è¨ˆç®—
      let totalBreakMinutes = 0;
      breaks.forEach(breakTime => {
        if (breakTime.start && breakTime.end) {
          const breakDuration = (breakTime.end.getTime() - breakTime.start.getTime()) / (60 * 1000);
          totalBreakMinutes += breakDuration;
        }
      });
      
      return {
        start: clockIn,
        end: clockOut,
        breaks: breaks,
        totalBreakMinutes: Math.round(totalBreakMinutes)
      };
    }

    // æ™‚é–“è»¸ã‚’ç”Ÿæˆï¼ˆæ—¥ã‚¹ã‚±ãƒ¼ãƒ«æ™‚ã®ã¿ï¼‰
    function renderTimeAxis(scale) {
      const timeAxisContainer = document.getElementById('gantt-time-axis');
      if (!timeAxisContainer) return;
      
      if (scale !== 'day') {
        timeAxisContainer.style.display = 'none';
        return;
      }
      
      timeAxisContainer.style.display = 'grid';
      
      const dateInput = document.getElementById('filter-date');
      const currentDate = getCurrentDate();
      const selectedDate = dateInput.value || formatDate(currentDate);
      const startDate = new Date(selectedDate + 'T00:00:00');
      
      // æ—¥ã‚¹ã‚±ãƒ¼ãƒ«: 24æ™‚é–“
      const timeSlots = Array.from({ length: 24 }, (_, i) => ({
        label: `${i}æ™‚`,
        hour: i,
        date: startDate
      }));
      
      // æ™‚é–“è»¸ã‚’ã‚¯ãƒªã‚¢
      timeAxisContainer.innerHTML = '';
      
      // ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
      const labelDiv = document.createElement('div');
      labelDiv.className = 'gantt-time-label';
      labelDiv.textContent = 'å¾“æ¥­å“¡';
      timeAxisContainer.appendChild(labelDiv);
      
      // æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã‚’è¿½åŠ 
      timeSlots.forEach(slot => {
        const hourDiv = document.createElement('div');
        hourDiv.className = 'gantt-time-hour';
        hourDiv.setAttribute('data-hour', slot.hour);
        hourDiv.textContent = slot.label;
        timeAxisContainer.appendChild(hourDiv);
      });
      
      // CSSã‚°ãƒªãƒƒãƒ‰ã®åˆ—æ•°ã‚’æ›´æ–°
      timeAxisContainer.style.gridTemplateColumns = `180px repeat(24, minmax(40px, 1fr))`;
    }

    // ã‚¬ãƒ³ãƒˆè¡Œã‚’ä½œæˆ
    function createGanttRow(employee, scale = 'day') {
      const row = document.createElement('div');
      row.className = 'gantt-row';
      
      // ãƒ©ãƒ™ãƒ«
      const label = document.createElement('div');
      label.className = 'gantt-row-label';
      label.textContent = `${employee.name}${employee.department_name ? `ï¼ˆ${employee.department_name}ï¼‰` : ''}`;
      row.appendChild(label);
      
      // ã‚¹ã‚±ãƒ¼ãƒ«ã«å¿œã˜ãŸæ‰“åˆ»ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const dateInput = document.getElementById('filter-date');
      const currentDate = getCurrentDate();
      const selectedDate = dateInput.value || formatDate(currentDate);
      const startDate = new Date(selectedDate + 'T00:00:00');
      
      let dateRange = [];
      if (scale === 'day') {
        dateRange = [selectedDate];
      } else if (scale === 'week') {
        // é€±ã®7æ—¥åˆ†
        const startOfWeek = new Date(startDate);
        const dayOfWeek = startDate.getDay();
        startOfWeek.setDate(startDate.getDate() - dayOfWeek);
        
        for (let day = 0; day < 7; day++) {
          const currentDay = new Date(startOfWeek);
          currentDay.setDate(startOfWeek.getDate() + day);
          dateRange.push(formatDate(currentDay));
        }
      } else if (scale === 'month') {
        // æœˆã®å…¨æ—¥æœŸé–“
        const year = startDate.getFullYear();
        const month = startDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        for (let day = 1; day <= daysInMonth; day++) {
          const currentDay = new Date(year, month, day);
          dateRange.push(formatDate(currentDay));
        }
      }
      
      // æ‰“åˆ»ãƒ‡ãƒ¼ã‚¿ã®æ—¥ä»˜ã‚’æ­£ã—ãæ¯”è¼ƒï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’è€ƒæ…®ï¼‰
      const employeePunches = punches.filter(p => {
        // employee_idã®æ¯”è¼ƒï¼ˆUUIDã®æ–‡å­—åˆ—æ¯”è¼ƒï¼‰
        if (p.employee_id !== employee.id) {
          return false;
        }
        
        // occurred_atã®å½¢å¼: "2025-12-02 20:13:37+09" ã¾ãŸã¯ "2025-12-02T20:13:37+09:00"
        const punchDate = new Date(p.occurred_at);
        const punchDateStr = formatDate(punchDate);
        
        return dateRange.includes(punchDateStr);
      });
      
      console.log(`å¾“æ¥­å“¡ ${employee.name} (ID: ${employee.id}) ã®æ‰“åˆ»ãƒ‡ãƒ¼ã‚¿:`, {
        employeeId: employee.id,
        punchesCount: employeePunches.length,
        dateRange: dateRange,
        punches: employeePunches.map(p => ({
          type: p.type,
          occurred_at: p.occurred_at,
          employee_id: p.employee_id
        }))
      });
      
      // æ‰“åˆ»ãƒ‡ãƒ¼ã‚¿ã‚’æ™‚ç³»åˆ—ã§ã‚½ãƒ¼ãƒˆ
      employeePunches.sort((a, b) => new Date(a.occurred_at) - new Date(b.occurred_at));
      
      // å‹¤å‹™æ™‚é–“ã¨ä¼‘æ†©æ™‚é–“ã‚’è¨ˆç®—
      const workSessions = calculateWorkSessions(employeePunches);
      
      // æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã‚’ç”Ÿæˆ
      let timeSlots = [];
      if (scale === 'day') {
        timeSlots = Array.from({ length: 24 }, (_, i) => ({ hour: i, date: startDate }));
      } else if (scale === 'week') {
        const startOfWeek = new Date(startDate);
        const dayOfWeek = startDate.getDay();
        startOfWeek.setDate(startDate.getDate() - dayOfWeek);
        
        for (let day = 0; day < 7; day++) {
          const currentDay = new Date(startOfWeek);
          currentDay.setDate(startOfWeek.getDate() + day);
          
          for (let hour = 0; hour < 24; hour++) {
            timeSlots.push({ hour: hour, day: day, date: new Date(currentDay) });
          }
        }
      } else if (scale === 'month') {
        const year = startDate.getFullYear();
        const month = startDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        for (let day = 1; day <= daysInMonth; day++) {
          const currentDay = new Date(year, month, day);
          
          for (let hour = 0; hour < 24; hour++) {
            timeSlots.push({ hour: hour, day: day, date: new Date(currentDay) });
          }
        }
      }
      
      // ã‚»ãƒ«ã‚’ä½œæˆ
      timeSlots.forEach(slot => {
        const cell = document.createElement('div');
        cell.className = 'gantt-cell';
        cell.setAttribute('data-hour', slot.hour);
        if (slot.day !== undefined) {
          cell.setAttribute('data-day', slot.day);
        }
        
        // ãã®æ™‚é–“å¸¯ã®ãƒãƒ¼ã‚’è¿½åŠ 
        const bars = createBarsForHour(slot.hour, slot.date, workSessions, employeePunches);
        bars.forEach(bar => cell.appendChild(bar));
        
        row.appendChild(cell);
      });
      
      // CSSã‚°ãƒªãƒƒãƒ‰ã®åˆ—æ•°ã‚’æ›´æ–°
      const columnCount = timeSlots.length + 1; // +1ã¯ãƒ©ãƒ™ãƒ«åˆ—
      row.style.gridTemplateColumns = `180px repeat(${timeSlots.length}, minmax(20px, 1fr))`;
      
      return row;
    }

    // å‹¤å‹™ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¨ˆç®—
    function calculateWorkSessions(punches) {
      const sessions = [];
      let currentSession = null;
      
      punches.forEach(punch => {
        const punchTime = new Date(punch.occurred_at);
        
        if (punch.type === 'in') {
          currentSession = {
            start: punchTime,
            end: null,
            breaks: []
          };
        } else if (punch.type === 'out' && currentSession) {
          currentSession.end = punchTime;
          sessions.push(currentSession);
          currentSession = null;
        } else if (punch.type === 'break_in' && currentSession) {
          currentSession.breaks.push({ start: punchTime, end: null });
        } else if (punch.type === 'break_out' && currentSession && currentSession.breaks.length > 0) {
          const lastBreak = currentSession.breaks[currentSession.breaks.length - 1];
          if (!lastBreak.end) {
            lastBreak.end = punchTime;
          }
        }
      });
      
      // é€€å‹¤ãŒãªã„å ´åˆã‚‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ã—ã¦è¿½åŠ 
      if (currentSession) {
        sessions.push(currentSession);
      }
      
      console.log('å‹¤å‹™ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨ˆç®—çµæœ:', sessions.map(s => ({
        start: s.start?.toISOString(),
        end: s.end?.toISOString(),
        breaks: s.breaks.map(b => ({ start: b.start?.toISOString(), end: b.end?.toISOString() }))
      })));
      
      return sessions;
    }

    // æ™‚é–“å¸¯ã®ãƒãƒ¼ã‚’ä½œæˆ
    function createBarsForHour(hour, date, workSessions, punches) {
      const bars = [];
      
      // æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰æ™‚é–“å¸¯ã‚’è¨ˆç®—
      const hourStart = new Date(date);
      hourStart.setHours(hour, 0, 0, 0);
      const hourEnd = new Date(hourStart.getTime() + 60 * 60 * 1000);
      
      workSessions.forEach(session => {
        if (!session.start) return;
        
        const sessionStart = session.start instanceof Date ? session.start : new Date(session.start);
        const sessionEnd = session.end ? (session.end instanceof Date ? session.end : new Date(session.end)) : new Date();
        
        // ã“ã®æ™‚é–“å¸¯ã«å‹¤å‹™æ™‚é–“ãŒå«ã¾ã‚Œã‚‹ã‹
        if (sessionStart <= hourEnd && sessionEnd >= hourStart) {
          const barStart = new Date(Math.max(sessionStart.getTime(), hourStart.getTime()));
          const barEnd = new Date(Math.min(sessionEnd.getTime(), hourEnd.getTime()));
          
          // ä¼‘æ†©æ™‚é–“ã‚’é™¤å¤–
          let workStart = barStart;
          let workEnd = barEnd;
          
          session.breaks.forEach(breakTime => {
            if (breakTime.start && breakTime.end) {
              const breakStart = breakTime.start instanceof Date ? breakTime.start : new Date(breakTime.start);
              const breakEnd = breakTime.end instanceof Date ? breakTime.end : new Date(breakTime.end);
              
              if (breakStart < workEnd && breakEnd > workStart) {
                // ä¼‘æ†©æ™‚é–“ãŒã“ã®æ™‚é–“å¸¯ã«å«ã¾ã‚Œã‚‹
                if (breakStart <= hourStart && breakEnd >= hourEnd) {
                  // ä¼‘æ†©ãƒãƒ¼ã‚’è¿½åŠ 
                  const breakBar = createBreakBar(hourStart, hourEnd, breakTime);
                  bars.push(breakBar);
                  return;
                }
              }
            }
          });
          
          // å‹¤å‹™ãƒãƒ¼ã‚’ä½œæˆ
          const minutes = barStart.getMinutes() + barStart.getSeconds() / 60;
          const duration = (barEnd.getTime() - barStart.getTime()) / (60 * 60 * 1000);
          const leftPercent = (minutes / 60) * 100;
          const widthPercent = duration * 100;
          
          const bar = document.createElement('div');
          bar.className = 'gantt-bar gantt-bar-work';
          bar.style.left = `${leftPercent}%`;
          bar.style.width = `${widthPercent}%`;
          
          // å‡ºå‹¤ãƒ»é€€å‹¤æ™‚åˆ»ã‚’è¡¨ç¤º
          if (sessionStart.getHours() === hour) {
            bar.textContent = formatTime(sessionStart);
            bar.title = `å‡ºå‹¤: ${formatTime(sessionStart)}`;
          } else if (sessionEnd && sessionEnd.getHours() === hour) {
            bar.textContent = formatTime(sessionEnd);
            bar.title = `é€€å‹¤: ${formatTime(sessionEnd)}`;
          } else {
            bar.textContent = 'å‹¤å‹™ä¸­';
          }
          
          bars.push(bar);
        }
      });
      
      // ä¼‘æ†©æ™‚é–“ã®ãƒãƒ¼ã‚’è¿½åŠ 
      workSessions.forEach(session => {
        session.breaks.forEach(breakTime => {
          if (breakTime.start && breakTime.end) {
            const breakStart = breakTime.start instanceof Date ? breakTime.start : new Date(breakTime.start);
            const breakEnd = breakTime.end instanceof Date ? breakTime.end : new Date(breakTime.end);
            
            if (breakStart.getHours() === hour || breakEnd.getHours() === hour || 
                (breakStart.getHours() < hour && breakEnd.getHours() > hour)) {
              const bar = createBreakBar(hourStart, hourEnd, breakTime);
              bars.push(bar);
            }
          }
        });
      });
      
      // æ‰“åˆ»ãŒãªã„å ´åˆ
      if (punches.length === 0) {
        const bar = document.createElement('div');
        bar.className = 'gantt-bar gantt-bar-empty';
        bar.style.left = '0%';
        bar.style.width = '100%';
        bar.textContent = 'æœªæ‰“åˆ»';
        bars.push(bar);
      }
      
      return bars;
    }

    // ä¼‘æ†©ãƒãƒ¼ã‚’ä½œæˆ
    function createBreakBar(hourStart, hourEnd, breakTime) {
      const breakStart = breakTime.start instanceof Date ? breakTime.start : new Date(breakTime.start);
      const breakEnd = breakTime.end instanceof Date ? breakTime.end : new Date(breakTime.end);
      
      const barStart = new Date(Math.max(breakStart.getTime(), hourStart.getTime()));
      const barEnd = new Date(Math.min(breakEnd.getTime(), hourEnd.getTime()));
      
      const minutes = barStart.getMinutes() + barStart.getSeconds() / 60;
      const duration = (barEnd.getTime() - barStart.getTime()) / (60 * 60 * 1000);
      const leftPercent = (minutes / 60) * 100;
      const widthPercent = duration * 100;
      
      const bar = document.createElement('div');
      bar.className = 'gantt-bar gantt-bar-break';
      bar.style.left = `${leftPercent}%`;
      bar.style.width = `${widthPercent}%`;
      bar.textContent = 'ä¼‘æ†©';
      bar.title = `ä¼‘æ†©: ${formatTime(breakStart)}-${formatTime(breakEnd)}`;
      
      return bar;
    }

    // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
    function updateTitle(dateStr, scale = 'day') {
      const date = new Date(dateStr + 'T00:00:00');
      const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const title = document.getElementById('gantt-title');
      
      if (scale === 'day') {
        const weekday = weekdays[date.getDay()];
        title.textContent = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ï¼ˆ${weekday}ï¼‰`;
      } else if (scale === 'week') {
        // é€±ã®é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’è¨ˆç®—
        const startOfWeek = new Date(date);
        const dayOfWeek = date.getDay();
        startOfWeek.setDate(date.getDate() - dayOfWeek); // æ—¥æ›œæ—¥ã«èª¿æ•´
        
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        
        title.textContent = `${startOfWeek.getFullYear()}å¹´${startOfWeek.getMonth() + 1}æœˆ${startOfWeek.getDate()}æ—¥ã€œ${endOfWeek.getMonth() + 1}æœˆ${endOfWeek.getDate()}æ—¥ï¼ˆé€±ï¼‰`;
      } else if (scale === 'month') {
        title.textContent = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆï¼ˆæœˆï¼‰`;
      }
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    function setupFilterListeners() {
      const applyFilterBtn = document.getElementById('apply-filter');
      if (applyFilterBtn) {
        applyFilterBtn.addEventListener('click', async function() {
          console.log('ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
          await loadGanttData();
        });
      }
      
      // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ã®å¤‰æ›´æ™‚ã«ã‚‚è‡ªå‹•çš„ã«å†èª­ã¿è¾¼ã¿
      const dateInput = document.getElementById('filter-date');
      if (dateInput) {
        dateInput.addEventListener('change', async function() {
          console.log('æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ:', this.value);
          await loadGanttData();
        });
      }
    }

    // ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³æ©Ÿèƒ½ã‚’è¨­å®š
    function setupZoomPanControls() {
      const container = document.getElementById('gantt-container');
      const scaleSelect = document.getElementById('gantt-scale');
      const zoomInBtn = document.getElementById('zoom-in');
      const zoomOutBtn = document.getElementById('zoom-out');
      const zoomResetBtn = document.getElementById('zoom-reset');
      const panLeftBtn = document.getElementById('pan-left');
      const panRightBtn = document.getElementById('pan-right');
      const title = document.getElementById('gantt-title');

      let currentZoom = 1;
      let currentPan = 0;

      // ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´
      scaleSelect.addEventListener('change', async function() {
        const scale = this.value;
        console.log('ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´:', scale);
        
        // ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
        await loadGanttData();
      });

      // ã‚ºãƒ¼ãƒ æ©Ÿèƒ½
      zoomInBtn.addEventListener('click', function() {
        currentZoom = Math.min(currentZoom * 1.2, 3);
        applyTransform();
      });

      zoomOutBtn.addEventListener('click', function() {
        currentZoom = Math.max(currentZoom / 1.2, 0.5);
        applyTransform();
      });

      zoomResetBtn.addEventListener('click', function() {
        currentZoom = 1;
        currentPan = 0;
        applyTransform();
      });

      // ãƒ‘ãƒ³æ©Ÿèƒ½
      panLeftBtn.addEventListener('click', function() {
        currentPan -= 100;
        applyTransform();
      });

      panRightBtn.addEventListener('click', function() {
        currentPan += 100;
        applyTransform();
      });

      function applyTransform() {
        container.style.transform = `translateX(${currentPan}px) scale(${currentZoom})`;
      }

      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œï¼ˆã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
      container.setAttribute('tabindex', '0');
      container.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft') {
          currentPan -= 50;
          applyTransform();
        } else if (e.key === 'ArrowRight') {
          currentPan += 50;
          applyTransform();
        } else if (e.key === '+' || e.key === '=') {
          currentZoom = Math.min(currentZoom * 1.1, 3);
          applyTransform();
        } else if (e.key === '-') {
          currentZoom = Math.max(currentZoom / 1.1, 0.5);
          applyTransform();
        }
      });
    }
  </script>
  <script src="../scripts/common.js"></script>
</body>
</html>

