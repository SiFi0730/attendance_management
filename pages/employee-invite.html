<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾“æ¥­å“¡æ‹›å¾… - å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="../styles/common.css">
  <link rel="stylesheet" href="../styles/components.css">
  <link rel="stylesheet" href="../styles/layout.css">
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="../dashboard.html" class="header-logo">å‹¤æ€ ç®¡ç†</a>
        <nav class="header-nav">
          <a href="../dashboard.html" class="header-nav-link">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
          <a href="punch.html" class="header-nav-link">æ‰“åˆ»</a>
          <a href="gantt.html" class="header-nav-link">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</a>
          <a href="reports.html" class="header-nav-link">ãƒ¬ãƒãƒ¼ãƒˆ</a>
        </nav>
      </div>
      <div class="header-right">
        <a href="requests.html" class="header-nav-link">ç”³è«‹</a>
        <button onclick="logout()" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-sm);">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <a href="profile.html" class="header-user" style="text-decoration: none;">
          <div class="header-user-avatar"></div>
          <span class="header-user-name"></span>
        </a>
      </div>
    </div>
  </header>

  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li class="sidebar-menu-item">
        <a href="../dashboard.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“Š</span>
          <span class="sidebar-menu-label">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="punch.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">â°</span>
          <span class="sidebar-menu-label">æ‰“åˆ»</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="gantt.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“…</span>
          <span class="sidebar-menu-label">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="requests.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“</span>
          <span class="sidebar-menu-label">ç”³è«‹ãƒ»æ‰¿èª</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="employees.html" class="sidebar-menu-link active">
          <span class="sidebar-menu-icon">ğŸ‘¥</span>
          <span class="sidebar-menu-label">å¾“æ¥­å“¡ç®¡ç†</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="company-settings.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">âš™ï¸</span>
          <span class="sidebar-menu-label">ä¼æ¥­è¨­å®š</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="reports.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“ˆ</span>
          <span class="sidebar-menu-label">ãƒ¬ãƒãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="payslip.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ’°</span>
          <span class="sidebar-menu-label">çµ¦ä¸æ˜ç´°</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="audit-logs.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ”</span>
          <span class="sidebar-menu-label">ç›£æŸ»ãƒ­ã‚°</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-content">
    <div class="breadcrumb">
      <span class="breadcrumb-item"><a href="employees.html">å¾“æ¥­å“¡ç®¡ç†</a></span>
      <span class="breadcrumb-item active">å¾“æ¥­å“¡æ‹›å¾…</span>
    </div>

    <div class="page-header">
      <h1 class="page-title">å¾“æ¥­å“¡æ‹›å¾…</h1>
      <p class="page-description">æ–°ã—ã„å¾“æ¥­å“¡ã‚’æ‹›å¾…ã—ã¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç´ä»˜ã‘ã¾ã™</p>
    </div>

    <div class="card" style="max-width: 600px;">
      <div class="card-header">
        <h2 class="card-title">æ‹›å¾…æƒ…å ±</h2>
      </div>
      <div class="card-body">
        <form>
          <div class="form-group">
            <label for="employee-code" class="form-label required">ç¤¾å“¡ç•ªå·</label>
            <input 
              type="text" 
              id="employee-code" 
              name="employee-code" 
              class="form-input" 
              placeholder="EMP001"
              required
            >
          </div>

          <div class="form-group">
            <label for="name" class="form-label required">æ°å</label>
            <input 
              type="text" 
              id="name" 
              name="name" 
              class="form-input" 
              placeholder="å±±ç”°å¤ªéƒ"
              required
            >
          </div>

          <div class="form-group">
            <label for="email" class="form-label required">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              class="form-input" 
              placeholder="example@company.com"
              required
            >
            <div class="form-help">æ‹›å¾…ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã™</div>
          </div>

          <div class="form-group">
            <label for="department" class="form-label required">éƒ¨ç½²</label>
            <select id="department" name="department" class="form-select" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="sales">å–¶æ¥­éƒ¨</option>
              <option value="dev">é–‹ç™ºéƒ¨</option>
              <option value="hr">äººäº‹éƒ¨</option>
            </select>
          </div>

          <div class="form-group">
            <label for="employment-type" class="form-label required">é›‡ç”¨å½¢æ…‹</label>
            <select id="employment-type" name="employment-type" class="form-select" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="full">æ­£ç¤¾å“¡</option>
              <option value="part">ãƒ‘ãƒ¼ãƒˆ</option>
              <option value="contract">å¥‘ç´„ç¤¾å“¡</option>
            </select>
          </div>

          <div class="form-group">
            <label for="hire-date" class="form-label required">é›‡ç”¨æ—¥</label>
            <input 
              type="date" 
              id="hire-date" 
              name="hire-date" 
              class="form-input" 
              required
            >
          </div>

          <div class="form-group">
            <label for="role" class="form-label required">å½¹å‰²</label>
            <select id="role" name="role" class="form-select" required>
              <option value="employee">Employeeï¼ˆå¾“æ¥­å“¡ï¼‰</option>
              <option value="manager">Managerï¼ˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰</option>
              <option value="admin">CompanyAdminï¼ˆä¼æ¥­ç®¡ç†è€…ï¼‰</option>
            </select>
            <div class="form-help">å½¹å‰²ã«ã‚ˆã‚Šæ¨©é™ãŒç•°ãªã‚Šã¾ã™</div>
          </div>

          <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-xl);">
            <a href="employees.html" class="btn btn-secondary" style="flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
            <button type="submit" class="btn btn-primary" style="flex: 1;">æ‹›å¾…ã‚’é€ä¿¡</button>
          </div>
        </form>
      </div>
    </div>
  </main>
  <script src="../scripts/common.js"></script>
  <script>
    // ============================================
    // å¾“æ¥­å“¡æ‹›å¾… - APIé€£æº
    // ============================================

    let departments = [];

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      await loadDepartments();
      setupEventListeners();
      updateHeaderUserInfo();
    });

    // éƒ¨ç½²ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadDepartments() {
      try {
        const response = await apiFetch(`${API_BASE_URL}/departments`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          departments = data.data.items || data.data || [];
          const select = document.getElementById('department');
          if (select) {
            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            departments.forEach(dept => {
              const option = document.createElement('option');
              option.value = dept.id;
              option.textContent = dept.name;
              select.appendChild(option);
            });
          }
        }
      } catch (error) {
        console.error('éƒ¨ç½²ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    function setupEventListeners() {
      const form = document.querySelector('form');
      if (form) {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          await inviteEmployee();
        });
      }
    }

    // å¾“æ¥­å“¡ã‚’æ‹›å¾…
    async function inviteEmployee() {
      const employeeCode = document.getElementById('employee-code').value;
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const deptId = document.getElementById('department').value;
      const employmentType = document.getElementById('employment-type').value;
      const hireDate = document.getElementById('hire-date').value;
      const role = document.getElementById('role').value;

      if (!employeeCode || !name || !email || !employmentType || !hireDate || !role) {
        alert('ã™ã¹ã¦ã®å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      // é›‡ç”¨å½¢æ…‹ã®å¤‰æ›
      const employmentTypeMap = {
        'full': 'full_time',
        'part': 'part_time',
        'contract': 'contract'
      };
      const mappedEmploymentType = employmentTypeMap[employmentType] || employmentType;

      // å½¹å‰²ã®å¤‰æ›
      const roleMap = {
        'employee': 'Employee',
        'manager': 'Manager',
        'admin': 'CompanyAdmin'
      };
      const mappedRole = roleMap[role] || role;

      try {
        const requestData = {
          employee_code: employeeCode,
          name: name,
          email: email,
          dept_id: deptId || null,
          employment_type: mappedEmploymentType,
          hire_date: hireDate,
          role: mappedRole
        };

        const response = await apiFetch(`${API_BASE_URL}/employees/invite`, {
          method: 'POST',
          body: JSON.stringify(requestData)
        });

        const data = await response.json();

        if (response.ok && data.success) {
          const tempPassword = data.data.temp_password;
          alert(`å¾“æ¥­å“¡ã‚’æ‹›å¾…ã—ã¾ã—ãŸã€‚\nä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ${tempPassword}\n\nï¼ˆå®Ÿéš›ã®é‹ç”¨ã§ã¯ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡ã•ã‚Œã¾ã™ï¼‰`);
          window.location.href = 'employees.html';
        } else {
          console.error('å¾“æ¥­å“¡æ‹›å¾…ã‚¨ãƒ©ãƒ¼:', data);
          alert('å¾“æ¥­å“¡ã®æ‹›å¾…ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        console.error('å¾“æ¥­å“¡æ‹›å¾…ã‚¨ãƒ©ãƒ¼:', error);
        alert('å¾“æ¥­å“¡ã®æ‹›å¾…ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
  </script>
</body>
</html>

