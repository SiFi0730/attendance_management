<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>éƒ¨ç½²ç®¡ç† - å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="../styles/common.css">
  <link rel="stylesheet" href="../styles/components.css">
  <link rel="stylesheet" href="../styles/layout.css">
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="../dashboard.html" class="header-logo">å‹¤æ€ ç®¡ç†</a>
        <nav class="header-nav">
          <a href="../dashboard.html" class="header-nav-link">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
          <a href="punch.html" class="header-nav-link">æ‰“åˆ»</a>
          <a href="gantt.html" class="header-nav-link">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</a>
          <a href="reports.html" class="header-nav-link">ãƒ¬ãƒãƒ¼ãƒˆ</a>
        </nav>
      </div>
      <div class="header-right">
        <a href="requests.html" class="header-nav-link">ç”³è«‹</a>
        <button onclick="logout()" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-sm);">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <a href="profile.html" class="header-user" style="text-decoration: none;">
          <div class="header-user-avatar"></div>
          <span class="header-user-name"></span>
        </a>
      </div>
    </div>
  </header>

  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li class="sidebar-menu-item">
        <a href="../dashboard.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“Š</span>
          <span class="sidebar-menu-label">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="punch.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">â°</span>
          <span class="sidebar-menu-label">æ‰“åˆ»</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="gantt.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“…</span>
          <span class="sidebar-menu-label">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="requests.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“</span>
          <span class="sidebar-menu-label">ç”³è«‹ãƒ»æ‰¿èª</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="employees.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ‘¥</span>
          <span class="sidebar-menu-label">å¾“æ¥­å“¡ç®¡ç†</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="company-settings.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">âš™ï¸</span>
          <span class="sidebar-menu-label">ä¼æ¥­è¨­å®š</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="reports.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“ˆ</span>
          <span class="sidebar-menu-label">ãƒ¬ãƒãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="payslip.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ’°</span>
          <span class="sidebar-menu-label">çµ¦ä¸æ˜ç´°</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="audit-logs.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ”</span>
          <span class="sidebar-menu-label">ç›£æŸ»ãƒ­ã‚°</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-content">
    <div class="breadcrumb">
      <span class="breadcrumb-item"><a href="employees.html">å¾“æ¥­å“¡ç®¡ç†</a></span>
      <span class="breadcrumb-item active">éƒ¨ç½²ç®¡ç†</span>
    </div>

    <div class="page-header">
      <h1 class="page-title">éƒ¨ç½²ç®¡ç†</h1>
      <p class="page-description">éƒ¨ç½²ã®ä¸€è¦§ãƒ»ç™»éŒ²ãƒ»ç·¨é›†ã‚’è¡Œã„ã¾ã™</p>
      <div class="page-actions">
        <a href="#modal-new-department" class="btn btn-primary">éƒ¨ç½²ã‚’è¿½åŠ </a>
      </div>
    </div>

    <!-- éƒ¨ç½²ä¸€è¦§ -->
    <div class="card">
      <div class="card-body">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>éƒ¨ç½²å</th>
                <th>è¦ªéƒ¨ç½²</th>
                <th>å¾“æ¥­å“¡æ•°</th>
                <th>ä½œæˆæ—¥</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>å–¶æ¥­éƒ¨</td>
                <td>-</td>
                <td>25</td>
                <td>2020-01-01</td>
                <td>
                  <a href="#modal-edit-department" class="btn btn-sm btn-secondary">ç·¨é›†</a>
                  <button class="btn btn-sm btn-danger">å‰Šé™¤</button>
                </td>
              </tr>
              <tr>
                <td>é–‹ç™ºéƒ¨</td>
                <td>-</td>
                <td>18</td>
                <td>2020-01-01</td>
                <td>
                  <a href="#modal-edit-department" class="btn btn-sm btn-secondary">ç·¨é›†</a>
                  <button class="btn btn-sm btn-danger">å‰Šé™¤</button>
                </td>
              </tr>
              <tr>
                <td>äººäº‹éƒ¨</td>
                <td>-</td>
                <td>8</td>
                <td>2020-01-01</td>
                <td>
                  <a href="#modal-edit-department" class="btn btn-sm btn-secondary">ç·¨é›†</a>
                  <button class="btn btn-sm btn-danger">å‰Šé™¤</button>
                </td>
              </tr>
              <tr>
                <td>å–¶æ¥­ä¸€éƒ¨</td>
                <td>å–¶æ¥­éƒ¨</td>
                <td>12</td>
                <td>2021-04-01</td>
                <td>
                  <a href="#modal-edit-department" class="btn btn-sm btn-secondary">ç·¨é›†</a>
                  <button class="btn btn-sm btn-danger">å‰Šé™¤</button>
                </td>
              </tr>
              <tr>
                <td>å–¶æ¥­äºŒéƒ¨</td>
                <td>å–¶æ¥­éƒ¨</td>
                <td>13</td>
                <td>2021-04-01</td>
                <td>
                  <a href="#modal-edit-department" class="btn btn-sm btn-secondary">ç·¨é›†</a>
                  <button class="btn btn-sm btn-danger">å‰Šé™¤</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- æ–°è¦éƒ¨ç½²è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal-new-department" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">éƒ¨ç½²ã‚’è¿½åŠ </h2>
          <a href="#" class="modal-close">&times;</a>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group">
              <label for="dept-name" class="form-label required">éƒ¨ç½²å</label>
              <input 
                type="text" 
                id="dept-name" 
                name="dept-name" 
                class="form-input" 
                placeholder="å–¶æ¥­éƒ¨"
                required
              >
            </div>

            <div class="form-group">
              <label for="parent-dept" class="form-label">è¦ªéƒ¨ç½²</label>
              <select id="parent-dept" name="parent-dept" class="form-select">
                <option value="">ãªã—ï¼ˆãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ï¼‰</option>
                <option value="sales">å–¶æ¥­éƒ¨</option>
                <option value="dev">é–‹ç™ºéƒ¨</option>
                <option value="hr">äººäº‹éƒ¨</option>
              </select>
              <div class="form-help">éšå±¤æ§‹é€ ã‚’ä½œæˆã™ã‚‹å ´åˆã¯è¦ªéƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-secondary modal-close">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
          <button type="button" class="btn btn-primary" onclick="createDepartment()">è¿½åŠ </button>
        </div>
      </div>
    </div>

    <!-- éƒ¨ç½²ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal-edit-department" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">éƒ¨ç½²ã‚’ç·¨é›†</h2>
          <a href="#" class="modal-close">&times;</a>
        </div>
        <div class="modal-body">
          <form>
            <input type="hidden" id="edit-department-id">
            <div class="form-group">
              <label for="dept-name-edit" class="form-label required">éƒ¨ç½²å</label>
              <input 
                type="text" 
                id="dept-name-edit" 
                name="dept-name-edit" 
                class="form-input" 
                required
              >
            </div>

            <div class="form-group">
              <label for="parent-dept-edit" class="form-label">è¦ªéƒ¨ç½²</label>
              <select id="parent-dept-edit" name="parent-dept-edit" class="form-select">
                <option value="">ãªã—ï¼ˆãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ï¼‰</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-secondary modal-close">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
          <button type="button" class="btn btn-primary" onclick="updateDepartment()">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </main>
  <script src="../scripts/common.js"></script>
  <script>
    // ============================================
    // éƒ¨ç½²ç®¡ç† - APIé€£æº
    // ============================================

    let departments = [];

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      await loadDepartments();
      setupEventListeners();
      updateHeaderUserInfo();
    });

    // éƒ¨ç½²ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadDepartments() {
      try {
        const response = await apiFetch(`${API_BASE_URL}/departments`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          departments = data.data.items || data.data || [];
          renderDepartments();
          populateParentSelects();
        } else {
          console.error('éƒ¨ç½²ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', data);
          alert('éƒ¨ç½²ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('éƒ¨ç½²ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('éƒ¨ç½²ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // éƒ¨ç½²ä¸€è¦§ã‚’æç”»
    function renderDepartments() {
      const tbody = document.querySelector('.table tbody');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (departments.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="5" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">éƒ¨ç½²ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td>';
        tbody.appendChild(row);
        return;
      }

      // è¦ªéƒ¨ç½²åã‚’å–å¾—ã™ã‚‹ãƒãƒƒãƒ—ã‚’ä½œæˆ
      const deptMap = {};
      departments.forEach(dept => {
        deptMap[dept.id] = dept;
      });

      departments.forEach(dept => {
        const row = document.createElement('tr');
        const parentName = dept.parent_id && deptMap[dept.parent_id] ? deptMap[dept.parent_id].name : '-';
        const createdDate = dept.created_at ? new Date(dept.created_at).toLocaleDateString('ja-JP') : '-';

        row.innerHTML = `
          <td>${dept.name || '-'}</td>
          <td>${parentName}</td>
          <td>-</td>
          <td>${createdDate}</td>
          <td>
            <button onclick="openEditModal('${dept.id}')" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-xs);">ç·¨é›†</button>
            <button onclick="deleteDepartment('${dept.id}')" class="btn btn-sm btn-danger">å‰Šé™¤</button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // è¦ªéƒ¨ç½²ã‚»ãƒ¬ã‚¯ãƒˆã‚’è¨­å®š
    function populateParentSelects() {
      const newSelect = document.getElementById('parent-dept');
      const editSelect = document.getElementById('parent-dept-edit');
      
      [newSelect, editSelect].forEach(select => {
        if (select) {
          const currentValue = select.value;
          select.innerHTML = '<option value="">ãªã—ï¼ˆãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ï¼‰</option>';
          departments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept.id;
            option.textContent = dept.name;
            select.appendChild(option);
          });
          if (currentValue) {
            select.value = currentValue;
          }
        }
      });
    }

    // æ–°è¦éƒ¨ç½²ã‚’ä½œæˆ
    async function createDepartment() {
      const name = document.getElementById('dept-name').value;
      const parentId = document.getElementById('parent-dept').value;

      if (!name) {
        alert('éƒ¨ç½²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const requestData = {
          name: name,
          parent_id: parentId || null
        };

        const response = await apiFetch(`${API_BASE_URL}/departments`, {
          method: 'POST',
          body: JSON.stringify(requestData)
        });

        const data = await response.json();

        if (response.ok && data.success) {
          alert('éƒ¨ç½²ã‚’ä½œæˆã—ã¾ã—ãŸ');
          document.getElementById('modal-new-department').style.display = 'none';
          document.querySelector('#modal-new-department form').reset();
          await loadDepartments();
        } else {
          console.error('éƒ¨ç½²ä½œæˆã‚¨ãƒ©ãƒ¼:', data);
          alert('éƒ¨ç½²ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        console.error('éƒ¨ç½²ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        alert('éƒ¨ç½²ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    async function openEditModal(departmentId) {
      try {
        const response = await apiFetch(`${API_BASE_URL}/departments/${departmentId}`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          const dept = data.data;
          
          document.getElementById('dept-name-edit').value = dept.name || '';
          document.getElementById('parent-dept-edit').value = dept.parent_id || '';
          document.getElementById('edit-department-id').value = dept.id;
          
          // è¦ªéƒ¨ç½²ã‚»ãƒ¬ã‚¯ãƒˆã‚’æ›´æ–°
          populateParentSelects();
          document.getElementById('parent-dept-edit').value = dept.parent_id || '';
          
          document.getElementById('modal-edit-department').style.display = 'block';
        } else {
          console.error('éƒ¨ç½²è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', data);
          alert('éƒ¨ç½²æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('éƒ¨ç½²è©³ç´°ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('éƒ¨ç½²æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // éƒ¨ç½²ã‚’æ›´æ–°
    async function updateDepartment() {
      const departmentId = document.getElementById('edit-department-id').value;
      const name = document.getElementById('dept-name-edit').value;
      const parentId = document.getElementById('parent-dept-edit').value;

      if (!name) {
        alert('éƒ¨ç½²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const requestData = {
          name: name,
          parent_id: parentId || null
        };

        const response = await apiFetch(`${API_BASE_URL}/departments/${departmentId}`, {
          method: 'PUT',
          body: JSON.stringify(requestData)
        });

        const data = await response.json();

        if (response.ok && data.success) {
          alert('éƒ¨ç½²ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          document.getElementById('modal-edit-department').style.display = 'none';
          await loadDepartments();
        } else {
          console.error('éƒ¨ç½²æ›´æ–°ã‚¨ãƒ©ãƒ¼:', data);
          alert('éƒ¨ç½²ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        console.error('éƒ¨ç½²æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        alert('éƒ¨ç½²ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // éƒ¨ç½²ã‚’å‰Šé™¤
    async function deleteDepartment(departmentId) {
      if (!confirm('ã“ã®éƒ¨ç½²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        return;
      }

      try {
        const response = await apiFetch(`${API_BASE_URL}/departments/${departmentId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok && data.success) {
          alert('éƒ¨ç½²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
          await loadDepartments();
        } else {
          console.error('éƒ¨ç½²å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', data);
          alert('éƒ¨ç½²ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        console.error('éƒ¨ç½²å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('éƒ¨ç½²ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    function setupEventListeners() {
      // æ–°è¦éƒ¨ç½²è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      const newDeptLink = document.querySelector('a[href="#modal-new-department"]');
      if (newDeptLink) {
        newDeptLink.addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('modal-new-department').style.display = 'block';
        });
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      document.querySelectorAll('.modal-close').forEach(closeBtn => {
        closeBtn.addEventListener('click', function(e) {
          e.preventDefault();
          const modal = this.closest('.modal');
          if (modal) {
            modal.style.display = 'none';
          }
        });
      });

      // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            this.style.display = 'none';
          }
        });
      });
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.createDepartment = createDepartment;
    window.updateDepartment = updateDepartment;
    window.openEditModal = openEditModal;
    window.deleteDepartment = deleteDepartment;
  </script>
</body>
</html>

