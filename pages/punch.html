<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰“åˆ» - å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="../styles/common.css">
  <link rel="stylesheet" href="../styles/components.css">
  <link rel="stylesheet" href="../styles/layout.css">
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="../dashboard.html" class="header-logo">å‹¤æ€ ç®¡ç†</a>
        <nav class="header-nav">
          <a href="../dashboard.html" class="header-nav-link">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
          <a href="punch.html" class="header-nav-link active">æ‰“åˆ»</a>
          <a href="gantt.html" class="header-nav-link">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</a>
          <a href="reports.html" class="header-nav-link">ãƒ¬ãƒãƒ¼ãƒˆ</a>
        </nav>
      </div>
      <div class="header-right">
        <a href="requests.html" class="header-nav-link">ç”³è«‹</a>
        <button id="time-mode-button" onclick="showTimeModeModal()" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-sm);">ç¾å®Ÿæ™‚é–“</button>
        <button onclick="logout()" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-sm);">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <a href="profile.html" class="header-user" style="text-decoration: none;">
          <div class="header-user-avatar"></div>
          <span class="header-user-name"></span>
        </a>
      </div>
    </div>
  </header>

  <!-- æ™‚é–“ãƒ¢ãƒ¼ãƒ‰è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="time-mode-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">æ™‚é–“ãƒ¢ãƒ¼ãƒ‰è¨­å®š</h2>
        <button class="modal-close" onclick="closeTimeModeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer; margin-bottom: var(--spacing-md);">
            <input type="radio" name="time-mode" id="time-mode-realtime" value="realtime" checked style="cursor: pointer;">
            <span>ç¾å®Ÿæ™‚é–“ã‚’æ¡ç”¨</span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer; margin-bottom: var(--spacing-md);">
            <input type="radio" name="time-mode" id="time-mode-virtual" value="virtual" style="cursor: pointer;">
            <span>ä»®æƒ³æ™‚é–“ã‚’æ¡ç”¨</span>
          </label>
        </div>
        
        <div id="virtual-time-settings" style="display: none; margin-top: var(--spacing-lg); padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-md);">
          <div class="form-group">
            <label for="virtual-date" class="form-label required">æ—¥ä»˜</label>
            <input type="date" id="virtual-date" class="form-input" required>
          </div>
          <div class="form-group">
            <label for="virtual-time" class="form-label required">æ™‚åˆ»</label>
            <input type="time" id="virtual-time" class="form-input" required>
          </div>
          <div class="form-help" style="color: var(--text-secondary); font-size: var(--font-size-sm);">
            æ³¨æ„: ä»®æƒ³æ™‚é–“ã¯éå»ã®æ™‚é–“ã«æˆ»ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
          </div>
        </div>
        
        <div style="margin-top: var(--spacing-xl); padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
          <button onclick="resetDatabase()" class="btn btn-sm btn-danger" style="width: 100%;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
          <div class="form-help" style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-top: var(--spacing-xs);">
            ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€ã‚¹ã‚­ãƒ¼ãƒã‚’å†é©ç”¨ã—ã¾ã™ã€‚æ™‚é–“ãƒ¢ãƒ¼ãƒ‰ã‚‚ç¾å®Ÿæ™‚é–“ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="saveTimeMode()" class="btn btn-primary">ä¿å­˜</button>
        <button onclick="closeTimeModeModal()" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li class="sidebar-menu-item">
        <a href="../dashboard.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“Š</span>
          <span class="sidebar-menu-label">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="punch.html" class="sidebar-menu-link active">
          <span class="sidebar-menu-icon">â°</span>
          <span class="sidebar-menu-label">æ‰“åˆ»</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="gantt.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“…</span>
          <span class="sidebar-menu-label">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="requests.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“</span>
          <span class="sidebar-menu-label">ç”³è«‹ãƒ»æ‰¿èª</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="employees.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ‘¥</span>
          <span class="sidebar-menu-label">å¾“æ¥­å“¡ç®¡ç†</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="company-settings.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">âš™ï¸</span>
          <span class="sidebar-menu-label">ä¼æ¥­è¨­å®š</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="reports.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“ˆ</span>
          <span class="sidebar-menu-label">ãƒ¬ãƒãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="payslip.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ’°</span>
          <span class="sidebar-menu-label">çµ¦ä¸æ˜ç´°</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="audit-logs.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ”</span>
          <span class="sidebar-menu-label">ç›£æŸ»ãƒ­ã‚°</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-content">
    <div class="page-header">
      <h1 class="page-title">æ‰“åˆ»</h1>
      <p class="page-description">å‡ºå‹¤ãƒ»é€€å‹¤ãƒ»ä¼‘æ†©ã®æ‰“åˆ»ã‚’è¡Œã„ã¾ã™</p>
      <div class="page-actions">
        <a href="punch-proxy.html" class="btn btn-secondary">ä»£ç†æ‰“åˆ»</a>
        <button class="btn btn-sm btn-secondary" id="download-logs" title="ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" style="margin-left: var(--spacing-sm);">ğŸ“¥ ãƒ­ã‚°</button>
      </div>
    </div>

    <!-- æ‰“åˆ»ã‚«ãƒ¼ãƒ‰ -->
    <div class="grid grid-cols-2" style="margin-bottom: var(--spacing-xl);">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ä»Šæ—¥ã®æ‰“åˆ»çŠ¶æ³</h2>
        </div>
        <div class="card-body" style="text-align: center;">
          <div id="today-date" style="font-size: var(--font-size-4xl); font-weight: 700; color: var(--color-primary); margin-bottom: var(--spacing-lg);">
            -
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
            <div>
              <div style="font-size: var(--font-size-sm); color: var(--text-tertiary); margin-bottom: var(--spacing-xs);">å‡ºå‹¤</div>
              <div id="clock-in-time" style="font-size: var(--font-size-2xl); font-weight: 600;">-</div>
            </div>
            <div>
              <div style="font-size: var(--font-size-sm); color: var(--text-tertiary); margin-bottom: var(--spacing-xs);">é€€å‹¤</div>
              <div id="clock-out-time" style="font-size: var(--font-size-2xl); font-weight: 600;">-</div>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
            <div>
              <div style="font-size: var(--font-size-sm); color: var(--text-tertiary); margin-bottom: var(--spacing-xs);">ä¼‘æ†©é–‹å§‹</div>
              <div id="break-in-time" style="font-size: var(--font-size-xl); font-weight: 600;">-</div>
            </div>
            <div>
              <div style="font-size: var(--font-size-sm); color: var(--text-tertiary); margin-bottom: var(--spacing-xs);">ä¼‘æ†©çµ‚äº†</div>
              <div id="break-out-time" style="font-size: var(--font-size-xl); font-weight: 600;">-</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">æ‰“åˆ»æ“ä½œ</h2>
        </div>
        <div class="card-body" style="display: flex; flex-direction: column; gap: var(--spacing-md);">
          <button class="btn btn-primary btn-lg" style="width: 100%;" data-punch-type="in" title="æ‰“åˆ»ã‚¿ã‚¤ãƒ—: inï¼ˆå‡ºå‹¤ï¼‰">
            <span>â°</span>
            <span>å‡ºå‹¤</span>
          </button>
          <button class="btn btn-secondary btn-lg" style="width: 100%;" data-punch-type="break_in" title="æ‰“åˆ»ã‚¿ã‚¤ãƒ—: break_inï¼ˆä¼‘æ†©é–‹å§‹ï¼‰">
            <span>ğŸ½ï¸</span>
            <span>ä¼‘æ†©é–‹å§‹</span>
          </button>
          <button class="btn btn-secondary btn-lg" style="width: 100%;" data-punch-type="break_out" title="æ‰“åˆ»ã‚¿ã‚¤ãƒ—: break_outï¼ˆä¼‘æ†©çµ‚äº†ï¼‰">
            <span>â˜•</span>
            <span>ä¼‘æ†©çµ‚äº†</span>
          </button>
          <button class="btn btn-success btn-lg" style="width: 100%;" data-punch-type="out" title="æ‰“åˆ»ã‚¿ã‚¤ãƒ—: outï¼ˆé€€å‹¤ï¼‰">
            <span>ğŸ </span>
            <span>é€€å‹¤</span>
          </button>
          <div class="form-help" style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-top: var(--spacing-xs); text-align: center;">
            æ‰“åˆ»ã‚¿ã‚¤ãƒ—: inï¼ˆå‡ºå‹¤ï¼‰/ outï¼ˆé€€å‹¤ï¼‰/ break_inï¼ˆä¼‘æ†©é–‹å§‹ï¼‰/ break_outï¼ˆä¼‘æ†©çµ‚äº†ï¼‰<br>
            ä»•æ§˜æ›¸5.4ã«åŸºã¥ã
          </div>
        </div>
      </div>
    </div>

    <!-- æœªæ‰“åˆ»ã‚¢ãƒ©ãƒ¼ãƒˆ -->
    <div id="no-punch-alert" class="alert alert-warning" style="margin-bottom: var(--spacing-xl); display: none;">
      <strong>æ³¨æ„:</strong> æœ¬æ—¥ã®é€€å‹¤æ‰“åˆ»ãŒã¾ã è¡Œã‚ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é€€å‹¤æ™‚åˆ»ã«ãªã£ãŸã‚‰å¿˜ã‚Œãšã«æ‰“åˆ»ã—ã¦ãã ã•ã„ã€‚
    </div>

    <!-- æœ€è¿‘ã®æ‰“åˆ»å±¥æ­´ -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">æœ€è¿‘ã®æ‰“åˆ»å±¥æ­´</h2>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>æ—¥ä»˜</th>
                <th>ç¨®é¡</th>
                <th>æ‰“åˆ»ã‚¿ã‚¤ãƒ—</th>
                <th>æ™‚åˆ»</th>
                <th>æ‰“åˆ»æ–¹æ³•ï¼ˆsourceï¼‰</th>
                <th>å‚™è€ƒ</th>
              </tr>
            </thead>
            <tbody id="punch-history-tbody">
              <tr>
                <td colspan="6" style="text-align: center; color: var(--text-secondary);">èª­ã¿è¾¼ã¿ä¸­...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
  <script src="../scripts/common.js"></script>
  <script>
    // ============================================
    // æ‰“åˆ»ãƒšãƒ¼ã‚¸ - APIé€£æº
    // ============================================

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      await initializePunchPage();
      
      // ä»®æƒ³æ™‚é–“ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
      setupTimeModeChangeListener();
      
      // ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®è¨­å®š
      setupLogDownloadButton();
    });
    
    // ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®è¨­å®š
    function setupLogDownloadButton() {
      const downloadBtn = document.getElementById('download-logs');
      if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
          const format = prompt('ãƒ­ã‚°ã®å½¢å¼ã‚’é¸æŠã—ã¦ãã ã•ã„:\n1. JSON (æ¨å¥¨)\n2. TXT\n3. CSV\n\nç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (1-3):', '1');
          
          if (format === '1' || format === 'json' || format === '') {
            downloadLogs('json');
          } else if (format === '2' || format === 'txt') {
            downloadLogs('txt');
          } else if (format === '3' || format === 'csv') {
            downloadLogs('csv');
          } else {
            alert('ç„¡åŠ¹ãªå½¢å¼ã§ã™ã€‚JSONå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚');
            downloadLogs('json');
          }
        });
      }
    }
    
    // ä»®æƒ³æ™‚é–“ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    function setupTimeModeChangeListener() {
      // localStorageã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆåˆ¥ã‚¿ãƒ–ã§ã®å¤‰æ›´ã‚‚æ¤œçŸ¥ï¼‰
      window.addEventListener('storage', function(e) {
        if (e.key === TIME_MODE_STORAGE_KEY || e.key === VIRTUAL_TIME_STORAGE_KEY) {
          // æ™‚é–“ãƒ¢ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
          loadTodayPunches();
          loadPunchHistory();
        }
      });
      
      // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã§æ™‚é–“ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ã‚’æ¤œçŸ¥
      window.addEventListener('timeModeChanged', function() {
        loadTodayPunches();
        loadPunchHistory();
      });
    }

    // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
    async function initializePunchPage() {
      // æ‰“åˆ»ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      setupPunchButtons();
      
      // ä»Šæ—¥ã®æ‰“åˆ»çŠ¶æ³ã‚’èª­ã¿è¾¼ã¿
      await loadTodayPunches();
      
      // æ‰“åˆ»å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
      await loadPunchHistory();
    }

    // æ‰“åˆ»ãƒœã‚¿ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupPunchButtons() {
      const punchButtons = document.querySelectorAll('[data-punch-type]');
      
      punchButtons.forEach(button => {
        button.addEventListener('click', async function() {
          const punchType = this.getAttribute('data-punch-type');
          await handlePunch(punchType);
        });
      });
    }

    // æ‰“åˆ»å‡¦ç†
    async function handlePunch(punchType) {
      const button = document.querySelector(`[data-punch-type="${punchType}"]`);
      const originalText = button.innerHTML;
      
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      button.disabled = true;
      button.style.opacity = '0.6';
      button.style.cursor = 'not-allowed';
      
      try {
        // ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—ï¼ˆä»®æƒ³æ™‚é–“ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼‰
        const currentTime = getCurrentTime();
        const occurredAt = formatDateTimeForAPI(currentTime);
        
        // æ‰“åˆ»ç¨®é¡ã®æ—¥æœ¬èªå
        const typeNames = {
          'in': 'å‡ºå‹¤',
          'out': 'é€€å‹¤',
          'break_in': 'ä¼‘æ†©é–‹å§‹',
          'break_out': 'ä¼‘æ†©çµ‚äº†'
        };
        
        const requestBody = {
          type: punchType,
          occurred_at: occurredAt,
          note: typeNames[punchType] || punchType,
          device: navigator.userAgent
        };
        
        const response = await apiFetch(`${API_BASE_URL}/punches`, {
          method: 'POST',
          body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          showMessage('æ‰“åˆ»ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
          
          // ä»Šæ—¥ã®æ‰“åˆ»çŠ¶æ³ã¨å±¥æ­´ã‚’æ›´æ–°
          await loadTodayPunches();
          await loadPunchHistory();
        } else {
          // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          const errorMsg = data.error?.message || 'æ‰“åˆ»ã«å¤±æ•—ã—ã¾ã—ãŸ';
          showMessage(errorMsg, 'error');
        }
      } catch (error) {
        console.error('æ‰“åˆ»ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('æ‰“åˆ»ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      } finally {
        // ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
        button.disabled = false;
        button.style.opacity = '1';
        button.style.cursor = 'pointer';
      }
    }

    // ä»Šæ—¥ã®æ‰“åˆ»çŠ¶æ³ã‚’èª­ã¿è¾¼ã¿
    async function loadTodayPunches() {
      try {
        const today = getCurrentTime(); // ä»®æƒ³æ™‚é–“ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ
        const todayStr = formatDate(today);
        const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
        const tomorrowStr = formatDate(tomorrow);
        
        const response = await apiFetch(`${API_BASE_URL}/punches?from=${todayStr} 00:00:00&to=${tomorrowStr} 00:00:00&limit=100`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          updateTodayPunchesDisplay(data.data.items, todayStr);
        }
      } catch (error) {
        console.error('ä»Šæ—¥ã®æ‰“åˆ»çŠ¶æ³ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ä»Šæ—¥ã®æ‰“åˆ»çŠ¶æ³ã‚’è¡¨ç¤ºæ›´æ–°
    function updateTodayPunchesDisplay(punches, dateStr) {
      // æ—¥ä»˜ã‚’æ›´æ–°
      const dateElement = document.getElementById('today-date');
      if (dateElement) {
        dateElement.textContent = dateStr;
      }
      
      // æ‰“åˆ»ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†
      const todayPunches = {
        in: null,
        out: null,
        break_in: [],
        break_out: []
      };
      
      punches.forEach(punch => {
        if (punch.type === 'in') {
          todayPunches.in = punch;
        } else if (punch.type === 'out') {
          todayPunches.out = punch;
        } else if (punch.type === 'break_in') {
          todayPunches.break_in.push(punch);
        } else if (punch.type === 'break_out') {
          todayPunches.break_out.push(punch);
        }
      });
      
      // å‡ºå‹¤æ™‚åˆ»ã‚’è¡¨ç¤º
      const clockInElement = document.getElementById('clock-in-time');
      if (clockInElement) {
        clockInElement.textContent = todayPunches.in 
          ? formatTime(todayPunches.in.occurred_at) 
          : '-';
      }
      
      // é€€å‹¤æ™‚åˆ»ã‚’è¡¨ç¤º
      const clockOutElement = document.getElementById('clock-out-time');
      if (clockOutElement) {
        clockOutElement.textContent = todayPunches.out 
          ? formatTime(todayPunches.out.occurred_at) 
          : '-';
      }
      
      // ä¼‘æ†©é–‹å§‹æ™‚åˆ»ã‚’è¡¨ç¤ºï¼ˆæœ€æ–°ã®ã‚‚ã®ï¼‰
      const breakInElement = document.getElementById('break-in-time');
      if (breakInElement) {
        const latestBreakIn = todayPunches.break_in.length > 0 
          ? todayPunches.break_in[todayPunches.break_in.length - 1]
          : null;
        breakInElement.textContent = latestBreakIn 
          ? formatTime(latestBreakIn.occurred_at) 
          : '-';
      }
      
      // ä¼‘æ†©çµ‚äº†æ™‚åˆ»ã‚’è¡¨ç¤ºï¼ˆæœ€æ–°ã®ã‚‚ã®ï¼‰
      const breakOutElement = document.getElementById('break-out-time');
      if (breakOutElement) {
        const latestBreakOut = todayPunches.break_out.length > 0 
          ? todayPunches.break_out[todayPunches.break_out.length - 1]
          : null;
        breakOutElement.textContent = latestBreakOut 
          ? formatTime(latestBreakOut.occurred_at) 
          : '-';
      }
      
      // æœªæ‰“åˆ»ã‚¢ãƒ©ãƒ¼ãƒˆã®è¡¨ç¤º/éè¡¨ç¤º
      const alertElement = document.getElementById('no-punch-alert');
      if (alertElement) {
        if (!todayPunches.out) {
          alertElement.style.display = 'block';
        } else {
          alertElement.style.display = 'none';
        }
      }
    }

    // æ‰“åˆ»å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
    async function loadPunchHistory() {
      try {
        const today = getCurrentTime(); // ä»®æƒ³æ™‚é–“ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ
        const fromDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000); // 7æ—¥å‰
        const fromStr = formatDate(fromDate) + ' 00:00:00';
        const toStr = formatDate(today) + ' 23:59:59';
        
        const response = await apiFetch(`${API_BASE_URL}/punches?from=${fromStr}&to=${toStr}&limit=50`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          updatePunchHistoryDisplay(data.data.items);
        }
      } catch (error) {
        console.error('æ‰“åˆ»å±¥æ­´ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // æ‰“åˆ»å±¥æ­´ã‚’è¡¨ç¤ºæ›´æ–°
    function updatePunchHistoryDisplay(punches) {
      const tbody = document.getElementById('punch-history-tbody');
      if (!tbody) return;
      
      // æ—¢å­˜ã®è¡Œã‚’ã‚¯ãƒªã‚¢
      tbody.innerHTML = '';
      
      if (punches.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="6" style="text-align: center; color: var(--text-secondary);">æ‰“åˆ»å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</td>';
        tbody.appendChild(row);
        return;
      }
      
      // æ‰“åˆ»ãƒ‡ãƒ¼ã‚¿ã‚’æ™‚ç³»åˆ—ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
      const sortedPunches = [...punches].sort((a, b) => {
        return new Date(b.occurred_at) - new Date(a.occurred_at);
      });
      
      sortedPunches.forEach(punch => {
        const row = document.createElement('tr');
        
        const date = new Date(punch.occurred_at);
        const dateStr = formatDate(date);
        const timeStr = formatTime(punch.occurred_at);
        
        const typeNames = {
          'in': { name: 'å‡ºå‹¤', badge: 'badge-primary' },
          'out': { name: 'é€€å‹¤', badge: 'badge-success' },
          'break_in': { name: 'ä¼‘æ†©é–‹å§‹', badge: 'badge-info' },
          'break_out': { name: 'ä¼‘æ†©çµ‚äº†', badge: 'badge-info' }
        };
        
        const typeInfo = typeNames[punch.type] || { name: punch.type, badge: 'badge-secondary' };
        
        row.innerHTML = `
          <td>${dateStr}</td>
          <td><span class="badge ${typeInfo.badge}">${typeInfo.name}</span></td>
          <td><code>${punch.type}</code></td>
          <td>${timeStr}</td>
          <td>${punch.source || 'web'}</td>
          <td>${punch.note || '-'}</td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // æ³¨æ„: formatDateTimeForAPI, formatDate, formatTime ã¯ common.js ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    function showMessage(message, type) {
      // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
      const existingMessage = document.querySelector('.punch-message');
      if (existingMessage) {
        existingMessage.remove();
      }
      
      // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
      const messageDiv = document.createElement('div');
      messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} punch-message`;
      messageDiv.style.marginBottom = 'var(--spacing-md)';
      messageDiv.textContent = message;
      
      // ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸‹ã«æŒ¿å…¥
      const pageHeader = document.querySelector('.page-header');
      if (pageHeader && pageHeader.parentNode) {
        pageHeader.parentNode.insertBefore(messageDiv, pageHeader.nextSibling);
      }
      
      // 3ç§’å¾Œã«è‡ªå‹•çš„ã«å‰Šé™¤
      setTimeout(() => {
        messageDiv.remove();
      }, 3000);
    }
  </script>
</body>
</html>

