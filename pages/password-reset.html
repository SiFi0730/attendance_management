<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>パスワードリセット - 勤怠管理システム</title>
  <link rel="stylesheet" href="../styles/common.css">
  <link rel="stylesheet" href="../styles/components.css">
  <link rel="stylesheet" href="../styles/layout.css">
</head>
<body>
  <div class="auth-layout">
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <div class="auth-logo">勤怠管理</div>
          <h1 class="auth-title">パスワードリセット</h1>
          <p class="auth-subtitle">メールアドレスを入力してください</p>
        </div>

        <!-- ステップ1: メールアドレス入力 -->
        <div id="step1">
          <form id="requestResetForm">
            <div class="form-group">
              <label for="email" class="form-label required">メールアドレス</label>
              <input 
                type="email" 
                id="email" 
                name="email" 
                class="form-input" 
                placeholder="example@company.com"
                required
              >
            </div>

            <div id="errorMessage" class="alert alert-error" style="display: none; margin-bottom: var(--spacing-md);"></div>
            <div id="successMessage" class="alert alert-success" style="display: none; margin-bottom: var(--spacing-md);"></div>

            <button type="submit" class="btn btn-primary w-full" style="margin-top: var(--spacing-lg);" id="submitBtn">
              リセットメールを送信
            </button>
          </form>
        </div>

        <!-- ステップ2: トークン入力とパスワード設定 -->
        <div id="step2" style="display: none;">
          <form id="resetPasswordForm">
            <div class="form-group">
              <label for="token" class="form-label required">リセットトークン</label>
              <input 
                type="text" 
                id="token" 
                name="token" 
                class="form-input" 
                placeholder="メールに記載されたトークンを入力"
                required
              >
            </div>

            <div class="form-group">
              <label for="password" class="form-label required">新しいパスワード</label>
              <input 
                type="password" 
                id="password" 
                name="password" 
                class="form-input" 
                placeholder="••••••••"
                required
                minlength="8"
              >
              <div class="form-help" style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-top: var(--spacing-xs);">
                8文字以上、大文字・小文字・数字・記号を含む必要があります
              </div>
            </div>

            <div class="form-group">
              <label for="password_confirm" class="form-label required">パスワード（確認）</label>
              <input 
                type="password" 
                id="password_confirm" 
                name="password_confirm" 
                class="form-input" 
                placeholder="••••••••"
                required
              >
            </div>

            <div id="errorMessage2" class="alert alert-error" style="display: none; margin-bottom: var(--spacing-md);"></div>
            <div id="successMessage2" class="alert alert-success" style="display: none; margin-bottom: var(--spacing-md);"></div>

            <button type="submit" class="btn btn-primary w-full" style="margin-top: var(--spacing-lg);" id="submitBtn2">
              パスワードをリセット
            </button>
          </form>
        </div>

        <div class="auth-footer">
          <p><a href="../index.html">ログインに戻る</a></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:8080/api.php';

    // URLパラメータからトークンを取得
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    if (token) {
      document.getElementById('step1').style.display = 'none';
      document.getElementById('step2').style.display = 'block';
      document.getElementById('token').value = token;
    }

    // ステップ1: リセット要求
    document.getElementById('requestResetForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');

      errorMessage.style.display = 'none';
      successMessage.style.display = 'none';

      const formData = {
        email: document.getElementById('email').value,
      };

      submitBtn.disabled = true;
      submitBtn.textContent = '送信中...';

      try {
        const response = await fetch(`${API_BASE_URL}/auth/password-reset`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData),
        });

        const data = await response.json();

        if (response.ok) {
          successMessage.textContent = data.message || 'パスワードリセットメールを送信しました';
          successMessage.style.display = 'block';
          
          // 開発環境ではトークンを表示
          if (data.data && data.data.token) {
            successMessage.innerHTML += '<br><br><strong>開発環境用トークン:</strong><br><code style="word-break: break-all;">' + data.data.token + '</code><br><br><a href="?token=' + data.data.token + '">このリンクをクリックしてパスワードをリセット</a>';
          }
        } else {
          errorMessage.textContent = data.error?.message || 'リセット要求に失敗しました';
          errorMessage.style.display = 'block';
        }
      } catch (error) {
        errorMessage.textContent = 'ネットワークエラーが発生しました: ' + error.message;
        errorMessage.style.display = 'block';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'リセットメールを送信';
      }
    });

    // ステップ2: パスワードリセット実行
    document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn2');
      const errorMessage = document.getElementById('errorMessage2');
      const successMessage = document.getElementById('successMessage2');

      errorMessage.style.display = 'none';
      successMessage.style.display = 'none';

      // パスワード確認
      const password = document.getElementById('password').value;
      const passwordConfirm = document.getElementById('password_confirm').value;

      if (password !== passwordConfirm) {
        errorMessage.textContent = 'パスワードが一致しません';
        errorMessage.style.display = 'block';
        return;
      }

      const formData = {
        token: document.getElementById('token').value,
        password: password,
      };

      submitBtn.disabled = true;
      submitBtn.textContent = 'リセット中...';

      try {
        const response = await fetch(`${API_BASE_URL}/auth/password-reset/verify`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData),
        });

        const data = await response.json();

        if (response.ok) {
          successMessage.textContent = data.message || 'パスワードをリセットしました';
          successMessage.style.display = 'block';
          
          // 3秒後にログインページにリダイレクト
          setTimeout(() => {
            window.location.href = '../index.html';
          }, 3000);
        } else {
          errorMessage.textContent = data.error?.message || 'パスワードリセットに失敗しました';
          errorMessage.style.display = 'block';
          submitBtn.disabled = false;
          submitBtn.textContent = 'パスワードをリセット';
        }
      } catch (error) {
        errorMessage.textContent = 'ネットワークエラーが発生しました: ' + error.message;
        errorMessage.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'パスワードをリセット';
      }
    });
  </script>
</body>
</html>
