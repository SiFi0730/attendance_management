<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š - å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="../styles/common.css">
  <link rel="stylesheet" href="../styles/components.css">
  <link rel="stylesheet" href="../styles/layout.css">
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="../dashboard.html" class="header-logo">å‹¤æ€ ç®¡ç†</a>
        <nav class="header-nav">
          <a href="../dashboard.html" class="header-nav-link">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
          <a href="punch.html" class="header-nav-link">æ‰“åˆ»</a>
          <a href="gantt.html" class="header-nav-link">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</a>
          <a href="reports.html" class="header-nav-link">ãƒ¬ãƒãƒ¼ãƒˆ</a>
        </nav>
      </div>
      <div class="header-right">
        <a href="requests.html" class="header-nav-link">ç”³è«‹</a>
        <button id="time-mode-button" onclick="showTimeModeModal()" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-sm);">ç¾å®Ÿæ™‚é–“</button>
        <button onclick="logout()" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-sm);">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <a href="profile.html" class="header-user" style="text-decoration: none;">
          <div class="header-user-avatar"></div>
          <span class="header-user-name"></span>
        </a>
      </div>
    </div>
  </header>

  <!-- æ™‚é–“ãƒ¢ãƒ¼ãƒ‰è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="time-mode-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">æ™‚é–“ãƒ¢ãƒ¼ãƒ‰è¨­å®š</h2>
        <button class="modal-close" onclick="closeTimeModeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer; margin-bottom: var(--spacing-md);">
            <input type="radio" name="time-mode" id="time-mode-realtime" value="realtime" checked style="cursor: pointer;">
            <span>ç¾å®Ÿæ™‚é–“ã‚’æ¡ç”¨</span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer; margin-bottom: var(--spacing-md);">
            <input type="radio" name="time-mode" id="time-mode-virtual" value="virtual" style="cursor: pointer;">
            <span>ä»®æƒ³æ™‚é–“ã‚’æ¡ç”¨</span>
          </label>
        </div>
        
        <div id="virtual-time-settings" style="display: none; margin-top: var(--spacing-lg); padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-md);">
          <div class="form-group">
            <label for="virtual-date" class="form-label required">æ—¥ä»˜</label>
            <input type="date" id="virtual-date" class="form-input" required>
          </div>
          <div class="form-group">
            <label for="virtual-time" class="form-label required">æ™‚åˆ»</label>
            <input type="time" id="virtual-time" class="form-input" required>
          </div>
          <div class="form-help" style="color: var(--text-secondary); font-size: var(--font-size-sm);">
            æ³¨æ„: ä»®æƒ³æ™‚é–“ã¯éå»ã®æ™‚é–“ã«æˆ»ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
          </div>
        </div>
        
        <div style="margin-top: var(--spacing-xl); padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
          <button onclick="resetDatabase()" class="btn btn-sm btn-danger" style="width: 100%;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
          <div class="form-help" style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-top: var(--spacing-xs);">
            ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€ã‚¹ã‚­ãƒ¼ãƒã‚’å†é©ç”¨ã—ã¾ã™ã€‚æ™‚é–“ãƒ¢ãƒ¼ãƒ‰ã‚‚ç¾å®Ÿæ™‚é–“ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="saveTimeMode()" class="btn btn-primary">ä¿å­˜</button>
        <button onclick="closeTimeModeModal()" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li class="sidebar-menu-item">
        <a href="../dashboard.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“Š</span>
          <span class="sidebar-menu-label">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="punch.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">â°</span>
          <span class="sidebar-menu-label">æ‰“åˆ»</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="gantt.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“…</span>
          <span class="sidebar-menu-label">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="requests.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“</span>
          <span class="sidebar-menu-label">ç”³è«‹ãƒ»æ‰¿èª</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="employees.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ‘¥</span>
          <span class="sidebar-menu-label">å¾“æ¥­å“¡ç®¡ç†</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="company-settings.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">âš™ï¸</span>
          <span class="sidebar-menu-label">ä¼æ¥­è¨­å®š</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="reports.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“ˆ</span>
          <span class="sidebar-menu-label">ãƒ¬ãƒãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="payslip.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ’°</span>
          <span class="sidebar-menu-label">çµ¦ä¸æ˜ç´°</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="audit-logs.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ”</span>
          <span class="sidebar-menu-label">ç›£æŸ»ãƒ­ã‚°</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-content">
    <div class="page-header">
      <h1 class="page-title">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h1>
      <p class="page-description">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç®¡ç†ã—ã¾ã™</p>
    </div>

    <!-- ã‚¿ãƒ– -->
    <div class="tabs">
      <ul class="tab-list">
        <li class="tab-item"><a href="#tab-profile" class="tab-link">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a></li>
        <li class="tab-item"><a href="#tab-password" class="tab-link">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</a></li>
        <li class="tab-item"><a href="#tab-notifications" class="tab-link">é€šçŸ¥è¨­å®š</a></li>
      </ul>
    </div>

    <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¿ãƒ– -->
    <div id="tab-profile" class="tab-content card">
      <div class="card-header">
        <h2 class="card-title">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±</h2>
      </div>
      <div class="card-body">
        <form>
          <div class="form-group">
            <label for="profile-name" class="form-label required">æ°å</label>
            <input 
              type="text" 
              id="profile-name" 
              name="profile-name" 
              class="form-input" 
              value=""
              required
            >
          </div>

          <div class="form-group">
            <label for="profile-email" class="form-label required">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input 
              type="email" 
              id="profile-email" 
              name="profile-email" 
              class="form-input" 
              value=""
              required
            >
          </div>

          <div class="form-group">
            <label for="profile-phone" class="form-label">é›»è©±ç•ªå·</label>
            <input 
              type="tel" 
              id="profile-phone" 
              name="profile-phone" 
              class="form-input" 
              value=""
              placeholder="æœªç™»éŒ²"
            >
          </div>

          <div class="form-group">
            <label for="profile-timezone" class="form-label required">ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³</label>
            <select id="profile-timezone" name="profile-timezone" class="form-select" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
              <option value="UTC">UTC</option>
              <option value="America/New_York">America/New_York (EST)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="profile-locale" class="form-label required">è¨€èª</label>
            <select id="profile-locale" name="profile-locale" class="form-select" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="ja">æ—¥æœ¬èª</option>
              <option value="en">English</option>
            </select>
          </div>

          <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-xl);">
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            <button type="button" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚¿ãƒ– -->
    <div id="tab-password" class="tab-content card">
      <div class="card-header">
        <h2 class="card-title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h2>
      </div>
      <div class="card-body">
        <form>
          <div class="form-group">
            <label for="current-password" class="form-label required">ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input 
              type="password" 
              id="current-password" 
              name="current-password" 
              class="form-input" 
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
              required
            >
          </div>

          <div class="form-group">
            <label for="new-password" class="form-label required">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input 
              type="password" 
              id="new-password" 
              name="new-password" 
              class="form-input" 
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
              required
            >
            <div class="form-help">8æ–‡å­—ä»¥ä¸Šã€è‹±æ•°å­—ã¨è¨˜å·ã‚’å«ã‚€</div>
          </div>

          <div class="form-group">
            <label for="confirm-password" class="form-label required">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
            <input 
              type="password" 
              id="confirm-password" 
              name="confirm-password" 
              class="form-input" 
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
              required
            >
          </div>

          <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-xl);">
            <button type="submit" class="btn btn-primary">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>
            <button type="button" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </form>
      </div>
    </div>

    <!-- é€šçŸ¥è¨­å®šã‚¿ãƒ– -->
    <div id="tab-notifications" class="tab-content card">
      <div class="card-header">
        <h2 class="card-title">é€šçŸ¥è¨­å®š</h2>
      </div>
      <div class="card-body">
        <form>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer; margin-bottom: var(--spacing-md);">
              <input type="checkbox" name="notify-approval" checked style="cursor: pointer;">
              <span>ç”³è«‹ã®æ‰¿èªãƒ»å·®æˆ»ã—é€šçŸ¥ã‚’å—ã‘å–ã‚‹</span>
            </label>
          </div>

          <div class="form-group">
            <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer; margin-bottom: var(--spacing-md);">
              <input type="checkbox" name="notify-reminder" checked style="cursor: pointer;">
              <span>æœªæ‰“åˆ»ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’å—ã‘å–ã‚‹</span>
            </label>
          </div>

          <div class="form-group">
            <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer; margin-bottom: var(--spacing-md);">
              <input type="checkbox" name="notify-deadline" checked style="cursor: pointer;">
              <span>ç· æ—¥å‰ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’å—ã‘å–ã‚‹</span>
            </label>
          </div>

          <div class="form-group">
            <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer; margin-bottom: var(--spacing-md);">
              <input type="checkbox" name="notify-holiday" style="cursor: pointer;">
              <span>ä¼‘æ—¥å‡ºå‹¤æ¤œçŸ¥é€šçŸ¥ã‚’å—ã‘å–ã‚‹</span>
            </label>
          </div>

          <div class="form-group">
            <label for="notification-email" class="form-label">é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input 
              type="email" 
              id="notification-email" 
              name="notification-email" 
              class="form-input" 
              value=""
              placeholder="æœªç™»éŒ²ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ãƒ­ã‚°ã‚¤ãƒ³ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰"
            >
            <div class="form-help">é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡å…ˆã‚’æŒ‡å®šã§ãã¾ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ãƒ­ã‚°ã‚¤ãƒ³ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰</div>
          </div>

          <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-xl);">
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            <button type="button" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </form>
      </div>
    </div>
  </main>
  <script src="../scripts/common.js"></script>
  <script>
    // ============================================
    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šãƒšãƒ¼ã‚¸ - APIé€£æº
    // ============================================
    // æ³¨æ„: API_BASE_URLã¯common.jsã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        console.log('Profile page loaded, loading user profile...');
        await loadUserProfile();
        setupFormHandlers();
      } catch (error) {
        console.error('Error initializing profile page:', error);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ•ã‚©ãƒ¼ãƒ ã¯è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
        setupFormHandlers();
      }
    });
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«è¡¨ç¤º
    async function loadUserProfile() {
      try {
        const response = await apiFetch(`${API_BASE_URL}/auth/me`, {
          method: 'GET',
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            // èªè¨¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            window.location.href = '../index.html';
            return;
          }
          throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        const result = await response.json();
        console.log('User profile API response:', result);
        
        if (result.success && result.data && result.data.user) {
          const user = result.data.user;
          console.log('User data:', user);
          
          // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
          const nameInput = document.getElementById('profile-name');
          const emailInput = document.getElementById('profile-email');
          
          if (nameInput) {
            nameInput.value = user.name || '';
          }
          if (emailInput) {
            emailInput.value = user.email || '';
          }
          
          // é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰
          const notificationEmailInput = document.getElementById('notification-email');
          if (notificationEmailInput) {
            notificationEmailInput.value = user.email || '';
          }
          
          // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚‚æ›´æ–°
          updateHeaderUserInfo(user.name, user.email);
          
          // ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—ã—ã¦ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã¨è¨€èªã‚’è¨­å®š
          if (user.tenant_id) {
            await loadTenantInfo(user.tenant_id);
          } else {
            console.warn('No tenant_id found for user');
          }
        } else {
          console.error('Invalid response format:', result);
        }
      } catch (error) {
        console.error('Error loading user profile:', error);
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }
    
    // ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—ã—ã¦ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã¨è¨€èªã‚’è¨­å®š
    async function loadTenantInfo(tenantId) {
      try {
        console.log('Loading tenant info for tenant_id:', tenantId);
        const response = await apiFetch(`${API_BASE_URL}/tenants/${tenantId}`, {
          method: 'GET',
        });
        
        console.log('Tenant API response status:', response.status);
        
        if (response.ok) {
          const result = await response.json();
          console.log('Tenant API response:', result);
          
          // TenantController::show()ã¯ç›´æ¥ãƒ†ãƒŠãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™ã®ã§ã€result.dataãŒãƒ†ãƒŠãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
          const tenant = result.success && result.data ? result.data : null;
          
          if (tenant) {
            console.log('Tenant data:', tenant);
            
            // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’è¨­å®š
            if (tenant.timezone) {
              const timezoneSelect = document.getElementById('profile-timezone');
              if (timezoneSelect) {
                timezoneSelect.value = tenant.timezone;
                console.log('Set timezone to:', tenant.timezone);
              }
            }
            
            // è¨€èªã‚’è¨­å®š
            if (tenant.locale) {
              const localeSelect = document.getElementById('profile-locale');
              if (localeSelect) {
                localeSelect.value = tenant.locale;
                console.log('Set locale to:', tenant.locale);
              }
            }
          } else {
            console.error('Invalid tenant response format:', result);
          }
        } else {
          const errorText = await response.text();
          console.error('Failed to load tenant info:', response.status, errorText);
        }
      } catch (error) {
        console.error('Error loading tenant info:', error);
        // ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã®å–å¾—å¤±æ•—ã¯ç„¡è¦–ï¼ˆå¿…é ˆã§ã¯ãªã„ï¼‰
      }
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®è¨­å®š
    function setupFormHandlers() {
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°ãƒ•ã‚©ãƒ¼ãƒ 
      const profileForm = document.querySelector('#tab-profile form');
      if (profileForm) {
        profileForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          await updateProfile();
        });
      }
      
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ•ã‚©ãƒ¼ãƒ 
      const passwordForm = document.querySelector('#tab-password form');
      if (passwordForm) {
        passwordForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          await changePassword();
        });
      }
      
      // é€šçŸ¥è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
      const notificationForm = document.querySelector('#tab-notifications form');
      if (notificationForm) {
        notificationForm.addEventListener('submit', function(e) {
          e.preventDefault();
          alert('é€šçŸ¥è¨­å®šæ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™');
        });
      }
    }
    
    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°
    async function updateProfile() {
      const name = document.getElementById('profile-name').value.trim();
      const email = document.getElementById('profile-email').value.trim();
      
      if (!name || !email) {
        alert('æ°åã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™');
        return;
      }
      
      try {
        const response = await apiFetch(`${API_BASE_URL}/auth/me`, {
          method: 'PUT',
          body: JSON.stringify({
            name: name,
            email: email,
          }),
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error?.message || 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        if (result.success) {
          alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚‚æ›´æ–°
          updateHeaderUserInfo(name, email);
        }
      } catch (error) {
        console.error('Error updating profile:', error);
        alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }
    
    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
    async function changePassword() {
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      if (!currentPassword || !newPassword || !confirmPassword) {
        alert('ã™ã¹ã¦ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        alert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ç¢ºèªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
        return;
      }
      
      try {
        const response = await apiFetch(`${API_BASE_URL}/auth/password-change`, {
          method: 'POST',
          body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword,
            confirm_password: confirmPassword,
          }),
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error?.message || 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        if (result.success) {
          alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
          // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
          document.getElementById('current-password').value = '';
          document.getElementById('new-password').value = '';
          document.getElementById('confirm-password').value = '';
        }
      } catch (error) {
        console.error('Error changing password:', error);
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°
    function updateHeaderUserInfo(name, email) {
      const userNameElement = document.querySelector('.header-user-name');
      const userAvatarElement = document.querySelector('.header-user-avatar');
      
      if (userNameElement) {
        userNameElement.textContent = name;
      }
      
      if (userAvatarElement && name) {
        // åå‰ã®æœ€åˆã®æ–‡å­—ã‚’ã‚¢ãƒã‚¿ãƒ¼ã«è¡¨ç¤º
        userAvatarElement.textContent = name.charAt(0);
      }
    }
  </script>
</body>
</html>

