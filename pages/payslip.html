<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çµ¦ä¸æ˜ç´° - å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="../styles/common.css">
  <link rel="stylesheet" href="../styles/components.css">
  <link rel="stylesheet" href="../styles/layout.css">
  <style>
    /* çµ¦ä¸æ˜ç´°å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .payslip-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .payslip-list {
      display: grid;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
    }

    .payslip-item {
      background-color: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
      transition: box-shadow var(--transition-base), transform var(--transition-base);
      cursor: pointer;
    }

    .payslip-item:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .payslip-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .payslip-item-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--text-primary);
    }

    .payslip-item-period {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }

    .payslip-item-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
    }

    .payslip-item-detail {
      display: flex;
      flex-direction: column;
    }

    .payslip-item-detail-label {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
      margin-bottom: var(--spacing-xs);
    }

    .payslip-item-detail-value {
      font-size: var(--font-size-base);
      font-weight: 600;
      color: var(--text-primary);
    }

    .payslip-item-detail-value.amount {
      font-size: var(--font-size-lg);
      color: var(--color-primary);
    }

    /* çµ¦ä¸æ˜ç´°è©³ç´°ï¼ˆå°åˆ·ç”¨ï¼‰ */
    .payslip-detail {
      background-color: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-2xl);
      box-shadow: var(--shadow-md);
      max-width: 800px;
      margin: 0 auto;
    }

    .payslip-detail-header {
      text-align: center;
      margin-bottom: var(--spacing-2xl);
      padding-bottom: var(--spacing-lg);
      border-bottom: 2px solid var(--border-color);
    }

    .payslip-detail-company {
      font-size: var(--font-size-2xl);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .payslip-detail-title {
      font-size: var(--font-size-xl);
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-md);
    }

    .payslip-detail-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }

    .payslip-detail-info-item {
      display: flex;
      flex-direction: column;
    }

    .payslip-detail-info-label {
      font-size: var(--font-size-sm);
      color: var(--text-tertiary);
      margin-bottom: var(--spacing-xs);
    }

    .payslip-detail-info-value {
      font-size: var(--font-size-base);
      font-weight: 500;
      color: var(--text-primary);
    }

    .payslip-detail-section {
      margin-bottom: var(--spacing-xl);
    }

    .payslip-detail-section-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid var(--border-color);
    }

    .payslip-detail-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: var(--spacing-lg);
    }

    .payslip-detail-table th {
      text-align: left;
      padding: var(--spacing-sm) var(--spacing-md);
      font-size: var(--font-size-sm);
      font-weight: 600;
      color: var(--text-primary);
      background-color: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    .payslip-detail-table td {
      padding: var(--spacing-sm) var(--spacing-md);
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    .payslip-detail-table tbody tr:last-child td {
      border-bottom: none;
    }

    .payslip-detail-table .text-right {
      text-align: right;
    }

    .payslip-detail-table .amount {
      font-weight: 600;
      color: var(--text-primary);
    }

    .payslip-detail-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-lg);
      background-color: var(--bg-secondary);
      border-radius: var(--border-radius);
      margin-top: var(--spacing-lg);
    }

    .payslip-detail-total-label {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--text-primary);
    }

    .payslip-detail-total-amount {
      font-size: var(--font-size-2xl);
      font-weight: 700;
      color: var(--color-primary);
    }

    .payslip-detail-footer {
      margin-top: var(--spacing-xl);
      padding-top: var(--spacing-lg);
      border-top: 1px solid var(--border-color);
      text-align: center;
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }

    .payslip-actions {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-xl);
      justify-content: center;
    }

    /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    @media print {
      body {
        background-color: white;
      }

      .header,
      .sidebar,
      .page-header,
      .payslip-actions,
      .filter-bar {
        display: none !important;
      }

      .main-content {
        margin: 0;
        padding: 0;
      }

      .payslip-detail {
        box-shadow: none;
        border: none;
        padding: 0;
        max-width: 100%;
      }

      .payslip-detail-header {
        page-break-after: avoid;
      }

      .payslip-detail-section {
        page-break-inside: avoid;
      }
    }

    /* ç©ºçŠ¶æ…‹ */
    .payslip-empty {
      text-align: center;
      padding: var(--spacing-2xl);
      color: var(--text-tertiary);
    }

    .payslip-empty-icon {
      font-size: var(--font-size-4xl);
      margin-bottom: var(--spacing-md);
      opacity: 0.5;
    }

    .payslip-empty-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-sm);
    }

    .payslip-empty-description {
      font-size: var(--font-size-sm);
      margin-bottom: var(--spacing-lg);
    }
  </style>
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="../dashboard.html" class="header-logo">å‹¤æ€ ç®¡ç†</a>
        <nav class="header-nav">
          <a href="../dashboard.html" class="header-nav-link">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
          <a href="punch.html" class="header-nav-link">æ‰“åˆ»</a>
          <a href="gantt.html" class="header-nav-link">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</a>
          <a href="reports.html" class="header-nav-link">ãƒ¬ãƒãƒ¼ãƒˆ</a>
        </nav>
      </div>
      <div class="header-right">
        <a href="requests.html" class="header-nav-link">ç”³è«‹</a>
        <button onclick="logout()" class="btn btn-sm btn-secondary" style="margin-right: var(--spacing-sm);">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <a href="profile.html" class="header-user" style="text-decoration: none;">
          <div class="header-user-avatar"></div>
          <span class="header-user-name"></span>
        </a>
      </div>
    </div>
  </header>

  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li class="sidebar-menu-item">
        <a href="../dashboard.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“Š</span>
          <span class="sidebar-menu-label">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="punch.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">â°</span>
          <span class="sidebar-menu-label">æ‰“åˆ»</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="gantt.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“…</span>
          <span class="sidebar-menu-label">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="requests.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“</span>
          <span class="sidebar-menu-label">ç”³è«‹ãƒ»æ‰¿èª</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="employees.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ‘¥</span>
          <span class="sidebar-menu-label">å¾“æ¥­å“¡ç®¡ç†</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="company-settings.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">âš™ï¸</span>
          <span class="sidebar-menu-label">ä¼æ¥­è¨­å®š</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="reports.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ“ˆ</span>
          <span class="sidebar-menu-label">ãƒ¬ãƒãƒ¼ãƒˆ</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="payslip.html" class="sidebar-menu-link active">
          <span class="sidebar-menu-icon">ğŸ’°</span>
          <span class="sidebar-menu-label">çµ¦ä¸æ˜ç´°</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="audit-logs.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">ğŸ”</span>
          <span class="sidebar-menu-label">ç›£æŸ»ãƒ­ã‚°</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-content">
    <div class="page-header">
      <h1 class="page-title">çµ¦ä¸æ˜ç´°</h1>
      <p class="page-description">çµ¦ä¸æ˜ç´°ã®ç¢ºèªãƒ»å°åˆ·ãŒã§ãã¾ã™</p>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒãƒ¼ -->
    <div class="filter-bar">
      <div class="filter-group">
        <label class="filter-label">å¾“æ¥­å“¡:</label>
        <select id="employee-filter" class="form-select filter-input">
          <option value="">ã™ã¹ã¦</option>
          <option value="self" selected>è‡ªåˆ†</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">æ”¯çµ¦å¹´æœˆ:</label>
        <input type="month" id="period-filter" class="form-input filter-input">
      </div>
      <div class="filter-group">
        <button id="search-btn" class="btn btn-primary">æ¤œç´¢</button>
      </div>
    </div>

    <!-- çµ¦ä¸æ˜ç´°ä¸€è¦§ -->
    <div id="payslip-list-view" class="payslip-container">
      <div class="payslip-list" id="payslip-list">
        <div class="payslip-empty">
          <div class="payslip-empty-icon">ğŸ’°</div>
          <div class="payslip-empty-title">çµ¦ä¸æ˜ç´°ãŒã‚ã‚Šã¾ã›ã‚“</div>
          <div class="payslip-empty-description">æœŸé–“ã‚’é¸æŠã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„</div>
        </div>
      </div>
    </div>

    <!-- çµ¦ä¸æ˜ç´°è©³ç´°ï¼ˆéè¡¨ç¤ºï¼‰ -->
    <div id="payslip-detail-view" class="payslip-container" style="display: none;">
      <div class="payslip-detail">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="payslip-detail-header">
          <div class="payslip-detail-company" id="detail-company-name">æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«</div>
          <div class="payslip-detail-title">çµ¦ä¸æ˜ç´°æ›¸</div>
        </div>

        <!-- åŸºæœ¬æƒ…å ± -->
        <div class="payslip-detail-info">
          <div class="payslip-detail-info-item">
            <span class="payslip-detail-info-label">æ”¯çµ¦å¹´æœˆ</span>
            <span class="payslip-detail-info-value" id="detail-period">2025å¹´1æœˆåˆ†</span>
          </div>
          <div class="payslip-detail-info-item">
            <span class="payslip-detail-info-label">æ”¯çµ¦æ—¥</span>
            <span class="payslip-detail-info-value" id="detail-payment-date">2025å¹´2æœˆ25æ—¥</span>
          </div>
          <div class="payslip-detail-info-item">
            <span class="payslip-detail-info-label">å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰</span>
            <span class="payslip-detail-info-value" id="detail-employee-code">EMP001</span>
          </div>
          <div class="payslip-detail-info-item">
            <span class="payslip-detail-info-label">å¾“æ¥­å“¡å</span>
            <span class="payslip-detail-info-value" id="detail-employee-name">å±±ç”° å¤ªéƒ</span>
          </div>
          <div class="payslip-detail-info-item">
            <span class="payslip-detail-info-label">éƒ¨ç½²</span>
            <span class="payslip-detail-info-value" id="detail-department">å–¶æ¥­éƒ¨</span>
          </div>
          <div class="payslip-detail-info-item">
            <span class="payslip-detail-info-label">é›‡ç”¨å½¢æ…‹</span>
            <span class="payslip-detail-info-value" id="detail-employment-type">æ­£ç¤¾å“¡</span>
          </div>
        </div>

        <!-- æ”¯çµ¦é …ç›® -->
        <div class="payslip-detail-section">
          <div class="payslip-detail-section-title">æ”¯çµ¦é …ç›®</div>
          <table class="payslip-detail-table">
            <thead>
              <tr>
                <th>é …ç›®å</th>
                <th>æ•°é‡</th>
                <th>å˜ä¾¡</th>
                <th class="text-right">é‡‘é¡</th>
              </tr>
            </thead>
            <tbody id="detail-payment-items">
            </tbody>
            <tfoot>
              <tr>
                <td colspan="3" style="font-weight: 600; text-align: right;">æ”¯çµ¦åˆè¨ˆ</td>
                <td class="text-right amount" id="detail-payment-total">Â¥0</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- æ§é™¤é …ç›® -->
        <div class="payslip-detail-section">
          <div class="payslip-detail-section-title">æ§é™¤é …ç›®</div>
          <table class="payslip-detail-table">
            <thead>
              <tr>
                <th>é …ç›®å</th>
                <th>æ•°é‡</th>
                <th>å˜ä¾¡</th>
                <th class="text-right">é‡‘é¡</th>
              </tr>
            </thead>
            <tbody id="detail-deduction-items">
            </tbody>
            <tfoot>
              <tr>
                <td colspan="3" style="font-weight: 600; text-align: right;">æ§é™¤åˆè¨ˆ</td>
                <td class="text-right amount" id="detail-deduction-total">Â¥0</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- å·®å¼•æ”¯çµ¦é¡ -->
        <div class="payslip-detail-total">
          <span class="payslip-detail-total-label">å·®å¼•æ”¯çµ¦é¡</span>
          <span class="payslip-detail-total-amount" id="detail-net-payment">Â¥0</span>
        </div>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <div class="payslip-detail-footer">
          <p>ã“ã®çµ¦ä¸æ˜ç´°ã¯é›»å­ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
          <p>å°åˆ·æ—¥æ™‚: <span id="detail-print-date"></span></p>
        </div>
      </div>

      <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
      <div class="payslip-actions">
        <button id="print-btn" class="btn btn-primary">å°åˆ·</button>
        <button id="download-btn" class="btn btn-secondary">PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button id="back-btn" class="btn btn-secondary">ä¸€è¦§ã«æˆ»ã‚‹</button>
      </div>
    </div>
  </main>

  <script src="../scripts/common.js"></script>
  <script>
    // ============================================
    // çµ¦ä¸æ˜ç´° - APIé€£æº
    // ============================================

    let employees = [];
    let payslips = [];
    let currentEmployeeId = null;

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      await Promise.all([
        loadEmployees(),
        loadTenant()
      ]);
      setupEventListeners();
      updateHeaderUserInfo();
      
      // æ”¯çµ¦å¹´æœˆã®åˆæœŸå€¤ã‚’ä»Šæœˆã«è¨­å®š
      const periodInput = document.getElementById('period-filter');
      if (periodInput) {
        const today = getCurrentTime();
        periodInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
      }
      
      // åˆæœŸæ¤œç´¢
      await searchPayslips();
    });

    // ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿
    async function loadTenant() {
      try {
        const response = await apiFetch(`${API_BASE_URL}/tenants`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          const tenant = Array.isArray(data.data) ? data.data[0] : data.data;
          if (tenant) {
            const companyNameElement = document.getElementById('detail-company-name');
            if (companyNameElement) {
              companyNameElement.textContent = tenant.name || 'æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«';
            }
          }
        }
      } catch (error) {
        console.error('ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // å¾“æ¥­å“¡ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadEmployees() {
      try {
        const response = await apiFetch(`${API_BASE_URL}/employees?limit=1000`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          employees = data.data.items || [];
          
          const select = document.getElementById('employee-filter');
          if (select) {
            select.innerHTML = '<option value="">ã™ã¹ã¦</option><option value="self" selected>è‡ªåˆ†</option>';
            employees.forEach(emp => {
              const option = document.createElement('option');
              option.value = emp.id;
              option.textContent = `${emp.name}${emp.department_name ? `ï¼ˆ${emp.department_name}ï¼‰` : ''}`;
              select.appendChild(option);
            });
          }
        }
      } catch (error) {
        console.error('å¾“æ¥­å“¡ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    function setupEventListeners() {
      // æ¤œç´¢ãƒœã‚¿ãƒ³
      const searchBtn = document.getElementById('search-btn');
      if (searchBtn) {
        searchBtn.addEventListener('click', async function() {
          await searchPayslips();
        });
      }

      // çµ¦ä¸æ˜ç´°ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¯ãƒªãƒƒã‚¯ï¼ˆå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹è¦ç´ ã®ãŸã‚ã€ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã‚’ä½¿ç”¨ï¼‰
      const payslipList = document.getElementById('payslip-list');
      if (payslipList) {
        payslipList.addEventListener('click', function(e) {
          const item = e.target.closest('.payslip-item');
          if (item) {
            const payslipId = item.getAttribute('data-payslip-id');
            if (payslipId) {
              const [employeeId, period] = payslipId.split('_');
              showPayslipDetail(employeeId, period);
            }
          }
        });
      }

      // æˆ»ã‚‹ãƒœã‚¿ãƒ³
      const backBtn = document.getElementById('back-btn');
      if (backBtn) {
        backBtn.addEventListener('click', function() {
          const listView = document.getElementById('payslip-list-view');
          const detailView = document.getElementById('payslip-detail-view');
          listView.style.display = 'block';
          detailView.style.display = 'none';
        });
      }

      // å°åˆ·ãƒœã‚¿ãƒ³
      const printBtn = document.getElementById('print-btn');
      if (printBtn) {
        printBtn.addEventListener('click', function() {
          window.print();
        });
      }

      // PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
      const downloadBtn = document.getElementById('download-btn');
      if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
          alert('PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™ã€‚');
        });
      }

      // å°åˆ·æ—¥æ™‚ã®è¨­å®š
      const printDateElement = document.getElementById('detail-print-date');
      if (printDateElement) {
        const now = getCurrentTime();
        printDateElement.textContent = now.toLocaleString('ja-JP');
      }
    }

    // çµ¦ä¸æ˜ç´°ã‚’æ¤œç´¢
    async function searchPayslips() {
      const employeeFilter = document.getElementById('employee-filter').value;
      const periodFilter = document.getElementById('period-filter').value;

      if (!periodFilter) {
        alert('æ”¯çµ¦å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      try {
        let url = `${API_BASE_URL}/payslips?period=${periodFilter}`;
        
        if (employeeFilter === 'self') {
          // ã€Œè‡ªåˆ†ã€ã®å ´åˆã¯employee_idã‚’æŒ‡å®šã—ãªã„ï¼ˆAPIå´ã§user_idã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰
          // ã¾ãŸã¯ã€å¾“æ¥­å“¡ä¸€è¦§ã‹ã‚‰è‡ªåˆ†ã®å¾“æ¥­å“¡ã‚’æ¢ã™
          // ç¾æ™‚ç‚¹ã§ã¯ã€employee_idã‚’æŒ‡å®šã—ãªã„ï¼ˆAPIå´ã§user_idã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ï¼‰
        } else if (employeeFilter) {
          url += `&employee_id=${employeeFilter}`;
        }

        const response = await apiFetch(url);
        const data = await response.json();

        if (response.ok && data.success) {
          payslips = data.data || [];
          renderPayslipList();
        } else {
          console.error('çµ¦ä¸æ˜ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', data);
          alert('çµ¦ä¸æ˜ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        console.error('çµ¦ä¸æ˜ç´°ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('çµ¦ä¸æ˜ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // çµ¦ä¸æ˜ç´°ä¸€è¦§ã‚’æç”»
    function renderPayslipList() {
      const listContainer = document.getElementById('payslip-list');
      if (!listContainer) return;

      listContainer.innerHTML = '';

      if (payslips.length === 0) {
        listContainer.innerHTML = `
          <div class="payslip-empty">
            <div class="payslip-empty-icon">ğŸ’°</div>
            <div class="payslip-empty-title">çµ¦ä¸æ˜ç´°ãŒã‚ã‚Šã¾ã›ã‚“</div>
            <div class="payslip-empty-description">é¸æŠã—ãŸæœŸé–“ã«çµ¦ä¸æ˜ç´°ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“</div>
          </div>
        `;
        return;
      }

      payslips.forEach(payslip => {
        const item = document.createElement('div');
        item.className = 'payslip-item';
        item.setAttribute('data-payslip-id', `${payslip.employee_id}_${payslip.period.replace('å¹´', '-').replace('æœˆåˆ†', '').replace('åˆ†', '')}`);
        
        item.innerHTML = `
          <div class="payslip-item-header">
            <div>
              <div class="payslip-item-title">${payslip.period} çµ¦ä¸æ˜ç´°</div>
              <div class="payslip-item-period">æ”¯çµ¦æ—¥: ${payslip.payment_date}</div>
            </div>
            <span class="badge badge-success">${payslip.status || 'ç¢ºå®š'}</span>
          </div>
          <div class="payslip-item-details">
            <div class="payslip-item-detail">
              <span class="payslip-item-detail-label">åŸºæœ¬çµ¦</span>
              <span class="payslip-item-detail-value">Â¥${payslip.base_salary?.toLocaleString() || 0}</span>
            </div>
            <div class="payslip-item-detail">
              <span class="payslip-item-detail-label">æ®‹æ¥­æ‰‹å½“</span>
              <span class="payslip-item-detail-value">Â¥${payslip.overtime_pay?.toLocaleString() || 0}</span>
            </div>
            <div class="payslip-item-detail">
              <span class="payslip-item-detail-label">æ§é™¤åˆè¨ˆ</span>
              <span class="payslip-item-detail-value">Â¥-${payslip.deduction_total?.toLocaleString() || 0}</span>
            </div>
            <div class="payslip-item-detail">
              <span class="payslip-item-detail-label">å·®å¼•æ”¯çµ¦é¡</span>
              <span class="payslip-item-detail-value amount">Â¥${payslip.net_payment?.toLocaleString() || 0}</span>
            </div>
          </div>
        `;
        
        listContainer.appendChild(item);
      });
    }

    // çµ¦ä¸æ˜ç´°è©³ç´°ã‚’è¡¨ç¤º
    async function showPayslipDetail(employeeId, period) {
      try {
        const response = await apiFetch(`${API_BASE_URL}/payslips/${employeeId}/${period}`);
        const data = await response.json();

        if (response.ok && data.success) {
          const payslip = data.data;
          updatePayslipDetail(payslip);

          const listView = document.getElementById('payslip-list-view');
          const detailView = document.getElementById('payslip-detail-view');
          listView.style.display = 'none';
          detailView.style.display = 'block';
        } else {
          console.error('çµ¦ä¸æ˜ç´°è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', data);
          alert('çµ¦ä¸æ˜ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        console.error('çµ¦ä¸æ˜ç´°è©³ç´°ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('çµ¦ä¸æ˜ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // çµ¦ä¸æ˜ç´°è©³ç´°ã‚’æ›´æ–°
    function updatePayslipDetail(payslip) {
      document.getElementById('detail-period').textContent = payslip.period;
      document.getElementById('detail-payment-date').textContent = payslip.payment_date;
      document.getElementById('detail-employee-code').textContent = payslip.employee_code;
      document.getElementById('detail-employee-name').textContent = payslip.employee_name;
      document.getElementById('detail-department').textContent = payslip.department_name || '-';
      document.getElementById('detail-employment-type').textContent = payslip.employment_type;

      // æ”¯çµ¦é …ç›®ã‚’æ›´æ–°
      const paymentItemsTbody = document.getElementById('detail-payment-items');
      paymentItemsTbody.innerHTML = '';
      let paymentTotal = 0;
      
      if (payslip.payment_items && payslip.payment_items.length > 0) {
        payslip.payment_items.forEach(function(item) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>${item.unit_price}</td>
            <td class="text-right amount">Â¥${item.amount.toLocaleString()}</td>
          `;
          paymentItemsTbody.appendChild(row);
          paymentTotal += item.amount;
        });
      }
      document.getElementById('detail-payment-total').textContent = 'Â¥' + paymentTotal.toLocaleString();

      // æ§é™¤é …ç›®ã‚’æ›´æ–°
      const deductionItemsTbody = document.getElementById('detail-deduction-items');
      deductionItemsTbody.innerHTML = '';
      let deductionTotal = 0;
      
      if (payslip.deduction_items && payslip.deduction_items.length > 0) {
        payslip.deduction_items.forEach(function(item) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>${item.unit_price}</td>
            <td class="text-right amount">Â¥-${item.amount.toLocaleString()}</td>
          `;
          deductionItemsTbody.appendChild(row);
          deductionTotal += item.amount;
        });
      }
      document.getElementById('detail-deduction-total').textContent = 'Â¥-' + deductionTotal.toLocaleString();

      // å·®å¼•æ”¯çµ¦é¡ã‚’æ›´æ–°
      const netPayment = paymentTotal - deductionTotal;
      document.getElementById('detail-net-payment').textContent = 'Â¥' + netPayment.toLocaleString();
    }
  </script>
</body>
</html>

