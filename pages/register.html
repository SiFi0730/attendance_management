<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>会員登録 - 勤怠管理システム</title>
  <link rel="stylesheet" href="../styles/common.css">
  <link rel="stylesheet" href="../styles/components.css">
  <link rel="stylesheet" href="../styles/layout.css">
</head>
<body>
  <div class="auth-layout">
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <div class="auth-logo">勤怠管理</div>
          <h1 class="auth-title">会員登録</h1>
          <p class="auth-subtitle">企業情報と管理者アカウントを作成してください</p>
        </div>

        <form id="registerForm">
          <div class="form-group">
            <label for="tenant_name" class="form-label required">企業名</label>
            <input 
              type="text" 
              id="tenant_name" 
              name="tenant_name" 
              class="form-input" 
              placeholder="株式会社サンプル"
              required
            >
          </div>

          <div class="form-group">
            <label for="name" class="form-label required">管理者名</label>
            <input 
              type="text" 
              id="name" 
              name="name" 
              class="form-input" 
              placeholder="山田太郎"
              required
            >
          </div>

          <div class="form-group">
            <label for="email" class="form-label required">メールアドレス</label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              class="form-input" 
              placeholder="admin@example.com"
              required
            >
          </div>

          <div class="form-group">
            <label for="password" class="form-label required">パスワード</label>
            <input 
              type="password" 
              id="password" 
              name="password" 
              class="form-input" 
              placeholder="••••••••"
              required
              minlength="8"
            >
            <div class="form-help" style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-top: var(--spacing-xs);">
              8文字以上、大文字・小文字・数字・記号を含む必要があります
            </div>
          </div>

          <div class="form-group">
            <label for="password_confirm" class="form-label required">パスワード（確認）</label>
            <input 
              type="password" 
              id="password_confirm" 
              name="password_confirm" 
              class="form-input" 
              placeholder="••••••••"
              required
            >
          </div>

          <div class="form-group">
            <label for="timezone" class="form-label">タイムゾーン</label>
            <select id="timezone" name="timezone" class="form-input">
              <option value="Asia/Tokyo" selected>Asia/Tokyo (日本標準時)</option>
              <option value="UTC">UTC</option>
              <option value="America/New_York">America/New_York (東部標準時)</option>
              <option value="Europe/London">Europe/London (GMT)</option>
            </select>
          </div>

          <div id="errorMessage" class="alert alert-error" style="display: none; margin-bottom: var(--spacing-md);"></div>
          <div id="successMessage" class="alert alert-success" style="display: none; margin-bottom: var(--spacing-md);"></div>

          <button type="submit" class="btn btn-primary w-full" style="margin-top: var(--spacing-lg);" id="submitBtn">
            会員登録
          </button>
        </form>

        <div class="auth-footer">
          <p>既にアカウントをお持ちの方は <a href="../index.html">ログイン</a></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:8080/api.php';

    document.getElementById('registerForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');

      // エラーメッセージを非表示
      errorMessage.style.display = 'none';
      successMessage.style.display = 'none';

      // パスワード確認
      const password = document.getElementById('password').value;
      const passwordConfirm = document.getElementById('password_confirm').value;

      if (password !== passwordConfirm) {
        errorMessage.textContent = 'パスワードが一致しません';
        errorMessage.style.display = 'block';
        return;
      }

      // フォームデータを取得
      const formData = {
        tenant_name: document.getElementById('tenant_name').value,
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        password: password,
        timezone: document.getElementById('timezone').value,
        locale: 'ja'
      };

      submitBtn.disabled = true;
      submitBtn.textContent = '登録中...';

      try {
        const response = await fetch(`${API_BASE_URL}/auth/register`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData),
          credentials: 'include'
        });

        let data;
        try {
          data = await response.json();
        } catch (jsonError) {
          // JSON解析エラーの場合、レスポンステキストを表示
          const text = await response.text();
          errorMessage.textContent = 'サーバーエラー: ' + text.substring(0, 200);
          errorMessage.style.display = 'block';
          submitBtn.disabled = false;
          submitBtn.textContent = '会員登録';
          console.error('JSON parse error:', jsonError, 'Response:', text);
          return;
        }

        if (response.ok) {
          successMessage.textContent = data.message || '会員登録が完了しました';
          successMessage.style.display = 'block';
          
          // 3秒後にダッシュボードにリダイレクト
          setTimeout(() => {
            window.location.href = '../dashboard.html';
          }, 3000);
        } else {
          const errorMsg = data.error?.message || data.message || '会員登録に失敗しました';
          const errorDetails = data.error?.details ? '\n詳細: ' + JSON.stringify(data.error.details) : '';
          errorMessage.textContent = errorMsg + errorDetails;
          errorMessage.style.display = 'block';
          console.error('API Error:', data);
          submitBtn.disabled = false;
          submitBtn.textContent = '会員登録';
        }
      } catch (error) {
        errorMessage.textContent = 'ネットワークエラーが発生しました: ' + error.message;
        errorMessage.style.display = 'block';
        console.error('Network error:', error);
        submitBtn.disabled = false;
        submitBtn.textContent = '会員登録';
      }
    });
  </script>
</body>
</html>

